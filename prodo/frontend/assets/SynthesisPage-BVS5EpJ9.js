import{i as p,bN as He,r as d,v as Xe,a as we,j as e,B as c,bO as R,o as l,C as U,K as m,a1 as de,A as ue,P as g,bP as Ve,bQ as Ke,aT as Je,aU as Ze,bR as qe,e as G,G as he,b3 as Qe,D as es,p as me,T as ss,F as xe,m as pe,S as ye,M as y,aJ as $,bI as fe,s as ns,n as Y,f as ts,bb as os,ah as H,aj as X,al as V,am as K,R as I,I as D}from"./index-CS2nn_Zr.js";import{u as is}from"./useSharedData-DgpbyG0s.js";import{u as rs,F as ge,O as je}from"./useCrossPageActions-D9ut6hon.js";import{C as as}from"./ConnectionSelector-gPkx78kE.js";import{S as ls}from"./SendToMenu-B3EWP-Gj.js";import{C as ve}from"./ConfirmModal-DbnlUgfc.js";import{A as cs}from"./AiUsageNotice-Bg2BoC2w.js";import{D as Se}from"./DisabledTooltip-8cx7sKBB.js";import{G as x}from"./Grid-B_V8L2Yi.js";import{C as ds}from"./CardContent-D2oMcta9.js";import{C as us}from"./CardActions-KiOHFJwK.js";import{P as hs}from"./Preview-BwI7t5k5.js";import{A as ms,a as xs,b as ps}from"./AccordionSummary-Bf62xkde.js";import{U as ys}from"./Upload-Czs9FYW3.js";import"./SummarizeRounded-BzUuQV7q.js";import"./CheckCircleOutline-BB2cn-sY.js";import"./WarningAmber-xU07KL0O.js";function fs(n,t=[]){if(Array.isArray(n))return n;if(!n||typeof n!="object")return[];for(const o of t)if(Array.isArray(n[o]))return n[o];return[]}async function gs(n){return(await p.post("/synthesis/sessions",{name:n})).data}async function js(){const t=(await p.get("/synthesis/sessions")).data;if(Array.isArray(t))return{sessions:t,total:t.length};if(t&&typeof t=="object"){const o=fs(t,["sessions","items","results"]);return{...t,sessions:o,total:t.total??o.length}}return{sessions:[],total:0}}async function vs(n){return(await p.get(`/synthesis/sessions/${n}`)).data}async function Ss(n){return(await p.delete(`/synthesis/sessions/${n}`)).data}async function bs(n,{name:t,content:o,docType:i="text",metadata:r}){return(await p.post(`/synthesis/sessions/${n}/documents`,{name:t,content:o,doc_type:i,metadata:r})).data}async function ws(n,{docType:t}={}){const o=new FormData;return o.append("file",n),t&&o.append("doc_type",t),(await p.post("/synthesis/documents/extract",o)).data}async function Cs(n,t){return(await p.delete(`/synthesis/sessions/${n}/documents/${t}`)).data}async function Is(n){return(await p.get(`/synthesis/sessions/${n}/inconsistencies`)).data}async function Ds(n,{focusTopics:t,outputFormat:o="structured",includeSources:i=!0,maxLength:r=5e3}){return(await p.post(`/synthesis/sessions/${n}/synthesize`,{focus_topics:t,output_format:o,include_sources:i,max_length:r})).data}const As=He((n,t)=>({sessions:[],currentSession:null,inconsistencies:[],synthesisResult:null,loading:!1,error:null,setLoading:o=>n({loading:o}),setError:o=>n({error:o}),fetchSessions:async()=>{n({loading:!0,error:null});try{const o=await js();n({sessions:o.sessions||[],loading:!1})}catch(o){n({error:o.message,loading:!1})}},createSession:async o=>{n({loading:!0,error:null});try{const r=(await gs(o)).session;return n(j=>({sessions:[...j.sessions,r].slice(0,100),currentSession:r,loading:!1})),r}catch(i){return n({error:i.message,loading:!1}),null}},getSession:async o=>{n({loading:!0,error:null});try{const i=await vs(o);return n({currentSession:i.session,loading:!1}),i.session}catch(i){return n({error:i.message,loading:!1}),null}},deleteSession:async o=>{n({loading:!0,error:null});try{return await Ss(o),n(i=>({sessions:i.sessions.filter(r=>r.id!==o),currentSession:i.currentSession?.id===o?null:i.currentSession,loading:!1})),!0}catch(i){return n({error:i.message,loading:!1}),!1}},addDocument:async(o,i)=>{n({loading:!0,error:null});try{const r=await bs(o,i);return await t().getSession(o),n({loading:!1}),r.document}catch(r){return n({error:r.message,loading:!1}),null}},removeDocument:async(o,i)=>{n({loading:!0,error:null});try{return await Cs(o,i),await t().getSession(o),n({loading:!1}),!0}catch(r){return n({error:r.message,loading:!1}),!1}},findInconsistencies:async o=>{n({loading:!0,error:null});try{const i=await Is(o);return n({inconsistencies:i.inconsistencies||[],loading:!1}),i.inconsistencies}catch(i){return n({error:i.message,loading:!1}),[]}},synthesize:async(o,i={})=>{n({loading:!0,error:null,synthesisResult:null});try{const r=await Ds(o,i);return n({synthesisResult:r.result,loading:!1}),r.result}catch(r){return n({error:r.message,loading:!1}),null}},reset:()=>n({currentSession:null,inconsistencies:[],synthesisResult:null,error:null})})),J=5*1024*1024,z=10,f=200,be=10;function Es(){const{sessions:n,currentSession:t,inconsistencies:o,synthesisResult:i,loading:r,error:j,fetchSessions:Z,createSession:Ce,getSession:Ie,deleteSession:De,addDocument:Ae,removeDocument:Ee,findInconsistencies:Ne,synthesize:Te,reset:M}=As(),{activeConnectionId:_e}=is(),{registerOutput:Fe}=rs(ge.SYNTHESIS),[q,Le]=d.useState(_e),[Re,E]=d.useState(!1),[$e,N]=d.useState(!1),[v,Q]=d.useState(""),[S,P]=d.useState(""),[b,k]=d.useState(""),[ee,se]=d.useState("text"),[ne,ze]=d.useState("structured"),[O,Me]=d.useState(""),[T,te]=d.useState(null),[Pe,oe]=d.useState(!1),[_,B]=d.useState({open:!1,sessionId:null,sessionName:""}),[F,W]=d.useState({open:!1,docId:null,docName:""}),u=Xe(),ie=t?.documents?.length||0,{execute:w}=we(),[ke,re]=d.useState(!0);d.useEffect(()=>((async()=>(re(!0),await Z(),re(!1)))(),()=>M()),[Z,M]);const Oe=()=>{if(v){if(v.length>f){u.show(`Session name must be ${f} characters or less`,"error");return}w({type:D.CREATE,label:`Create session "${v}"`,reversibility:I.FULLY_REVERSIBLE,successMessage:"Session created successfully",action:async()=>{await Ce(v),E(!1),Q("")}})}},Be=()=>{if(!(!t||!S||!b)){if(S.length>f){u.show(`Document name must be ${f} characters or less`,"error");return}if(b.trim().length<z){u.show(`Document content must be at least ${z} characters`,"error");return}if(b.length>J){u.show("Document content exceeds 5MB limit","error");return}w({type:D.UPLOAD,label:`Add document "${S}"`,reversibility:I.FULLY_REVERSIBLE,successMessage:"Document added successfully",action:async()=>{await Ae(t.id,{name:S,content:b,docType:ee}),N(!1),P(""),k("")}})}},We=async s=>{const a=s.target,h=a.files?.[0];if(!h)return;if(h.name.length>f){u.show(`File name must be ${f} characters or less`,"error"),a.value="";return}if(h.size>J){u.show("File size exceeds 5MB limit","error"),a.value="";return}const C=h.name.split(".").pop().toLowerCase(),A=C==="pdf"?"pdf":["xlsx","xls","csv"].includes(C)?"excel":["doc","docx"].includes(C)?"word":C==="json"?"json":"text";try{const L=(await ws(h,{docType:A}))?.document,ce=L?.content||"";if(ce.trim().length<z){u.show(`Extracted content must be at least ${z} characters`,"error"),a.value="";return}P(L?.name||h.name),k(ce),se(L?.doc_type||A),L?.truncated?u.show("File content was truncated to fit 5MB limit","warning"):u.show("File processed successfully","success")}catch(le){u.show(le.message||"Failed to process file","error")}finally{a.value=""}},Ue=()=>{if(!t)return;const s=O?O.split(",").map(a=>a.trim()).filter(Boolean):void 0;if(s&&s.length>be){u.show(`Focus topics must be ${be} items or less`,"error");return}w({type:D.GENERATE,label:"Synthesize documents",reversibility:I.SYSTEM_MANAGED,blocksNavigation:!0,successMessage:"Synthesis complete",errorMessage:"Synthesis failed",action:async()=>{const a=await Te(t.id,{focusTopics:s,outputFormat:ne,connectionId:q||void 0});if(!a)throw new Error("Synthesis failed");const h=a.synthesis?.title||t.name||"Synthesis",C=[a.synthesis?.executive_summary||"",...a.synthesis?.key_insights||[],...(a.synthesis?.sections||[]).map(A=>`${A.heading}
${A.content}`)].join(`

`);Fe({type:je.TEXT,title:h,summary:(a.synthesis?.executive_summary||"").substring(0,200),data:C,format:"text"})}})},Ge=()=>{t&&w({type:D.ANALYZE,label:"Find inconsistencies",reversibility:I.SYSTEM_MANAGED,blocksNavigation:!0,action:async()=>{const s=await Ne(t.id);if(s===null)throw new Error("Analysis failed");s.length>0?u.show(`Found ${s.length} inconsistencies`,"warning"):u.show("No inconsistencies found","success")}})},Ye=s=>{te(s),oe(!0)},ae=()=>{oe(!1),te(null)};return ke?e.jsxs(c,{sx:{p:3,maxWidth:1400,mx:"auto"},children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[e.jsx(R,{}),e.jsx(l,{variant:"h5",children:"Multi-Document Synthesis"})]}),e.jsx(c,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:300},children:e.jsx(U,{})})]}):e.jsxs(c,{sx:{p:3,maxWidth:1400,mx:"auto"},children:[e.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(c,{children:[e.jsxs(l,{variant:"h5",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(R,{})," Multi-Document Synthesis"]}),e.jsx(l,{variant:"body1",color:"text.secondary",children:"Combine information from multiple documents with AI-powered analysis"})]}),e.jsx(m,{variant:"contained",startIcon:e.jsx(de,{}),onClick:()=>E(!0),children:"New Session"})]}),j&&e.jsx(ue,{severity:"error",sx:{mb:2},onClose:()=>M(),children:j}),t&&e.jsx(cs,{title:"AI synthesis",description:"Outputs are generated from the documents in this session. Review before sharing.",chips:[{label:`Source: ${ie} document${ie===1?"":"s"}`,color:"info",variant:"outlined"},{label:"Confidence: Review required",color:"warning",variant:"outlined"},{label:"Reversible: No source changes",color:"success",variant:"outlined"}],dense:!0,sx:{mb:2}}),e.jsxs(x,{container:!0,spacing:3,children:[e.jsx(x,{size:{xs:12,md:3},children:e.jsxs(g,{sx:{p:2},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Sessions"}),n.length===0?e.jsx(l,{color:"text.secondary",sx:{py:2,textAlign:"center"},children:"No sessions yet"}):e.jsx(Ve,{dense:!0,children:n.map(s=>e.jsxs(Ke,{button:!0,selected:t?.id===s.id,onClick:()=>Ie(s.id),children:[e.jsx(Je,{children:e.jsx(R,{})}),e.jsx(Ze,{primary:s.name,secondary:`${s.documents?.length||0} docs`}),e.jsx(qe,{children:e.jsx(G,{size:"small",onClick:a=>{a.stopPropagation(),B({open:!0,sessionId:s.id,sessionName:s.name})},children:e.jsx(he,{fontSize:"small"})})})]},s.id))})]})}),e.jsx(x,{size:{xs:12,md:9},children:t?e.jsxs(c,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(g,{sx:{p:3},children:[e.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(l,{variant:"h6",children:["Documents (",t.documents?.length||0,")"]}),e.jsx(m,{variant:"outlined",startIcon:e.jsx(de,{}),onClick:()=>N(!0),children:"Add Document"})]}),t.documents?.length===0?e.jsx(l,{color:"text.secondary",sx:{textAlign:"center",py:3},children:"Add documents to begin synthesis"}):e.jsx(x,{container:!0,spacing:2,children:t.documents?.map(s=>e.jsx(x,{size:{xs:12,sm:6,md:4},children:e.jsxs(Qe,{variant:"outlined",children:[e.jsxs(ds,{children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(es,{sx:{color:"text.secondary"}}),e.jsx(l,{variant:"subtitle2",noWrap:!0,children:s.name})]}),e.jsx(me,{size:"small",label:s.doc_type})]}),e.jsxs(us,{children:[e.jsx(ss,{title:"Preview",children:e.jsx(G,{size:"small",onClick:()=>Ye(s),children:e.jsx(hs,{fontSize:"small"})})}),e.jsx(G,{size:"small",onClick:()=>W({open:!0,docId:s.id,docName:s.name}),children:e.jsx(he,{fontSize:"small"})})]})]})},s.id))})]}),t.documents?.length>=2&&e.jsxs(g,{sx:{p:3},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Analysis"}),e.jsxs(x,{container:!0,spacing:2,sx:{mb:2},children:[e.jsx(x,{size:{xs:12},children:e.jsx(as,{value:q,onChange:Le,label:"Enrich with Database (optional)",showStatus:!0})}),e.jsx(x,{size:{xs:12,sm:6},children:e.jsxs(xe,{fullWidth:!0,size:"small",children:[e.jsx(pe,{children:"Output Format"}),e.jsxs(ye,{value:ne,label:"Output Format",onChange:s=>ze(s.target.value),children:[e.jsx(y,{value:"structured",children:"Structured"}),e.jsx(y,{value:"narrative",children:"Narrative"}),e.jsx(y,{value:"comparison",children:"Comparison"})]})]})}),e.jsx(x,{size:{xs:12,sm:6},children:e.jsx($,{fullWidth:!0,size:"small",label:"Focus Topics (comma-separated)",value:O,onChange:s=>Me(s.target.value),placeholder:"revenue, growth, risks"})})]}),e.jsxs(c,{sx:{display:"flex",gap:2},children:[e.jsx(Se,{disabled:r||!t?.documents?.length,reason:r?"Please wait for the current operation to complete":t?.documents?.length?void 0:"Add at least one document first",children:e.jsx(m,{variant:"outlined",startIcon:r?e.jsx(U,{size:20}):e.jsx(fe,{}),onClick:Ge,disabled:r||!t?.documents?.length,children:"Find Inconsistencies"})}),e.jsx(Se,{disabled:r||!t?.documents?.length,reason:r?"Please wait for the current operation to complete":t?.documents?.length?void 0:"Add at least two documents to synthesize",children:e.jsx(m,{variant:"contained",startIcon:r?e.jsx(U,{size:20}):e.jsx(ns,{}),onClick:Ue,disabled:r||!t?.documents?.length,children:"Synthesize"})})]})]}),o.length>0&&e.jsxs(g,{sx:{p:3},children:[e.jsxs(l,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(fe,{sx:{color:"text.secondary"}})," Inconsistencies Found (",o.length,")"]}),o.map((s,a)=>e.jsxs(ms,{variant:"outlined",children:[e.jsx(xs,{expandIcon:e.jsx(os,{}),children:e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(me,{size:"small",label:s.severity,sx:{bgcolor:h=>h.palette.mode==="dark"?ts(h.palette.text.primary,.1):Y[200],color:"text.secondary"}}),e.jsx(l,{children:s.field_or_topic})]})}),e.jsxs(ps,{children:[e.jsx(l,{variant:"body2",sx:{mb:1},children:s.description}),s.suggested_resolution&&e.jsxs(ue,{severity:"info",sx:{mt:1},children:[e.jsx("strong",{children:"Suggestion:"})," ",s.suggested_resolution]})]})]},a))]}),i&&e.jsxs(g,{sx:{p:3},children:[e.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[e.jsx(l,{variant:"h6",children:"Synthesis Result"}),e.jsx(ls,{outputType:je.TEXT,payload:{title:i.synthesis?.title||t?.name||"Synthesis",content:[i.synthesis?.executive_summary||"",...i.synthesis?.key_insights||[],...(i.synthesis?.sections||[]).map(s=>`${s.heading}
${s.content}`)].join(`

`)},sourceFeature:ge.SYNTHESIS})]}),e.jsxs(c,{sx:{bgcolor:Y[50],p:2,borderRadius:1},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:i.synthesis?.title}),e.jsx(l,{variant:"body1",sx:{mb:2},children:i.synthesis?.executive_summary}),i.synthesis?.key_insights&&e.jsxs(c,{sx:{mb:2},children:[e.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Key Insights"}),e.jsx("ul",{style:{margin:0,paddingLeft:20},children:i.synthesis.key_insights.map((s,a)=>e.jsx("li",{children:e.jsx(l,{variant:"body2",children:s})},a))})]}),i.synthesis?.sections&&e.jsx(c,{children:i.synthesis.sections.map((s,a)=>e.jsxs(c,{sx:{mb:2},children:[e.jsx(l,{variant:"subtitle1",children:s.heading}),e.jsx(l,{variant:"body2",children:s.content})]},a))})]})]})]}):e.jsxs(g,{sx:{p:4,textAlign:"center"},children:[e.jsx(R,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(l,{color:"text.secondary",children:"Select a session or create a new one to begin"})]})})]}),e.jsxs(H,{open:Re,onClose:()=>E(!1),children:[e.jsx(X,{children:"Create Synthesis Session"}),e.jsx(V,{children:e.jsx($,{fullWidth:!0,label:"Session Name",value:v,onChange:s=>Q(s.target.value),sx:{mt:2},inputProps:{maxLength:f}})}),e.jsxs(K,{children:[e.jsx(m,{onClick:()=>E(!1),children:"Cancel"}),e.jsx(m,{variant:"contained",onClick:Oe,disabled:!v,children:"Create"})]})]}),e.jsxs(H,{open:$e,onClose:()=>N(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(X,{children:"Add Document"}),e.jsxs(V,{children:[e.jsxs(c,{sx:{display:"flex",gap:2,mb:2,mt:2},children:[e.jsx($,{fullWidth:!0,label:"Document Name",value:S,onChange:s=>P(s.target.value),inputProps:{maxLength:f}}),e.jsxs(xe,{sx:{minWidth:150},children:[e.jsx(pe,{children:"Type"}),e.jsxs(ye,{value:ee,label:"Type",onChange:s=>se(s.target.value),children:[e.jsx(y,{value:"text",children:"Text"}),e.jsx(y,{value:"pdf",children:"PDF"}),e.jsx(y,{value:"excel",children:"Excel"}),e.jsx(y,{value:"word",children:"Word"}),e.jsx(y,{value:"json",children:"JSON"})]})]})]}),e.jsxs(m,{variant:"outlined",component:"label",startIcon:e.jsx(ys,{}),sx:{mb:2},children:["Upload File",e.jsx("input",{type:"file",hidden:!0,onChange:We})]}),e.jsx($,{fullWidth:!0,multiline:!0,rows:10,label:"Document Content",value:b,onChange:s=>k(s.target.value),placeholder:"Paste document content or upload a file...",inputProps:{maxLength:J}})]}),e.jsxs(K,{children:[e.jsx(m,{onClick:()=>N(!1),children:"Cancel"}),e.jsx(m,{variant:"contained",onClick:Be,disabled:!S||!b,children:"Add"})]})]}),e.jsxs(H,{open:Pe,onClose:ae,maxWidth:"md",fullWidth:!0,children:[e.jsx(X,{children:"Document Preview"}),e.jsxs(V,{dividers:!0,children:[e.jsx(l,{variant:"subtitle2",sx:{mb:1},children:T?.name||"Document"}),e.jsx(l,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:2},children:T?.doc_type||T?.docType||"text"}),e.jsx(g,{sx:{p:2,bgcolor:Y[50],maxHeight:420,overflow:"auto"},children:e.jsx(l,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:T?.content||"No content available."})})]}),e.jsx(K,{children:e.jsx(m,{onClick:ae,children:"Close"})})]}),e.jsx(ve,{open:_.open,onClose:()=>B({open:!1,sessionId:null,sessionName:""}),onConfirm:()=>{const s=_.sessionId,a=_.sessionName;B({open:!1,sessionId:null,sessionName:""}),w({type:D.DELETE,label:`Delete session "${a}"`,reversibility:I.IRREVERSIBLE,successMessage:`Session "${a}" deleted`,errorMessage:"Failed to delete session",action:async()=>{if(!await De(s))throw new Error("Delete failed")}})},title:"Delete Session",message:`Are you sure you want to delete "${_.sessionName}"? All documents and analysis data will be permanently removed.`,confirmLabel:"Delete",severity:"error"}),e.jsx(ve,{open:F.open,onClose:()=>W({open:!1,docId:null,docName:""}),onConfirm:()=>{const s=F.docId,a=F.docName;W({open:!1,docId:null,docName:""}),w({type:D.DELETE,label:`Remove document "${a}"`,reversibility:I.PARTIALLY_REVERSIBLE,successMessage:`Document "${a}" removed`,errorMessage:"Failed to remove document",action:async()=>{if(!await Ee(t?.id,s))throw new Error("Remove failed")}})},title:"Remove Document",message:`Are you sure you want to remove "${F.docName}" from this session?`,confirmLabel:"Remove",severity:"warning"})]})}function Hs(){return we(),e.jsx(Es,{})}export{Hs as default};
