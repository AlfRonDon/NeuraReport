import{c as Ne,j as e,u as be,r as s,d as Ge,R as N,I as G,aK as xt,aL as mt,aM as Q,B as C,S as c,z as Ae,k as i,F as he,T as p,n as ht,o as gt,aN as bt,Q as ft,C as yt,N as He,s as E,as as Ee,x as ge,O as Ve,P as K,E as jt,p as o,v as D,e as kt,a4 as vt,b as Ct,f as de,aO as St,aP as wt,aQ as It,D as Rt,ai as Pe,aj as Fe,a3 as pe,aR as Tt,aS as Dt,$ as zt,aI as At,q as Et,ay as Le,ah as Me,aT as Pt,aU as Ft,J as u,an as Lt,aJ as Mt,aV as Wt,K as ae}from"./index-B8Eu23bA.js";import{A as $t}from"./ArrowForward-DPnjhzEH.js";import{F as Ot}from"./FilterList-lKi4AKs9.js";import{P as Ye}from"./PictureAsPdf-Cva09OSx.js";import{C as qt}from"./Check-BATZaRrq.js";import{u as Bt,S as _t}from"./SuccessCelebration-CtmPUY5S.js";import{A as Nt}from"./AiUsageNotice-DRuwRFKl.js";import{R as Gt}from"./ReportGlossaryNotice-BhvvMaX1.js";import{g as Ht,q as Vt}from"./summary-CGI6QTv7.js";import{C as Yt}from"./Container-nBfdHHf8.js";import{G as ue}from"./Grid-5L9Rvqba.js";import"./Article-B2tsd32U.js";const Qt=Ne(e.jsx("path",{d:"M9 11H7v2h2zm4 0h-2v2h2zm4 0h-2v2h2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 16H5V9h14z"})),Kt=Ne(e.jsx("path",{d:"M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 16H5V8h14zM7 10h5v5H7z"})),Ut={pdf:Ye,excel:jt};function Jt({onSelectTemplate:t}){const{execute:h}=be(),[w,d]=s.useState(!1),[j,$]=s.useState(""),[g,b]=s.useState(!1),[P,l]=s.useState(!1),[R,v]=s.useState([]),[O,f]=s.useState(null),z=Ge(),S=s.useCallback((n,m,y={})=>h({type:G.EXECUTE,label:n,reversibility:N.FULLY_REVERSIBLE,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{source:"template_recommender",...y},action:m}),[h]),F=s.useCallback(()=>{const n=j.trim();if(n)return h({type:G.ANALYZE,label:"Recommend templates",reversibility:N.FULLY_REVERSIBLE,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{source:"template_recommender",action:"recommend_templates",requirement:n},action:async()=>{b(!0),f(null),v([]);try{const m=await xt({requirement:n,limit:5}),y=Array.isArray(m)?m:[];return v(y),y.length||f("No matching templates found. Try a different description."),y}catch(m){throw f(m.message||"Failed to get recommendations"),m}finally{b(!1)}}})},[h,j]),T=s.useCallback(()=>{const n=j.trim();if(n)return h({type:G.GENERATE,label:"Queue template recommendations",reversibility:N.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{source:"template_recommender",action:"queue_recommendations",requirement:n},action:async()=>{l(!0),f(null);try{const m=await mt({requirement:n,limit:5});return m?.job_id?z.show("Recommendation job queued. Track it in Jobs.","success"):z.show("Failed to queue recommendation job.","error"),m}catch(m){throw z.show(m.message||"Failed to queue recommendations","error"),m}finally{l(!1)}}})},[h,j,z]),q=s.useCallback(n=>S("Select recommended template",()=>{t?.(n),d(!1)},{templateId:n?.id}),[S,t]),fe=s.useCallback(n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),F())},[F]);return e.jsxs(Q,{sx:{border:1,borderColor:"divider",borderStyle:w?"solid":"dashed",transition:"all 0.2s ease",overflow:"hidden"},children:[e.jsxs(C,{sx:{px:2,py:1.5,display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer",bgcolor:w?"action.selected":"transparent","&:hover":{bgcolor:"action.hover"}},onClick:()=>S("Toggle template recommender",()=>d(n=>!n)),children:[e.jsxs(c,{direction:"row",alignItems:"center",spacing:1.5,children:[e.jsx(Ae,{sx:{width:32,height:32,bgcolor:n=>n.palette.mode==="dark"?"rgba(255,255,255,0.08)":i[300]},children:e.jsx(he,{sx:{color:"text.secondary",fontSize:18}})}),e.jsxs(C,{children:[e.jsx(p,{variant:"subtitle2",fontWeight:600,children:"AI Template Picker"}),e.jsx(p,{variant:"caption",color:"text.secondary",children:"Describe what you need and let AI find the best template"})]})]}),e.jsx(ht,{title:w?"Collapse":"Expand",children:e.jsx(gt,{size:"small","aria-label":w?"Collapse":"Expand",children:w?e.jsx(bt,{}):e.jsx(ft,{})})})]}),e.jsx(yt,{in:w,children:e.jsx(C,{sx:{px:2,pb:2},children:e.jsxs(c,{spacing:2,children:[e.jsxs(c,{direction:"row",spacing:1,children:[e.jsx(He,{fullWidth:!0,size:"small",placeholder:"e.g., monthly sales report with charts, inventory tracking spreadsheet...",value:j,onChange:n=>$(n.target.value),onKeyDown:fe,disabled:g,sx:{"& .MuiOutlinedInput-root":{bgcolor:"background.paper"}}}),e.jsx(E,{variant:"contained",onClick:F,disabled:g||P||!j.trim(),startIcon:g?e.jsx(Ee,{size:16,color:"inherit"}):e.jsx(he,{}),sx:{minWidth:120,textTransform:"none"},children:g?"Searching...":"Find"}),e.jsx(E,{variant:"outlined",onClick:T,disabled:g||P||!j.trim(),startIcon:P?e.jsx(Ee,{size:16,color:"inherit"}):e.jsx(ge,{}),sx:{minWidth:120,textTransform:"none"},children:P?"Queueing...":"Queue"})]}),g&&e.jsx(Ve,{}),O&&e.jsx(K,{severity:"info",onClose:()=>S("Dismiss recommendations error",()=>f(null)),children:O}),R.length>0&&e.jsxs(c,{spacing:1.5,children:[e.jsxs(p,{variant:"caption",color:"text.secondary",children:[R.length," template",R.length!==1?"s":""," found"]}),R.map((n,m)=>{const y=n.template||n,H=y.kind||"pdf",B=Ut[H]||Ye,V=typeof n.score=="number"?n.score:null;return e.jsx(Q,{variant:"outlined",sx:{p:2,cursor:"pointer",transition:"all 0.15s ease","&:hover":{borderColor:k=>k.palette.mode==="dark"?i[1e3]:i[1100],bgcolor:"action.hover"}},onClick:()=>q(y),children:e.jsxs(c,{direction:"row",alignItems:"flex-start",spacing:2,children:[e.jsx(Ae,{variant:"rounded",sx:{width:40,height:40,bgcolor:k=>k.palette.mode==="dark"?o(k.palette.text.primary,.08):i[300]},children:e.jsx(B,{sx:{color:"text.secondary"}})}),e.jsxs(C,{sx:{flex:1,minWidth:0},children:[e.jsxs(c,{direction:"row",alignItems:"center",spacing:1,sx:{mb:.5},children:[e.jsx(p,{variant:"subtitle2",fontWeight:600,children:y.name||y.id}),e.jsx(D,{label:H.toUpperCase(),size:"small",variant:"outlined",sx:{height:20,fontSize:"0.65rem",bgcolor:k=>k.palette.mode==="dark"?o(k.palette.text.primary,.1):i[400],color:"text.secondary"}}),V!==null&&e.jsx(D,{label:`${Math.round(V*100)}% match`,size:"small",sx:{height:20,fontSize:"0.65rem",bgcolor:k=>k.palette.mode==="dark"?o(k.palette.text.primary,.1):i[400],color:"text.secondary"}})]}),n.explanation&&e.jsx(p,{variant:"body2",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:n.explanation}),!n.explanation&&y.description&&e.jsx(p,{variant:"body2",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:y.description})]}),e.jsx(E,{size:"small",variant:"outlined",startIcon:e.jsx(qt,{}),onClick:k=>{k.stopPropagation(),q(y)},sx:{textTransform:"none",whiteSpace:"nowrap"},children:"Select"})]})},y.id||m)})]}),!g&&R.length===0&&e.jsxs(C,{children:[e.jsx(p,{variant:"caption",color:"text.secondary",sx:{mb:1,display:"block"},children:"Try these examples:"}),e.jsx(c,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,children:["monthly financial report","inventory tracking","sales summary with charts","equipment status report"].map(n=>e.jsx(D,{label:n,size:"small",variant:"outlined",onClick:()=>S("Set example requirement",()=>$(n),{example:n}),sx:{cursor:"pointer"}},n))})]})]})})})]})}const Qe=ae`
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
`;ae`
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
`;ae`
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
`;ae`
  0%, 100% { box-shadow: 0 0 5px currentColor; }
  50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
`;const Xt=u(C)(({theme:t})=>({minHeight:"100vh",padding:t.spacing(3),backgroundColor:t.palette.background.default})),Zt=u(C)(({theme:t})=>({marginBottom:t.spacing(4),animation:`${Qe} 0.5s ease-out`})),er=u(p)(({theme:t})=>({fontSize:"1.75rem",fontWeight:700,letterSpacing:"-0.02em",color:t.palette.mode==="dark"?i[300]:i[1200]})),Ke=u(Q)(({theme:t})=>({padding:t.spacing(3),borderRadius:8,backgroundColor:o(t.palette.background.paper,.8),backdropFilter:"blur(20px)",border:`1px solid ${o(t.palette.divider,.1)}`,boxShadow:`0 8px 32px ${o(t.palette.common.black,.08)}`,animation:`${Qe} 0.6s ease-out`,position:"relative",overflow:"hidden"})),xe=u(p)(({theme:t})=>({fontSize:"0.6875rem",fontWeight:700,textTransform:"uppercase",letterSpacing:"0.1em",color:t.palette.text.secondary,marginBottom:t.spacing(1.5),display:"flex",alignItems:"center",gap:t.spacing(1),"&::after":{content:'""',flex:1,height:1,backgroundColor:o(t.palette.divider,.3)}})),We=u(p)(({theme:t})=>({fontSize:"1rem",fontWeight:600,color:t.palette.text.primary,marginBottom:t.spacing(2)})),$e=u(Lt)(({theme:t})=>({"& .MuiOutlinedInput-root":{borderRadius:12,backgroundColor:o(t.palette.background.paper,.6),transition:"all 0.2s ease","&:hover":{backgroundColor:o(t.palette.background.paper,.8)},"&.Mui-focused":{backgroundColor:t.palette.background.paper,boxShadow:`0 0 0 3px ${o(t.palette.text.primary,.08)}`}},"& .MuiInputLabel-root":{fontWeight:500}})),Oe=u(He)(({theme:t})=>({"& .MuiOutlinedInput-root":{borderRadius:12,backgroundColor:o(t.palette.background.paper,.6),transition:"all 0.2s ease","&:hover":{backgroundColor:o(t.palette.background.paper,.8)},"&.Mui-focused":{backgroundColor:t.palette.background.paper,boxShadow:`0 0 0 3px ${o(t.palette.text.primary,.08)}`}}})),qe=u(D,{shouldForwardProp:t=>t!=="selected"})(({theme:t,selected:h})=>({borderRadius:10,fontWeight:500,fontSize:"0.75rem",transition:"all 0.2s ease",cursor:"pointer",...h&&{background:t.palette.mode==="dark"?i[1100]:i[1200],color:"#fff",boxShadow:`0 4px 12px ${o(t.palette.common.black,.15)}`,"& .MuiChip-icon":{color:"#fff"}},...!h&&{backgroundColor:o(t.palette.action.hover,.5),"&:hover":{backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.1):i[300],transform:"translateY(-1px)"}}})),Be=u(D)(({theme:t})=>({borderRadius:8,fontWeight:600,fontSize:"0.75rem",backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.08):i[300],color:t.palette.text.secondary,border:`1px solid ${o(t.palette.divider,.2)}`})),tr=u(C)(({theme:t})=>({maxHeight:200,overflow:"auto",borderRadius:12,border:`1px solid ${o(t.palette.divider,.1)}`,backgroundColor:o(t.palette.background.paper,.4),"&::-webkit-scrollbar":{width:6},"&::-webkit-scrollbar-track":{background:"transparent"},"&::-webkit-scrollbar-thumb":{background:o(t.palette.text.primary,.2),borderRadius:8}})),rr=u(Wt,{shouldForwardProp:t=>t!=="selected"})(({theme:t,selected:h})=>({padding:t.spacing(1,1.5),cursor:"pointer",transition:"all 0.15s ease",borderBottom:`1px solid ${o(t.palette.divider,.05)}`,...h&&{backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.08):i[300]},"&:hover":{backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.05):i[200]},"&:last-child":{borderBottom:"none"}})),ar=u(E)(({theme:t})=>({borderRadius:12,textTransform:"none",fontWeight:600,fontSize:"0.875rem",padding:t.spacing(1.25,3),background:t.palette.mode==="dark"?i[1100]:i[1200],color:"#fff",boxShadow:`0 4px 14px ${o(t.palette.common.black,.15)}`,transition:"all 0.2s ease","&:hover":{background:t.palette.mode==="dark"?i[1e3]:i[1100],boxShadow:`0 6px 20px ${o(t.palette.common.black,.2)}`,transform:"translateY(-2px)"},"&:active":{transform:"translateY(0)"},"&:disabled":{background:t.palette.action.disabledBackground,color:t.palette.action.disabled,boxShadow:"none"}})),Z=u(E)(({theme:t})=>({borderRadius:12,textTransform:"none",fontWeight:500,fontSize:"0.875rem",padding:t.spacing(1.25,2.5),borderColor:o(t.palette.divider,.3),color:t.palette.text.primary,transition:"all 0.2s ease","&:hover":{borderColor:t.palette.mode==="dark"?i[1e3]:i[1100],backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.04):i[200],transform:"translateY(-1px)"}})),ee=u(E)(({theme:t})=>({borderRadius:8,textTransform:"none",fontWeight:500,fontSize:"0.75rem",padding:t.spacing(.5,1.5),color:t.palette.text.secondary,transition:"all 0.2s ease","&:hover":{backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.08):i[300],color:t.palette.text.primary}})),sr=u(Ke)(({theme:t})=>({height:"100%",animationDelay:"0.1s"})),or=u(Q,{shouldForwardProp:t=>t!=="selected"})(({theme:t,selected:h})=>({padding:t.spacing(1.5),borderRadius:12,cursor:"pointer",transition:"all 0.2s ease",border:`1px solid ${h?t.palette.mode==="dark"?i[1e3]:i[1100]:o(t.palette.divider,.1)}`,backgroundColor:h?t.palette.mode==="dark"?o(t.palette.text.primary,.05):i[200]:"transparent","&:hover":{borderColor:o(t.palette.divider,.3),backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.03):i[200],transform:"translateX(4px)","& .view-summary-hint":{opacity:1,color:t.palette.text.primary}}})),nr=u(Q)(({theme:t})=>({padding:t.spacing(2),borderRadius:12,backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.04):i[200],border:`1px solid ${o(t.palette.divider,.1)}`})),te=u(Ve)(({theme:t})=>({borderRadius:4,height:6,backgroundColor:o(t.palette.text.primary,.1),"& .MuiLinearProgress-bar":{borderRadius:4,background:t.palette.mode==="dark"?i[1e3]:i[1200]}})),ir=u(K)(({theme:t})=>({borderRadius:12,backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.05):i[200],border:`1px solid ${o(t.palette.divider,.2)}`,"& .MuiAlert-icon":{color:t.palette.text.secondary},"& .MuiAlert-message":{color:t.palette.text.primary}})),lr=u(K)(({theme:t})=>({borderRadius:12,backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.05):i[200],border:`1px solid ${o(t.palette.divider,.2)}`,"& .MuiAlert-icon":{color:t.palette.text.secondary},"& .MuiAlert-message":{color:t.palette.text.primary}})),cr=u(K)(({theme:t})=>({borderRadius:12,backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.05):i[200],border:`1px solid ${o(t.palette.divider,.2)}`,"& .MuiAlert-icon":{color:t.palette.text.secondary},"& .MuiAlert-message":{color:t.palette.text.primary}})),dr=u(he)(({theme:t})=>({color:t.palette.text.secondary})),_e=u(E)(({theme:t})=>({borderRadius:8,textTransform:"none",fontWeight:500,fontSize:"0.75rem",padding:t.spacing(.5,1.5),borderColor:o(t.palette.divider,.3),transition:"all 0.2s ease","&:hover":{borderColor:t.palette.mode==="dark"?i[1e3]:i[1100],backgroundColor:t.palette.mode==="dark"?o(t.palette.text.primary,.04):i[200]}})),re=u(Mt)(({theme:t})=>({borderColor:o(t.palette.divider,.08),margin:t.spacing(2,0)})),A=t=>t.toISOString().split("T")[0],me=()=>{const t=new Date,h=new Date(t);h.setDate(t.getDate()-t.getDay());const w=new Date(t.getFullYear(),t.getMonth(),1),d=new Date(t.getFullYear(),t.getMonth()-1,1),j=new Date(t.getFullYear(),t.getMonth(),0);return{today:{label:"Today",start:A(t),end:A(t)},thisWeek:{label:"This Week",start:A(h),end:A(t)},thisMonth:{label:"This Month",start:A(w),end:A(t)},lastMonth:{label:"Last Month",start:A(d),end:A(j)}}};function pr(){const t=kt(),[h]=vt(),w=Ct(),d=Ge(),{execute:j}=be(),$=s.useCallback((r,a,x={})=>w(r,{label:a,intent:{from:"reports",...x}}),[w]),g=de(r=>r.templates),b=de(r=>r.activeConnection),P=de(r=>r.setTemplates),[l,R]=s.useState(h.get("template")||""),[v,O]=s.useState(""),[f,z]=s.useState(""),[S,F]=s.useState("thisMonth"),[T,q]=s.useState({}),[fe,n]=s.useState(!1),[m,y]=s.useState(!1),[H,B]=s.useState(null),[V,k]=s.useState(null),[ye,Ue]=s.useState({}),[U,je]=s.useState(!1),[I,se]=s.useState(null),[L,Y]=s.useState([]),[oe,ke]=s.useState(!1),[ve,Ce]=s.useState([]),[_,Je]=s.useState(null),[M,ne]=s.useState(null),[ie,Se]=s.useState(!1),[we,Ie]=s.useState(!1),Xe=g.find(r=>r.id===l)?.kind?.toUpperCase()||"PDF",Ze=v&&f?`${v} to ${f}`:"Select dates",et=b?.name||"No connection",{celebrating:tt,celebrate:Re,onComplete:rt}=Bt(),le=s.useRef(0),J=s.useRef(0);s.useEffect(()=>{const r=async()=>{n(!0);try{const a=await Pt();P(a),!l&&a.length>0&&R(a[0].id)}catch(a){d.show(a.message||"Failed to load designs","error")}finally{n(!1)}};g.length===0&&r()},[g.length,P,l,d]),s.useEffect(()=>{(async()=>{if(!l||!b?.id)return;const a=++le.current;try{const x=g.find(X=>X.id===l),W=await Ft(l,{connectionId:b.id,kind:x?.kind||"pdf"});a===le.current&&Ue(W.keys||{})}catch(x){a===le.current&&(console.error("Failed to fetch key options:",x),d.show("Could not load filter options. You can still generate reports.","warning"))}})()},[l,b?.id,g,d]);const at=s.useCallback(r=>{R(r.target.value),q({}),B(null),se(null),Y([])},[]),st=s.useCallback(r=>{r?.id&&(R(r.id),q({}),B(null),d.show(`Selected: ${r.name||r.id}`,"success"))},[d]),ot=s.useCallback((r,a)=>{q(x=>({...x,[r]:a}))},[]),Te=s.useCallback(r=>{if(F(r),r!=="custom"){const x=me()[r];x&&(O(x.start),z(x.end))}},[]);s.useEffect(()=>{if(!v&&!f&&S!=="custom"){const a=me()[S];a&&(O(a.start),z(a.end))}},[]);const De=s.useCallback(async()=>{if(!l||!b?.id){d.show("Please select a design and connect to a data source first","error");return}if(I&&L.length===0){d.show("Select at least one batch to run","error");return}if(v&&f&&new Date(v)>new Date(f)){d.show("Start date must be before or equal to end date","error");return}await j({type:G.EXECUTE,label:"Generate report",reversibility:N.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{templateId:l,connectionId:b?.id,action:"run_report"},action:async()=>{y(!0),k(null),B(null);try{const r=g.find(ut=>ut.id===l),a=I?.batches||[],x=a.length>0&&L.length===a.length,W=a.length>0&&L.length>0&&!x,X=await St({templateId:l,templateName:r?.name,connectionId:b.id,startDate:v||void 0,endDate:f||void 0,keyValues:Object.keys(T).length>0?T:void 0,batchIds:W?L:void 0,kind:r?.kind||"pdf"});return B(X),d.show("Report generation started!","success"),Re(),X}catch(r){throw k(r.message||"Failed to generate report"),d.show(r.message||"Failed to generate report","error"),r}finally{y(!1)}}})},[l,b?.id,g,v,f,T,I,L,d,Re,j]),ze=Object.keys(ye),nt=s.useCallback(async()=>{if(!l||!b?.id){d.show("Select a design and data source first","error");return}if(!v||!f){d.show("Provide a start and end date to discover batches","error");return}if(new Date(v)>new Date(f)){d.show("Start date must be before or equal to end date","error");return}await j({type:G.ANALYZE,label:"Discover batches",reversibility:N.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{templateId:l,connectionId:b?.id,action:"discover_batches"},action:async()=>{je(!0),se(null);try{const r=g.find(W=>W.id===l),a=await wt({templateId:l,connectionId:b.id,startDate:v,endDate:f,keyValues:Object.keys(T).length>0?T:void 0,kind:r?.kind||"pdf"});se(a);const x=Array.isArray(a?.batches)?a.batches.map(W=>W.id):[];return Y(x),a}catch(r){throw d.show(r.message||"Failed to discover batches","error"),r}finally{je(!1)}}})},[l,b?.id,v,f,T,g,d,j]),ce=s.useCallback(async()=>{if(!l){Ce([]);return}ke(!0);try{const r=await It({templateId:l,limit:6});Ce(r)}catch(r){console.error("Failed to load run history:",r),d.show("Failed to load run history","warning")}finally{ke(!1)}},[l,d]);s.useEffect(()=>{ce()},[ce]);const it=s.useCallback(r=>{Y(a=>a.includes(r)?a.filter(x=>x!==r):[...a,r])},[]),lt=s.useCallback(async r=>{if(Je(r),ne(null),r?.id){const a=++J.current;Se(!0);try{const x=await Ht(r.id);a===J.current&&ne(x.summary||x)}catch(x){a===J.current&&(console.error("Failed to fetch summary:",x),ne(null))}finally{a===J.current&&Se(!1)}}},[]),ct=s.useCallback(async()=>{_?.id&&await j({type:G.GENERATE,label:"Queue summary",reversibility:N.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{runId:_?.id,action:"queue_report_summary"},action:async()=>{Ie(!0);try{const r=await Vt(_.id);return r?.job_id||r?.jobId||null?d.show("Summary queued. Track progress in Report Progress.","success"):d.show("Failed to queue summary.","error"),r}catch(r){throw d.show(r?.message||"Failed to queue summary.","error"),r}finally{Ie(!1)}}})},[_?.id,d,j]),dt=s.useCallback(()=>{const r=Array.isArray(I?.batches)?I.batches.map(a=>a.id):[];Y(r)},[I]),pt=s.useCallback(()=>{Y([])},[]);return e.jsxs(Xt,{children:[e.jsx(_t,{trigger:tt,onComplete:rt}),e.jsxs(Yt,{maxWidth:"lg",children:[e.jsxs(Zt,{children:[e.jsx(er,{children:"Run a Report"}),e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Choose a design, set your date range, and generate a new report run."})]}),e.jsx(Gt,{sx:{mb:3}}),!b&&e.jsx(ir,{severity:"warning",sx:{mb:3},children:"Please add a data source first to create reports."}),e.jsx(C,{sx:{mb:3},children:e.jsx(Jt,{onSelectTemplate:st})}),e.jsxs(ue,{container:!0,spacing:3,children:[e.jsx(ue,{size:{xs:12,md:8},children:e.jsxs(Ke,{children:[e.jsxs(xe,{children:[e.jsx(Rt,{sx:{fontSize:14}}),"Report Settings"]}),e.jsxs(c,{spacing:3,children:[e.jsx(K,{severity:"info",sx:{borderRadius:1},action:e.jsx(E,{size:"small",onClick:()=>$("/jobs","Open jobs"),sx:{textTransform:"none"},children:"View Progress"}),children:"Reports run in the background. Track progress in Report Progress and download finished files in History."}),e.jsxs(C,{sx:{p:1.5,borderRadius:1,border:"1px solid",borderColor:"divider",bgcolor:o(t.palette.background.paper,.6)},children:[e.jsx(p,{variant:"subtitle2",sx:{mb:1},children:"Outcome preview"}),e.jsxs(c,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(D,{size:"small",label:`Output: ${Xe}`,variant:"outlined"}),e.jsx(D,{size:"small",label:`Connection: ${et}`,variant:"outlined"}),e.jsx(D,{size:"small",label:`Dates: ${Ze}`,variant:"outlined"})]})]}),e.jsxs($e,{fullWidth:!0,children:[e.jsx(Pe,{children:"Report Design"}),e.jsx(Fe,{value:l,onChange:at,label:"Report Design",children:g.map(r=>e.jsx(pe,{value:r.id,children:e.jsxs(c,{direction:"row",alignItems:"center",spacing:1,children:[e.jsx("span",{children:r.name||r.id}),e.jsx(D,{label:r.kind?.toUpperCase()||"PDF",size:"small",variant:"outlined",sx:{borderRadius:6,fontSize:"0.65rem",height:20}})]})},r.id))})]}),e.jsxs(C,{children:[e.jsx(We,{children:"Time Period"}),e.jsxs(c,{direction:"row",spacing:1,sx:{mb:2,flexWrap:"wrap",gap:1},children:[Object.entries(me()).map(([r,a])=>e.jsx(qe,{label:a.label,icon:e.jsx(Kt,{sx:{fontSize:14}}),onClick:()=>Te(r),selected:S===r,variant:S===r?"filled":"outlined"},r)),e.jsx(qe,{label:"Custom",icon:e.jsx(Qt,{sx:{fontSize:14}}),onClick:()=>Te("custom"),selected:S==="custom",variant:S==="custom"?"filled":"outlined"})]}),e.jsxs(c,{direction:{xs:"column",sm:"row"},spacing:2,children:[e.jsx(Oe,{label:"Start Date",type:"date",value:v,onChange:r=>{O(r.target.value),F("custom")},InputLabelProps:{shrink:!0},fullWidth:!0,size:"small"}),e.jsx(Oe,{label:"End Date",type:"date",value:f,onChange:r=>{z(r.target.value),F("custom")},InputLabelProps:{shrink:!0},fullWidth:!0,size:"small"})]})]}),ze.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(re,{}),e.jsxs(C,{children:[e.jsxs(xe,{children:[e.jsx(Ot,{sx:{fontSize:14}}),"Filter Parameters"]}),e.jsx(c,{spacing:2,children:ze.map(r=>e.jsxs($e,{fullWidth:!0,size:"small",children:[e.jsx(Pe,{children:r}),e.jsxs(Fe,{value:T[r]||"",onChange:a=>ot(r,a.target.value),label:r,children:[e.jsx(pe,{value:"",children:e.jsx("em",{children:"All"})}),(ye[r]||[]).map(a=>e.jsx(pe,{value:a,children:a},a))]})]},r))})]})]}),e.jsx(re,{}),e.jsxs(c,{direction:"row",spacing:1,alignItems:"center",justifyContent:"space-between",children:[e.jsx(We,{sx:{mb:0},children:"Find Data Batches"}),e.jsx(Z,{variant:"outlined",size:"small",onClick:nt,disabled:U||!l||!b,children:U?"Searching...":"Find Batches"})]}),U&&e.jsx(te,{}),!U&&I&&e.jsxs(c,{spacing:2,children:[e.jsxs(c,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(Be,{label:`${I.batches_count||I.batches?.length||0} batches`}),e.jsx(Be,{label:`${I.rows_total||0} rows`})]}),e.jsxs(c,{direction:"row",spacing:1,children:[e.jsx(ee,{size:"small",onClick:dt,children:"Select all"}),e.jsx(ee,{size:"small",onClick:pt,children:"Clear"})]}),e.jsx(tr,{children:e.jsx(Tt,{dense:!0,disablePadding:!0,children:(I.batches||[]).map(r=>e.jsxs(rr,{disableGutters:!0,onClick:()=>it(r.id),selected:L.includes(r.id),children:[e.jsx(Dt,{checked:L.includes(r.id),sx:{p:.5,mr:1}}),e.jsx(zt,{primary:`${r.id}`,secondary:`${r.rows||0} rows`,primaryTypographyProps:{variant:"body2",fontWeight:500},secondaryTypographyProps:{variant:"caption"}})]},r.id))})})]}),V&&e.jsx(cr,{severity:"error",onClose:()=>k(null),action:e.jsx(ee,{color:"inherit",size:"small",onClick:De,disabled:m,children:"Try Again"}),children:V}),m&&e.jsxs(C,{children:[e.jsx(p,{variant:"body2",color:"text.secondary",sx:{mb:1},children:"Generating report..."}),e.jsx(te,{})]}),e.jsxs(c,{direction:"row",spacing:2,justifyContent:"flex-end",children:[e.jsx(Z,{variant:"outlined",startIcon:e.jsx(ge,{}),disabled:!l||m,onClick:()=>$(`/schedules?template=${l}`,"Open schedules",{templateId:l}),children:"Schedule"}),e.jsx(ar,{startIcon:e.jsx(At,{}),onClick:De,disabled:!l||!b||m,children:"Generate Report"})]})]})]})}),e.jsx(ue,{size:{xs:12,md:4},children:e.jsxs(sr,{children:[e.jsx(xe,{children:"Output"}),H?e.jsxs(c,{spacing:2,children:[e.jsxs(lr,{severity:"success",children:["Report started! ID: ",H.job_id?.slice(0,8),"..."]}),e.jsx(p,{variant:"body2",color:"text.secondary",children:"Your report is being generated. Track it in Report Progress."}),e.jsx(Z,{size:"small",variant:"outlined",onClick:()=>$("/jobs","Open jobs"),sx:{alignSelf:"flex-start"},children:"View Progress"})]}):e.jsx(p,{variant:"body2",color:"text.secondary",children:'Configure your report parameters and click "Generate Report" to create a new report.'}),_&&e.jsxs(e.Fragment,{children:[e.jsx(re,{}),e.jsx(Nt,{title:"AI summary",description:"Summaries are generated from the selected report run. Review before sharing.",chips:[{label:"Source: Selected run",color:"info",variant:"outlined"},{label:"Confidence: Review required",color:"warning",variant:"outlined"}],dense:!0,sx:{mb:2}}),e.jsxs(c,{spacing:1.5,children:[e.jsxs(c,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(dr,{fontSize:"small"}),e.jsx(p,{variant:"subtitle2",fontWeight:600,children:"AI Summary"})]}),ie&&e.jsx(te,{}),!ie&&M?e.jsxs(nr,{children:[e.jsx(p,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:typeof M=="string"?M:M.text||M.content||"No summary available"}),M.key_points&&e.jsxs(C,{sx:{mt:1.5},children:[e.jsx(p,{variant:"caption",fontWeight:600,color:"text.primary",children:"Key Points:"}),e.jsx("ul",{style:{margin:"4px 0",paddingLeft:20},children:M.key_points.map((r,a)=>e.jsx("li",{children:e.jsx(p,{variant:"caption",children:r})},a))})]})]}):!ie&&e.jsxs(c,{spacing:1,children:[e.jsx(p,{variant:"body2",color:"text.secondary",children:"Click on a run below to view its AI summary."}),e.jsx(Z,{size:"small",variant:"outlined",startIcon:e.jsx(ge,{}),onClick:ct,disabled:we,sx:{alignSelf:"flex-start"},children:we?"Queueing...":"Queue summary"})]})]})]}),e.jsx(re,{}),e.jsxs(c,{spacing:1.5,children:[e.jsxs(c,{direction:"row",spacing:1,alignItems:"center",justifyContent:"space-between",children:[e.jsx(p,{variant:"subtitle2",fontWeight:600,children:"Recent Runs"}),e.jsx(ee,{size:"small",onClick:ce,disabled:oe,startIcon:e.jsx(Et,{sx:{fontSize:14}}),children:"Refresh"})]}),oe&&e.jsx(te,{}),!oe&&ve.length===0&&e.jsx(p,{variant:"body2",color:"text.secondary",children:"No recent runs for this design yet."}),e.jsx(c,{spacing:1,children:ve.map(r=>e.jsx(or,{selected:_?.id===r.id,onClick:()=>lt(r),title:"Click to view summary",children:e.jsxs(c,{spacing:.5,children:[e.jsxs(c,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[e.jsx(p,{variant:"body2",fontWeight:600,children:new Date(r.createdAt).toLocaleString()}),e.jsxs(c,{direction:"row",alignItems:"center",spacing:.5,className:"view-summary-hint",sx:{opacity:.6,transition:"all 0.2s ease"},children:[e.jsx(p,{variant:"caption",color:"text.secondary",children:"View"}),e.jsx($t,{sx:{fontSize:12}})]})]}),e.jsxs(p,{variant:"caption",color:"text.secondary",children:[r.startDate," to ",r.endDate]}),e.jsxs(c,{direction:"row",spacing:1,sx:{mt:.5},children:[r.artifacts?.pdf_url&&e.jsx(_e,{size:"small",variant:"outlined",startIcon:e.jsx(Me,{sx:{fontSize:14}}),href:Le(r.artifacts.pdf_url),target:"_blank",onClick:a=>a.stopPropagation(),children:"PDF"}),r.artifacts?.html_url&&e.jsx(_e,{size:"small",variant:"outlined",startIcon:e.jsx(Me,{sx:{fontSize:14}}),href:Le(r.artifacts.html_url),target:"_blank",onClick:a=>a.stopPropagation(),children:"HTML"})]})]})},r.id))})]})]})})]})]})]})}function wr(){return be(),e.jsx(pr,{})}export{wr as default};
