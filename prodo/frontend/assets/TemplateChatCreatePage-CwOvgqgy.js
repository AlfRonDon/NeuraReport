import{w as ke,v as Ae,a as oe,l as j,aC as Z,Z as De,r as t,R as P,I as M,aD as Ee,aE as Pe,aF as X,aG as Me,j as a,B as f,aw as Re,ax as _e,aH as Ne,o as b,aI as ze,q as F,s as Fe,K as R,n as T,P as ee,p as ae,e as Be,ag as We,A as $e,ah as Le,aj as Ue,al as He,a2 as Oe,aJ as Ye,am as Ge}from"./index-COTlR4Mk.js";import{A as Ke}from"./ArrowBack-YtoUBwn5.js";import{S as Ve}from"./Save-D7cNiqo5.js";import{U as qe}from"./UploadFile-DBA92v35.js";import{P as te}from"./PictureAsPdf-Bwg-ZKh2.js";import{S as Je}from"./Surface-C3Bol4c_.js";import{C as Qe}from"./ConnectionSelector-DIWHs3I4.js";import{T as Ze}from"./TemplateChatEditor-Duw1Xc7A.js";import{T as Xe,a as ne}from"./ToggleButtonGroup-CkPncIAE.js";import"./Lightbulb-BGaZkdEF.js";import"./Autocomplete-Bc71fcbE.js";import"./TableRow-9uVWzbJ3.js";const se=10,c="__chat_create__";function ea(){const y=ke(),s=Ae(),{execute:B}=oe(),W=j(e=>e.addTemplate),$=j(e=>e.setTemplateId),x=j(e=>e.lastUsed?.connectionId||null),re=j(e=>e.activeConnection),ie=j(e=>e.setActiveConnectionId),I=Z(e=>e.deleteSession),[L]=De(),w=L.get("from")==="wizard",v=L.get("connectionId")||null,[k,le]=t.useState(v||x||re?.id||""),p=Z(e=>e.addAssistantMessage),[h,U]=t.useState(""),[H,O]=t.useState(null),[ce,_]=t.useState(!1),[C,pe]=t.useState(""),[A,Y]=t.useState(!1),[D,G]=t.useState(null),[i,de]=t.useState("pdf"),E=t.useRef(null),[l,me]=t.useState(null),[g,ue]=t.useState("pdf"),[d,he]=t.useState(""),[N,ge]=t.useState(null),[fe,K]=t.useState(!1),z=t.useCallback(e=>{if(!e)return;const n=["application/pdf"],o=["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel"],r=i==="excel"?[...n,...o]:n,u=/\.(xlsx|xls)$/i.test(e.name);if(!r.includes(e.type)&&!(i==="excel"&&u)){s.show(i==="excel"?"Please upload a PDF or Excel file.":"Please upload a PDF file.","warning");return}if(e.size>se*1024*1024){s.show(`File too large. Maximum size is ${se}MB.`,"warning");return}G({file:e,name:e.name,size:e.size}),s.show(`Sample file "${e.name}" attached. The AI will use this as a visual reference.`,"info")},[s,i]),xe=t.useCallback(e=>{e.preventDefault();const n=e.dataTransfer?.files?.[0];z(n)},[z]),ve=t.useCallback(e=>{e.preventDefault()},[]),be=t.useCallback(()=>{G(null),E.current&&(E.current.value="")},[]);t.useEffect(()=>{if(!h){O(null);return}const e=new Blob([h],{type:"text/html"}),n=URL.createObjectURL(e);return O(n),()=>URL.revokeObjectURL(n)},[h]),t.useEffect(()=>()=>{},[]);const ye=t.useCallback(e=>{U(e)},[]),we=t.useCallback(e=>{e?.updated_html&&U(e.updated_html)},[]),Te=t.useCallback(async()=>{await y(w?"/setup?step=template":"/templates",{interaction:{type:M.NAVIGATE,label:w?"Back to wizard":"Back to templates",reversibility:P.FULLY_REVERSIBLE}})},[y,w]),V=t.useCallback(()=>{_(!0)},[]),q=t.useCallback(()=>{_(!1)},[]),J=t.useCallback(async()=>{const e=C.trim();if(!e){s.show("Please enter a template name.","warning");return}if(!h){s.show("No template HTML to save. Continue the conversation to generate a template first.","warning");return}await B({type:M.CREATE,label:"Create template from chat",reversibility:P.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{action:"create_template_from_chat",name:e},action:async()=>{Y(!0);try{const n=await Ee(e,h,i),o=n?.template_id,r=n?.kind||"pdf";o&&(W({id:o,name:e,kind:r,status:"draft",artifacts:{},tags:[]}),$(o)),_(!1);const u=k||v||x;if(o&&u){me(o),ue(r),he(e),s.show(`Template "${e}" saved! Fetching data mapping suggestions...`,"info"),p(c,`Template "${e}" has been saved successfully! Now let's configure how your template fields map to your database columns. Fetching mapping suggestions...`);try{const S=await Pe(o,u,{kind:r}),Q=S?.mapping||S?.auto_mapping||{};Object.keys(Q).length>0?(ge(S),p(c,`I've auto-mapped ${Object.keys(Q).length} template fields to your database columns. Review the mapping below — you can click any value to change it, or type in the chat to discuss changes.`)):(s.show(`Template "${e}" saved. No auto-mapping available — you can configure mapping later.`,"info"),p(c,"Template saved, but I couldn't generate auto-mapping suggestions. You can configure mapping manually from the template editor."),m(o,e,r))}catch(S){console.warn("Mapping preview failed:",S),s.show(`Template "${e}" saved. Mapping preview failed — you can map manually later.`,"warning"),p(c,"Template saved! Auto-mapping encountered an issue, but you can configure it from the template editor."),m(o,e,r)}}else s.show(`Template "${e}" created successfully.`,"success"),p(c,`Template "${e}" has been saved! Connect a database to enable field mapping.`),I(c),m(o,e,r)}catch(n){throw s.show(String(n.message||n),"error"),n}finally{Y(!1)}}})},[C,h,B,W,$,I,s,y,w,v,x,p]),m=t.useCallback(async(e,n,o)=>{if(I(c),w){try{const r=sessionStorage.getItem("neurareport_wizard_state"),u=r?JSON.parse(r):{};u.templateId=e,u.templateKind=o,u.templateName=n,sessionStorage.setItem("neurareport_wizard_state",JSON.stringify(u))}catch{}await y("/setup?step=mapping",{interaction:{type:M.NAVIGATE,label:"Continue to mapping",reversibility:P.FULLY_REVERSIBLE}})}else await y(`/templates/${e}/edit`,{state:{from:"/templates",editMode:"chat"},interaction:{type:M.NAVIGATE,label:"Open new template editor",reversibility:P.FULLY_REVERSIBLE}})},[I,w,y]),Ce=t.useCallback(async e=>{if(l){K(!0);try{const n=k||v||x;p(c,"Building contract and generator assets... This may take a moment."),s.show("Approving mapping and building contract...","info"),await X(l,e,{connectionId:n,kind:g}),s.show(`Template "${d}" is report-ready!`,"success"),p(c,`Mapping approved and contract built! Template "${d}" is now report-ready. Redirecting...`),setTimeout(()=>{m(l,d,g)},1500)}catch(n){console.error("Mapping approve failed:",n),s.show("Mapping approval failed. You can retry or map later from the editor.","error"),p(c,`Mapping approval encountered an error: ${n.message||n}. You can try again or skip to map later.`)}finally{K(!1)}}},[l,g,d,v,x,s,p,m]),Se=t.useCallback(()=>{l&&(s.show(`Template "${d}" saved. You can configure mapping from the editor.`,"info"),m(l,d,g))},[l,d,g,s,m]),je=t.useCallback(()=>{if(!l)return;const e=k||v||x;X(l,N?.mapping||{},{connectionId:e,kind:g}).then(()=>{}).catch(n=>{console.warn("Background mapping approval failed:",n)}),s.show(`Mapping approval queued for "${d}". You can check progress from the template editor.`,"info"),m(l,d,g)},[l,d,g,v,x,N,s,m]),Ie=t.useCallback((e,n)=>Me(e,n,D?.file||null,i),[D,i]);return a.jsxs(f,{sx:{display:"flex",flexDirection:"column",flex:"1 1 0",minHeight:0,overflow:"hidden"},children:[a.jsx(f,{sx:{mb:1,flexShrink:0},children:a.jsxs(Re,{separator:a.jsx(ze,{fontSize:"small"}),"aria-label":"breadcrumb",children:[a.jsx(_e,{component:Ne,to:"/templates",underline:"hover",color:"text.secondary",sx:{display:"flex",alignItems:"center",gap:.5},children:"Templates"}),a.jsx(b,{color:"text.primary",fontWeight:600,children:"Create with AI"})]})}),a.jsxs(Je,{sx:{gap:{xs:1.5,md:2},flex:"1 1 0",minHeight:0,overflow:"hidden"},children:[a.jsxs(F,{direction:"row",justifyContent:"space-between",alignItems:"center",spacing:1.5,sx:{flexShrink:0},children:[a.jsxs(F,{direction:"row",spacing:1,alignItems:"center",sx:{minWidth:0},children:[a.jsx(Fe,{sx:{color:"text.secondary",fontSize:20}}),a.jsx(b,{variant:"h6",fontWeight:600,children:"Create Template with AI"})]}),a.jsxs(F,{direction:"row",spacing:1.5,alignItems:"center",children:[a.jsx(Qe,{value:k,onChange:e=>{le(e),ie(e)},label:"Data Source",size:"small",fullWidth:!1,sx:{minWidth:200}}),a.jsx(R,{variant:"contained",onClick:V,disabled:!h,startIcon:a.jsx(Ve,{}),sx:{textTransform:"none",fontWeight:600,bgcolor:T[900],"&:hover":{bgcolor:T[700]},"&.Mui-disabled":{bgcolor:T[300],color:T[500]}},children:"Save Template"}),a.jsx(R,{variant:"outlined",onClick:Te,startIcon:a.jsx(Ke,{}),sx:{textTransform:"none",fontWeight:600},children:"Back"})]})]}),D?a.jsxs(ee,{variant:"outlined",sx:{px:1.5,py:.75,display:"flex",alignItems:"center",gap:1,borderColor:"primary.main",bgcolor:"primary.50",flexShrink:0},children:[a.jsx(te,{sx:{color:"error.main",fontSize:20}}),a.jsx(b,{variant:"body2",fontWeight:600,noWrap:!0,sx:{flex:1,minWidth:0},children:D.name}),a.jsx(ae,{label:"Sample PDF",size:"small",color:"primary",variant:"outlined"}),a.jsx(Be,{size:"small",onClick:be,title:"Remove sample PDF",children:a.jsx(We,{fontSize:"small"})})]}):a.jsxs(ee,{variant:"outlined",onDrop:xe,onDragOver:ve,onClick:()=>E.current?.click(),sx:{px:1.5,py:.75,display:"flex",alignItems:"center",gap:1,cursor:"pointer",borderStyle:"dashed",borderColor:"divider","&:hover":{borderColor:"primary.main",bgcolor:"action.hover"},transition:"all 0.15s",flexShrink:0},children:[a.jsx(qe,{sx:{color:"text.secondary"}}),a.jsxs(f,{sx:{flex:1},children:[a.jsx(b,{variant:"body2",fontWeight:600,children:i==="excel"?"Have a sample PDF or Excel file?":"Have a sample PDF?"}),a.jsx(b,{variant:"caption",color:"text.secondary",children:i==="excel"?"Drop a PDF or Excel file here or click to upload. The AI will use it as a visual reference.":"Drop a PDF here or click to upload. The AI will use it as a visual reference for layout and styling."})]}),a.jsx(ae,{label:"Optional",size:"small",variant:"outlined"}),a.jsx("input",{ref:E,type:"file",accept:i==="excel"?"application/pdf,.xlsx,.xls":"application/pdf",hidden:!0,onChange:e=>z(e.target.files?.[0])})]}),a.jsxs(f,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"7fr 5fr"},gap:2,flex:1,minHeight:0},children:[a.jsxs(f,{sx:{border:"1px solid",borderColor:"divider",borderRadius:1,overflow:"hidden",bgcolor:"background.paper",display:"flex",flexDirection:"column",minHeight:0},children:[a.jsx(f,{sx:{p:1.5,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.default",flexShrink:0},children:a.jsx(b,{variant:"caption",fontWeight:600,color:"text.secondary",children:"Template Preview"})}),a.jsx(f,{sx:{flex:1,minHeight:0,overflow:"auto"},children:H?a.jsx("iframe",{src:H,title:"Template Preview",style:{width:"100%",height:"100%",border:"none",display:"block",minHeight:600}}):a.jsx(f,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",p:4},children:a.jsx($e,{severity:"info",variant:"outlined",sx:{maxWidth:400},children:"Start a conversation to generate a template. The preview will appear here as the AI creates your template."})})})]}),a.jsx(Ze,{templateId:c,templateName:"New Template",currentHtml:h,onHtmlUpdate:ye,onApplySuccess:we,onRequestSave:V,mappingPreviewData:N,mappingApproving:fe,onMappingApprove:Ce,onMappingSkip:Se,onMappingQueue:je,mode:"create",chatApi:Ie})]})]}),a.jsxs(Le,{open:ce,onClose:q,maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[a.jsx(Ue,{sx:{fontWeight:600},children:"Name Your Template"}),a.jsxs(He,{children:[a.jsx(b,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Give your template a descriptive name. You can change this later."}),a.jsxs(Xe,{value:i,exclusive:!0,onChange:(e,n)=>n&&de(n),size:"small",sx:{mb:2},children:[a.jsxs(ne,{value:"pdf",children:[a.jsx(te,{sx:{mr:1,fontSize:18}})," PDF Report"]}),a.jsxs(ne,{value:"excel",children:[a.jsx(Oe,{sx:{mr:1,fontSize:18}})," Excel Report"]})]}),a.jsx(Ye,{autoFocus:!0,fullWidth:!0,label:"Template Name",placeholder:"e.g., Monthly Sales Invoice",value:C,onChange:e=>pe(e.target.value),onKeyDown:e=>{e.key==="Enter"&&C.trim()&&J()},disabled:A})]}),a.jsxs(Ge,{sx:{px:3,pb:2},children:[a.jsx(R,{onClick:q,disabled:A,children:"Cancel"}),a.jsx(R,{variant:"contained",onClick:J,disabled:!C.trim()||A,sx:{bgcolor:T[900],"&:hover":{bgcolor:T[700]}},children:A?"Creating...":"Create Template"})]})]})]})}function ua(){return oe(),a.jsx(ea,{})}export{ua as default};
