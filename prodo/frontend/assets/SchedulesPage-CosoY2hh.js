import{g as oe,j as t,u as Ce,v as Ne,a as ke,Z as Oe,l as G,r as l,cb as Ue,cc as Ve,c9 as He,R as K,I as Y,cd as be,ce as Ye,cf as Je,B as T,o as C,q,A as Qe,V as re,T as Ze,cg as Ge,e as Ke,a1 as Xe,af as Ie,aT as X,bo as et,aU as ee,aY as tt,G as at,N as m,p as we,n as d,f as i,O as nt,bI as Se,a7 as st,a_ as lt,M as J,H as te,m as ae,S as ne,b0 as rt,ah as it,aj as ot,al as ct,aJ as dt,am as ut,K as pt}from"./index-DeRHNZar.js";import{D as ht}from"./DataTable-DeFvC17i.js";import{C as mt}from"./ConfirmModal-BHWqBz2Z.js";import{C as gt}from"./Container-BG8lhrz1.js";import{M as xt}from"./MoreVert-BjEJop_-.js";import{S as ft}from"./Switch-DE_06Ex2.js";import{E as bt}from"./Email-DW3BY6Zo.js";import"./KeyboardArrowDown-Bu4MpLhn.js";import"./FilterList-D07PuMFv.js";import"./Check-D18rRUYU.js";import"./TableRow-8TKLtwpY.js";import"./TableContainer-BIUEnX5e.js";import"./KeyboardArrowRight-B-zFI2kH.js";import"./CheckCircleOutline-BoLve1SG.js";import"./WarningAmber-Bt52ndVT.js";const St=oe(t.jsx("path",{d:"M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 16H5V10h14zM9 14H7v-2h2zm4 0h-2v-2h2zm4 0h-2v-2h2zm-8 4H7v-2h2zm4 0h-2v-2h2zm4 0h-2v-2h2z"})),yt=oe(t.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-6h2zm0-8h-2V7h2z"})),vt=oe(t.jsx("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"})),jt=m(T)(({theme:e})=>({padding:e.spacing(3),animation:`${nt} 0.4s ease-out`})),Ct=m(it)(({theme:e})=>({"& .MuiDialog-paper":{backgroundColor:i(e.palette.background.paper,.95),backdropFilter:"blur(20px)",borderRadius:8,border:`1px solid ${i(e.palette.divider,.1)}`,boxShadow:`0 24px 48px ${i(e.palette.common.black,.2)}`},"& .MuiBackdrop-root":{backgroundColor:i(e.palette.common.black,.5),backdropFilter:"blur(4px)"}})),kt=m(ot)(({theme:e})=>({display:"flex",alignItems:"center",gap:e.spacing(2),padding:e.spacing(3),borderBottom:`1px solid ${i(e.palette.divider,.1)}`})),It=m(T)(({theme:e})=>({width:48,height:48,borderRadius:14,backgroundColor:e.palette.mode==="dark"?i(e.palette.text.primary,.08):d[100],display:"flex",alignItems:"center",justifyContent:"center","& svg":{fontSize:24,color:e.palette.text.secondary}})),wt=m(ct)(({theme:e})=>({padding:e.spacing(3)})),Dt=m(ut)(({theme:e})=>({padding:e.spacing(2,3),borderTop:`1px solid ${i(e.palette.divider,.1)}`,backgroundColor:i(e.palette.background.paper,.3),gap:e.spacing(1)})),se=m(C)(({theme:e})=>({fontSize:"0.75rem",fontWeight:600,textTransform:"uppercase",letterSpacing:"0.05em",color:e.palette.text.disabled,marginBottom:e.spacing(2),marginTop:e.spacing(3),display:"flex",alignItems:"center",gap:e.spacing(1),"&:first-of-type":{marginTop:0}})),$=m(dt)(({theme:e})=>({"& .MuiOutlinedInput-root":{borderRadius:12,transition:"all 0.2s cubic-bezier(0.22, 1, 0.36, 1)","&:hover .MuiOutlinedInput-notchedOutline":{borderColor:e.palette.mode==="dark"?i(e.palette.text.primary,.3):d[300]},"&.Mui-focused":{"& .MuiOutlinedInput-notchedOutline":{borderColor:e.palette.mode==="dark"?d[500]:d[700],borderWidth:2}}}})),Rt=m(we,{shouldForwardProp:e=>e!=="active"})(({theme:e,active:r})=>({borderRadius:8,fontWeight:500,fontSize:"0.75rem",backgroundColor:r?e.palette.mode==="dark"?i(e.palette.text.primary,.1):d[100]:e.palette.mode==="dark"?i(e.palette.text.primary,.06):d[50],color:e.palette.text.secondary,border:`1px solid ${r?e.palette.mode==="dark"?i(e.palette.text.primary,.15):d[200]:i(e.palette.divider,.2)}`})),Et=m(we)(({theme:e})=>({borderRadius:8,fontWeight:500,fontSize:"0.75rem",backgroundColor:e.palette.mode==="dark"?i(e.palette.text.primary,.08):d[100],color:e.palette.text.secondary,border:`1px solid ${e.palette.mode==="dark"?i(e.palette.text.primary,.12):d[200]}`})),De=m(ft)(({theme:e})=>({"& .MuiSwitch-switchBase.Mui-checked":{color:e.palette.mode==="dark"?d[500]:d[700],"& + .MuiSwitch-track":{backgroundColor:e.palette.mode==="dark"?d[500]:d[700]}}})),Tt=m(lt)(({theme:e})=>({"& .MuiPaper-root":{backgroundColor:i(e.palette.background.paper,.95),backdropFilter:"blur(20px)",borderRadius:12,border:`1px solid ${i(e.palette.divider,.1)}`,boxShadow:`0 8px 32px ${i(e.palette.common.black,.15)}`,minWidth:180}})),le=m(J)(({theme:e})=>({borderRadius:8,margin:e.spacing(.5,1),padding:e.spacing(1,1.5),transition:"all 0.15s cubic-bezier(0.22, 1, 0.36, 1)","&:hover":{backgroundColor:e.palette.mode==="dark"?i(e.palette.text.primary,.08):d[50]}})),Mt=m(T,{shouldForwardProp:e=>e!=="status"})(({theme:e,status:r})=>{const o=e.palette.mode==="dark"?d[500]:d[700],v=e.palette.mode==="dark"?i(e.palette.text.primary,.1):d[100],f={ok:{bg:v,border:o,text:o},warning:{bg:v,border:o,text:o},disabled:{bg:e.palette.mode==="dark"?i(e.palette.text.primary,.06):d[50],border:i(e.palette.divider,.3),text:e.palette.text.secondary},error:{bg:v,border:o,text:o}},S=f[r]||f.warning;return{display:"flex",alignItems:"center",gap:e.spacing(1.5),padding:e.spacing(1.5,2),marginBottom:e.spacing(2),borderRadius:8,backgroundColor:S.bg,border:`1px solid ${S.border}`,color:S.text}}),Re=m(pt)(({theme:e})=>({borderRadius:10,textTransform:"none",fontWeight:500,padding:e.spacing(1,2.5),transition:"all 0.2s cubic-bezier(0.22, 1, 0.36, 1)"})),At=m(Re)(({theme:e})=>({background:e.palette.mode==="dark"?d[700]:d[900],color:e.palette.common.white,boxShadow:`0 4px 14px ${i(e.palette.common.black,.15)}`,"&:hover":{background:e.palette.mode==="dark"?d[500]:d[700],boxShadow:`0 6px 20px ${i(e.palette.common.black,.2)}`,transform:"translateY(-1px)"},"&:disabled":{background:i(e.palette.text.primary,.1),color:i(e.palette.text.primary,.4),boxShadow:"none"}})),ie=[{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"},{value:"monthly",label:"Monthly"}],ye={daily:1440,weekly:10080,monthly:43200},ve=e=>{if(!e)return"";const r=String(e).match(/^(\d{4}-\d{2}-\d{2})/);return r?r[1]:""},je=(e,r=!1)=>e?`${e} ${r?"23:59:59":"00:00:00"}`:"",Lt=e=>e?e.split(/[;,]/).map(r=>r.trim()).filter(Boolean):[],_t=e=>Array.isArray(e)?e.filter(Boolean).join(", "):"",zt=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),$t=e=>{if(!e||typeof e!="object")return!1;const r=String(e.status||"").toLowerCase();return r==="approved"||r==="active"};function Ft({open:e,onClose:r,schedule:o,templates:v,connections:f,defaultTemplateId:S,defaultConnectionId:B,onSave:F,onError:k}){Ce();const[n,w]=l.useState({name:"",templateId:"",connectionId:"",startDate:"",endDate:"",frequency:"daily",emailRecipients:"",emailSubject:"",emailMessage:"",active:!0}),[N,P]=l.useState(!1),R=!!o;l.useEffect(()=>{if(o){w({name:o.name||"",templateId:o.template_id||"",connectionId:o.connection_id||"",startDate:ve(o.start_date),endDate:ve(o.end_date),frequency:o.frequency||"daily",emailRecipients:_t(o.email_recipients),emailSubject:o.email_subject||"",emailMessage:o.email_message||"",active:o.active!==!1});return}const u=S||v[0]?.id||"",x=B||f[0]?.id||"";w({name:"",templateId:u,connectionId:x,startDate:"",endDate:"",frequency:"daily",emailRecipients:"",emailSubject:"",emailMessage:"",active:!0})},[o,v,f,e,S,B]);const g=u=>x=>{const I=x.target.type==="checkbox"?x.target.checked:x.target.value;w(A=>({...A,[u]:I}))},M=async()=>{const u=ye[n.frequency]||ye.daily,x=Lt(n.emailRecipients),I=je(n.startDate),A=je(n.endDate,!0),O=v.some(p=>p.id===n.templateId),U=f.some(p=>p.id===n.connectionId);if(n.startDate&&n.endDate&&n.endDate<n.startDate){k?.("End date must be on or after start date");return}if(!O){k?.("Selected template is not approved for scheduling. Choose an approved template.");return}if(!U){k?.("Selected connection is no longer available. Choose another connection.");return}if(x.length>0){const p=x.find(V=>!zt(V));if(p){k?.(`Invalid email address: ${p}`);return}}P(!0);try{await F({name:n.name,templateId:n.templateId,connectionId:n.connectionId,startDate:I,endDate:A,frequency:n.frequency,intervalMinutes:u,emailRecipients:x.length?x:void 0,emailSubject:n.emailSubject||void 0,emailMessage:n.emailMessage||void 0,active:n.active}),r()}catch{}finally{P(!1)}},W=N||!n.name||!n.templateId||!n.connectionId||!n.startDate||!n.endDate;return t.jsxs(Ct,{open:e,onClose:r,maxWidth:"sm",fullWidth:!0,TransitionComponent:Ie,children:[t.jsxs(kt,{children:[t.jsx(It,{children:t.jsx(re,{})}),t.jsxs(T,{children:[t.jsx(C,{variant:"h6",sx:{fontWeight:600},children:R?"Edit Schedule":"Create Schedule"}),t.jsx(C,{variant:"body2",color:"text.secondary",children:R?"Update the schedule configuration":"Set up automated report generation"})]})]}),t.jsxs(wt,{children:[t.jsxs(se,{children:[t.jsx(re,{sx:{fontSize:16}}),"Basic Information"]}),t.jsxs(q,{spacing:2.5,children:[t.jsx($,{label:"Schedule Name",value:n.name,onChange:g("name"),fullWidth:!0,required:!0,placeholder:"e.g., Weekly Sales Report"}),t.jsxs(te,{fullWidth:!0,required:!0,children:[t.jsx(ae,{children:"Template"}),t.jsx(ne,{value:n.templateId,onChange:g("templateId"),label:"Template",disabled:R,children:v.map(u=>t.jsx(J,{value:u.id,children:u.name||u.id},u.id))})]}),t.jsxs(te,{fullWidth:!0,required:!0,children:[t.jsx(ae,{children:"Connection"}),t.jsx(ne,{value:n.connectionId,onChange:g("connectionId"),label:"Connection",disabled:R,children:f.map(u=>t.jsx(J,{value:u.id,children:u.name||u.id},u.id))})]})]}),t.jsxs(se,{children:[t.jsx(St,{sx:{fontSize:16}}),"Schedule Timing"]}),t.jsxs(q,{spacing:2.5,children:[t.jsxs(q,{direction:{xs:"column",sm:"row"},spacing:2,children:[t.jsx($,{label:"Start Date",type:"date",value:n.startDate,onChange:g("startDate"),InputLabelProps:{shrink:!0},fullWidth:!0,required:!0}),t.jsx($,{label:"End Date",type:"date",value:n.endDate,onChange:g("endDate"),InputLabelProps:{shrink:!0},fullWidth:!0,required:!0})]}),t.jsxs(te,{fullWidth:!0,children:[t.jsx(ae,{children:"Frequency"}),t.jsx(ne,{value:n.frequency,onChange:g("frequency"),label:"Frequency",children:ie.map(u=>t.jsx(J,{value:u.value,children:u.label},u.value))})]})]}),t.jsxs(se,{children:[t.jsx(bt,{sx:{fontSize:16}}),"Email Notifications (Optional)"]}),t.jsxs(q,{spacing:2.5,children:[t.jsx($,{label:"Email recipients",value:n.emailRecipients,onChange:g("emailRecipients"),placeholder:"ops@example.com, finance@example.com",helperText:"Comma or semicolon separated list",fullWidth:!0}),t.jsx($,{label:"Email subject",value:n.emailSubject,onChange:g("emailSubject"),fullWidth:!0}),t.jsx($,{label:"Email message",value:n.emailMessage,onChange:g("emailMessage"),multiline:!0,minRows:2,fullWidth:!0})]}),t.jsx(T,{sx:{mt:3},children:t.jsx(rt,{control:t.jsx(De,{checked:n.active,onChange:g("active")}),label:t.jsxs(T,{children:[t.jsx(C,{variant:"body2",fontWeight:500,children:"Active"}),t.jsx(C,{variant:"caption",color:"text.secondary",children:"Enable this schedule to run automatically"})]})})})]}),t.jsxs(Dt,{children:[t.jsx(Re,{onClick:r,children:"Cancel"}),t.jsx(At,{onClick:M,disabled:W,children:N?"Saving...":R?"Update Schedule":"Create Schedule"})]})]})}function Pt(){Ce();const e=Ne(),{execute:r}=ke(),[o,v]=Oe(),f=G(a=>a.templates),S=G(a=>a.savedConnections),B=G(a=>a.activeConnectionId),[F,k]=l.useState([]),[n,w]=l.useState([]),[N,P]=l.useState(!1),[R,g]=l.useState(!1),[M,W]=l.useState(null),[u,x]=l.useState(!1),[I,A]=l.useState(null),[O,U]=l.useState(null),[p,V]=l.useState(null),[ce,de]=l.useState(null),[ue,Ee]=l.useState(null),L=l.useRef(null),pe=l.useRef(!1),he=l.useRef(!1),_=l.useMemo(()=>Array.isArray(f)?f.filter($t):[],[f]),D=l.useCallback(async()=>{P(!0);try{const a=await Ue();k(a||[])}catch(a){e.show(a.message||"Failed to load schedules","error")}finally{P(!1)}},[e]),me=l.useCallback(async()=>{try{const a=await Ve();Ee(a)}catch(a){console.warn("Failed to fetch scheduler status:",a)}},[]);l.useEffect(()=>{pe.current||(pe.current=!0,D(),me())},[D,me]);const ge=l.useCallback(async()=>{try{const a=await He();if(Array.isArray(a)&&a.length>0){w(a);return}w(_)}catch(a){w(_),e.show(a.userMessage||a.message||"Failed to load templates","error")}},[_,e]);l.useEffect(()=>{he.current||(he.current=!0,ge())},[ge]),l.useEffect(()=>{n.length>0||_.length>0&&w(_)},[n.length,_]);const z=o.get("template"),Q=l.useMemo(()=>new Set(n.map(a=>a.id)),[n]),Te=z&&Q.has(z)?z:n[0]?.id||"",Me=B||S[0]?.id||"",Ae=n.length>0&&S.length>0;l.useEffect(()=>{if(!z)return;n.length>0&&!Q.has(z)&&e.show("Selected template is not approved for scheduling. Choose an approved template.","warning"),W(null),g(!0);const a=new URLSearchParams(o);a.delete("template"),v(a,{replace:!0})},[z,o,n,Q,v,e]);const Le=l.useCallback((a,s)=>{a.stopPropagation(),U(a.currentTarget),V(s)},[]),E=l.useCallback(()=>{U(null),V(null)},[]),xe=l.useCallback(()=>{if(n.length===0){e.show("No approved templates available. Approve a template first.","warning");return}if(S.length===0){e.show("No connections available. Add a connection first.","warning");return}W(null),g(!0)},[n.length,S.length,e]),_e=l.useCallback(()=>{W(p),g(!0),E()},[p,E]),ze=l.useCallback(()=>{A(p),x(!0),E()},[p,E]),H=l.useCallback(async(a,s)=>{a&&r({type:Y.UPDATE,label:`${s?"Enable":"Pause"} schedule "${a.name||a.id}"`,reversibility:K.FULLY_REVERSIBLE,successMessage:`Schedule ${s?"enabled":"paused"}`,errorMessage:"Failed to update schedule",action:async()=>{de(a.id);try{await be(a.id,{active:s}),await D()}finally{de(null)}}})},[D,r]),$e=l.useCallback(async()=>{if(!p)return;const s=!(p.active??p.enabled??!0);await H(p,s),E()},[p,E,H]),Fe=l.useCallback(async a=>{const s=!!M,c=await r({type:s?Y.UPDATE:Y.CREATE,label:s?`Update schedule "${a.name}"`:`Create schedule "${a.name}"`,reversibility:K.FULLY_REVERSIBLE,successMessage:s?"Schedule updated":"Schedule created",errorMessage:"Failed to save schedule",action:async()=>{s?await be(M.id,a):await Ye(a),await D()}});if(!c?.success)throw c?.error||new Error("Failed to save schedule")},[M,D,r]),Pe=l.useCallback(async()=>{if(!I)return;const a=I,s=F.findIndex(c=>c.id===a.id);x(!1),A(null),L.current?.timeoutId&&(clearTimeout(L.current.timeoutId),L.current=null),r({type:Y.DELETE,label:`Delete schedule "${a.name||a.id}"`,reversibility:K.PARTIALLY_REVERSIBLE,successMessage:"Schedule removed",errorMessage:"Failed to delete schedule",action:async()=>{k(y=>y.filter(h=>h.id!==a.id));let c=!1;const b=setTimeout(async()=>{if(!c)try{await Je(a.id),D()}catch(y){throw k(h=>{if(h.some(Z=>Z.id===a.id))return h;const j=[...h];return s>=0&&s<=j.length?j.splice(s,0,a):j.push(a),j}),y}finally{L.current=null}},5e3);L.current={timeoutId:b,schedule:a},e.showWithUndo(`Schedule "${a.name||a.id}" removed`,()=>{c=!0,clearTimeout(b),L.current=null,k(y=>{if(y.some(j=>j.id===a.id))return y;const h=[...y];return s>=0&&s<=h.length?h.splice(s,0,a):h.push(a),h}),e.show("Schedule restored","success")},{severity:"info"})}})},[I,F,D,r,e]),We=l.useMemo(()=>[{field:"name",headerName:"Schedule",renderCell:(a,s)=>t.jsxs(T,{children:[t.jsx(C,{variant:"body2",fontWeight:600,children:a||s.id}),t.jsx(C,{variant:"caption",color:"text.secondary",children:f.find(c=>c.id===s.template_id)?.name||s.template_name||s.template_id})]})},{field:"frequency",headerName:"Frequency",width:120,renderCell:a=>{const c=ie.find(b=>b.value===a)?.label||a||"daily";return t.jsx(Et,{label:c,size:"small"})}},{field:"enabled",headerName:"Status",width:140,renderCell:(a,s)=>{const c=s.active??a??!0;return t.jsxs(q,{direction:"row",alignItems:"center",spacing:1,children:[t.jsx(De,{size:"small",checked:c,disabled:ce===s.id,onChange:b=>{b.stopPropagation(),H(s,b.target.checked)}}),t.jsx(Rt,{label:c?"Active":"Paused",size:"small",active:c})]})}},{field:"last_run",headerName:"Last Run",width:180,renderCell:(a,s)=>{const c=a||s.last_run_at;return t.jsx(C,{variant:"body2",color:c?"text.primary":"text.secondary",children:c?new Date(c).toLocaleString():"Never"})}},{field:"next_run",headerName:"Next Run",width:180,renderCell:(a,s)=>{const c=s.active??s.enabled??!0,b=a||s.next_run_at;return t.jsx(C,{variant:"body2",color:c&&b?"text.primary":"text.secondary",children:c&&b?new Date(b).toLocaleString():"-"})}}],[f,H,ce]),qe=l.useMemo(()=>[{key:"frequency",label:"Frequency",options:ie},{key:"active",label:"Status",options:[{value:!0,label:"Active"},{value:!1,label:"Paused"}]}],[]),fe=p?.active??p?.enabled??!0,Be=()=>{if(!ue)return null;const{scheduler:a,schedules:s}=ue,c=a?.running,b=a?.enabled;let y=t.jsx(yt,{}),h="",j="warning";if(!b)y=t.jsx(Se,{}),h="Scheduler is disabled. Schedules will not run automatically.",j="disabled";else if(!c)y=t.jsx(Se,{}),h="Scheduler is not running. Restart the server to enable automatic scheduling.",j="warning";else if(y=t.jsx(st,{}),j="ok",s?.next_run){const Z=new Date(s.next_run.next_run_at).toLocaleString();h=`Scheduler running. Next: "${s.next_run.schedule_name}" at ${Z}`}else h=`Scheduler running (polling every ${a?.poll_interval_seconds||60}s). ${s?.active||0} active schedule(s).`;return t.jsxs(Mt,{status:j,children:[y,t.jsx(C,{variant:"body2",fontWeight:500,children:h})]})};return t.jsx(jt,{children:t.jsxs(gt,{maxWidth:"xl",children:[Be(),t.jsx(Qe,{severity:"info",sx:{mb:2,borderRadius:1},children:"Schedules create future report runs. Progress appears in Jobs and finished reports show up in History."}),t.jsx(ht,{title:"Scheduled Reports",subtitle:"Automate report generation on a schedule",columns:We,data:F,loading:N,searchPlaceholder:"Search schedules...",filters:qe,actions:[{label:"Create Schedule",icon:t.jsx(Xe,{}),variant:"contained",onClick:xe,disabled:!Ae}],rowActions:a=>t.jsx(Ze,{title:"More actions",arrow:!0,TransitionComponent:Ge,children:t.jsx(Ke,{size:"small",onClick:s=>Le(s,a),"aria-label":"More actions",children:t.jsx(xt,{})})}),emptyState:{icon:re,title:"No schedules yet",description:"Create a schedule to automatically generate reports on a recurring basis.",actionLabel:"Create Schedule",onAction:xe}}),t.jsxs(Tt,{anchorEl:O,open:!!O,onClose:E,TransitionComponent:Ie,children:[t.jsxs(le,{onClick:_e,children:[t.jsx(X,{children:t.jsx(et,{fontSize:"small"})}),t.jsx(ee,{children:"Edit"})]}),t.jsxs(le,{onClick:$e,children:[t.jsx(X,{children:fe?t.jsx(vt,{fontSize:"small"}):t.jsx(tt,{fontSize:"small"})}),t.jsx(ee,{children:fe?"Pause":"Enable"})]}),t.jsxs(le,{onClick:ze,sx:{color:"error.main"},children:[t.jsx(X,{children:t.jsx(at,{fontSize:"small",sx:{color:"text.secondary"}})}),t.jsx(ee,{children:"Delete"})]})]}),t.jsx(Ft,{open:R,onClose:()=>g(!1),schedule:M,templates:n,connections:S,defaultTemplateId:Te,defaultConnectionId:Me,onSave:Fe,onError:a=>e.show(a,"error")}),t.jsx(mt,{open:u,onClose:()=>x(!1),onConfirm:Pe,title:"Delete Schedule",message:`Remove "${I?.name||I?.id}"? You can undo within a few seconds. This stops future runs; past downloads remain in History.`,confirmLabel:"Delete",severity:"error"})]})})}function ea(){return ke(),t.jsx(Pt,{})}export{ea as default};
