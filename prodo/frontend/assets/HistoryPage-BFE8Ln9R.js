import{u as Ee,w as Te,Z as _e,v as Le,a as ce,r as a,R as N,I as O,l as Be,_ as Fe,$ as te,a0 as Ae,j as t,q as P,B as k,o as f,T as R,z as $e,C as se,E as He,a1 as oe,A as Ne,H as re,m as ae,S as ne,M as S,G as Oe,a2 as de,N as p,O as X,n as d,K as ue,f as c,J as Ue,a3 as We,a4 as Me,a5 as le,a6 as Xe,a7 as Ye,p as Ve,e as Ge}from"./index-COTlR4Mk.js";import{P as Ke}from"./Visibility-BrMHOUUu.js";import{P as pe}from"./PictureAsPdf-Bwg-ZKh2.js";import{A as Je}from"./Article-BsRQBd0_.js";import{D as qe}from"./DataTable-DCTRUeN1.js";import{C as Ze}from"./ConfirmModal-BKTCaXkL.js";import"./KeyboardArrowDown-CbAvUKjN.js";import"./FilterList-B2nv-Yj9.js";import"./Check-JruGOof3.js";import"./MoreVert-C6fI3_5K.js";import"./TableRow-9uVWzbJ3.js";import"./TableContainer-BGfNH4cD.js";import"./KeyboardArrowRight-C1lIa1Bi.js";import"./CheckCircleOutline-KPLvK3qz.js";import"./WarningAmber-Ua-LQj3f.js";const Qe=p(k)(({theme:s})=>({padding:s.spacing(3),maxWidth:1400,margin:"0 auto",width:"100%",minHeight:"100vh",backgroundColor:s.palette.background.default})),et=p(k)(({theme:s})=>({marginBottom:s.spacing(3),animation:`${X} 0.5s ease-out`})),tt=p(f)(({theme:s})=>({fontSize:"1.75rem",fontWeight:600,letterSpacing:"-0.02em",color:s.palette.mode==="dark"?d[100]:d[900]})),st=p(P)(({theme:s})=>({marginBottom:s.spacing(3),animation:`${X} 0.5s ease-out 0.1s both`})),ot=p(k)(({theme:s})=>({backgroundColor:c(s.palette.background.paper,.8),backdropFilter:"blur(20px)",borderRadius:8,border:`1px solid ${c(s.palette.divider,.1)}`,boxShadow:`0 8px 32px ${c(s.palette.common.black,.08)}`,overflow:"hidden",animation:`${X} 0.6s ease-out 0.2s both`})),ie=p(k)(({theme:s})=>({padding:s.spacing(8,4),textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center"})),rt=p(Ue)(({theme:s})=>({fontSize:64,color:c(s.palette.text.secondary,.3),marginBottom:s.spacing(2),animation:`${We} 3s ease-in-out infinite`})),at=p(ue)(({theme:s})=>({borderRadius:8,textTransform:"none",fontWeight:600,fontSize:"0.875rem",padding:s.spacing(1,2.5),background:s.palette.mode==="dark"?d[700]:d[900],color:s.palette.common.white,boxShadow:`0 4px 14px ${c(s.palette.common.black,.15)}`,transition:"all 0.2s cubic-bezier(0.22, 1, 0.36, 1)","&:hover":{background:s.palette.mode==="dark"?d[500]:d[700],boxShadow:`0 6px 20px ${c(s.palette.common.black,.2)}`,transform:"translateY(-2px)"}})),nt=p(ue)(({theme:s})=>({borderRadius:8,textTransform:"none",fontWeight:500,fontSize:"0.875rem",borderColor:c(s.palette.divider,.3),transition:"all 0.2s cubic-bezier(0.22, 1, 0.36, 1)","&:hover":{borderColor:s.palette.mode==="dark"?d[500]:d[700],backgroundColor:s.palette.mode==="dark"?c(s.palette.text.primary,.04):d[50]}})),lt=p(k,{shouldForwardProp:s=>s!=="iconColor"})(({theme:s})=>({width:36,height:36,borderRadius:8,backgroundColor:s.palette.mode==="dark"?c(s.palette.text.primary,.08):d[100],display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s cubic-bezier(0.22, 1, 0.36, 1)"})),it=p(Ve,{shouldForwardProp:s=>!["statusColor","statusBg"].includes(s)})(({theme:s,statusColor:m,statusBg:n})=>({borderRadius:8,fontWeight:600,fontSize:"12px",backgroundColor:n,color:m,"& .MuiChip-icon":{marginLeft:s.spacing(.5),color:m}})),U=p(Ge)(({theme:s})=>({transition:"all 0.2s cubic-bezier(0.22, 1, 0.36, 1)","&:hover":{transform:"translateY(-2px)"}})),ct=(s,m)=>{const n={completed:{icon:Ye,color:s.palette.text.secondary,bgColor:s.palette.mode==="dark"?c(s.palette.text.primary,.1):d[100],label:"Completed"},failed:{icon:Xe,color:s.palette.text.secondary,bgColor:s.palette.mode==="dark"?c(s.palette.text.primary,.1):d[100],label:"Failed"},running:{icon:le,color:s.palette.text.secondary,bgColor:s.palette.mode==="dark"?c(s.palette.text.primary,.1):d[100],label:"Running"},pending:{icon:le,color:s.palette.text.secondary,bgColor:s.palette.mode==="dark"?c(s.palette.text.primary,.08):d[50],label:"Pending"},cancelled:{icon:Me,color:s.palette.text.secondary,bgColor:c(s.palette.text.secondary,.08),label:"Cancelled"}};return n[m]||n.pending},dt=(s,m)=>{const n={pdf:{icon:pe,color:s.palette.text.secondary},excel:{icon:de,color:s.palette.text.secondary}};return n[m]||n.pdf};function ut(){const s=Ee(),m=Te(),[n,Y]=_e(),x=Le(),{execute:g}=ce(),z=a.useCallback((e,o,r={})=>m(e,{label:o,intent:{from:"history",...r}}),[m]),l=a.useCallback((e,o,r={})=>g({type:O.EXECUTE,label:e,reversibility:N.FULLY_REVERSIBLE,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{from:"history",...r},action:o}),[g]),E=a.useCallback((e,o,r={})=>g({type:O.DOWNLOAD,label:e,reversibility:N.FULLY_REVERSIBLE,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{from:"history",...r},action:o}),[g]),he=Be(e=>e.templates),W=a.useRef(!1),w=a.useRef(null),xe=n.get("status")||"",fe=n.get("template")||"",[D,T]=a.useState([]),[_,V]=a.useState(!0),[M,L]=a.useState(0),[B,F]=a.useState(0),[I,me]=a.useState(25),[y,G]=a.useState(xe),[b,K]=a.useState(fe),[C,J]=a.useState([]),[ge,A]=a.useState(!1),[ye,q]=a.useState(!1),j=a.useCallback(async()=>{V(!0);try{const e=await Fe({limit:I,offset:B*I,status:y||void 0,templateId:b||void 0});T(e?.history||[]),L(e?.total||0)}catch(e){x.show(e.message||"Failed to load report history","error")}finally{V(!1)}},[B,I,y,b,x]);a.useEffect(()=>{W.current||(W.current=!0,j())},[j]),a.useEffect(()=>{const e=n.get("status")||"",o=n.get("template")||"";e!==y&&G(e),o!==b&&K(o)},[n,y,b]),a.useEffect(()=>{W.current&&j()},[B,I,y,b,j]);const $=a.useCallback((e,o)=>{const r=new URLSearchParams(n);e?r.set("status",e):r.delete("status"),o?r.set("template",o):r.delete("template"),Y(r,{replace:!0})},[n,Y]),Z=a.useCallback((e,o)=>E("Download report output",()=>{const r=e.artifacts||{};let h=null;o==="pdf"&&r.pdf_url?h=r.pdf_url:o==="html"&&r.html_url?h=r.html_url:o==="docx"&&r.docx_url?h=r.docx_url:o==="xlsx"&&r.xlsx_url&&(h=r.xlsx_url),h?window.open(te(h),"_blank"):x.show("Download not available","warning")},{reportId:e?.id,format:o}),[E,x]),H=a.useCallback((e,o,r)=>{e.stopPropagation(),Z(o,r)},[Z]),be=a.useCallback(e=>{const o=e.artifacts||{};if(o.html_url||o.pdf_url){const r=o.html_url||o.pdf_url;return E("Open report output",()=>{window.open(te(r),"_blank")},{reportId:e?.id,format:o.html_url?"html":"pdf"})}return z("/jobs","Open jobs",{reportId:e?.id})},[E,z]),Ce=a.useCallback(async()=>{if(!C.length)return;const e=[...C],o=D.filter(i=>e.includes(i.id)),r=D,h=M;if(!o.length){A(!1);return}A(!1),J([]),w.current?.timeoutId&&(clearTimeout(w.current.timeoutId),w.current=null),T(i=>i.filter(v=>!e.includes(v.id))),L(i=>Math.max(0,i-o.length));let u=!1;const Q=setTimeout(async()=>{u||await g({type:O.DELETE,label:"Delete history records",reversibility:N.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{jobIds:e,action:"bulk_delete_history"},action:async()=>{q(!0);try{const i=await Ae(e),v=i?.deletedCount??i?.deleted?.length??0,ee=i?.failedCount??i?.failed?.length??0;return ee>0?x.show(`Removed ${v} record${v!==1?"s":""}, ${ee} failed`,"warning"):x.show(`Removed ${v} history record${v!==1?"s":""}`,"success"),j(),i}catch(i){throw T(r),L(h),x.show(i.message||"Failed to delete history records","error"),i}finally{q(!1),w.current=null}}})},5e3);w.current={timeoutId:Q,ids:e,records:o},x.showWithUndo(`Removed ${e.length} history record${e.length!==1?"s":""}`,()=>{u=!0,clearTimeout(Q),w.current=null,T(r),L(h),x.show("History restored","success")},{severity:"info"})},[C,D,M,x,j,g]),je=a.useCallback(()=>{if(C.length)return l("Review delete history",()=>A(!0),{count:C.length})},[l,C]),Se=a.useCallback(()=>l("Close delete history",()=>A(!1)),[l]),ke=a.useCallback(e=>l("Select history entries",()=>J(e),{count:e.length}),[l]),we=a.useCallback(e=>l("Filter history by status",()=>{G(e),F(0),$(e,b)},{status:e}),[l,$,b]),De=a.useCallback(e=>l("Filter history by template",()=>{K(e),F(0),$(y,e)},{templateId:e}),[l,$,y]),ve=a.useCallback(()=>g({type:O.EXECUTE,label:"Refresh history",reversibility:N.FULLY_REVERSIBLE,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{from:"history",action:"refresh_history"},action:async()=>{await j()}}),[g,j]),Ie=a.useCallback(e=>l("Change history page",()=>F(e),{page:e}),[l]),Re=a.useCallback(e=>l("Change history page size",()=>{me(e),F(0)},{rowsPerPage:e}),[l]),Pe=[{label:"Delete Selected",icon:t.jsx(Oe,{sx:{fontSize:16}}),color:"error",onClick:je}],ze=[{field:"templateName",headerName:"Design",renderCell:(e,o)=>{const r=o.templateKind||"pdf",u=dt(s,r).icon;return t.jsxs(P,{direction:"row",alignItems:"center",spacing:1.5,children:[t.jsx(lt,{children:t.jsx(u,{sx:{fontSize:18,color:"text.secondary"}})}),t.jsxs(k,{children:[t.jsx(f,{sx:{fontSize:"14px",fontWeight:500,color:"text.primary"},children:e||"Unknown"}),t.jsx(f,{sx:{fontSize:"12px",color:"text.secondary"},children:r.toUpperCase()})]})]})}},{field:"status",headerName:"Status",width:130,renderCell:e=>{const o=ct(s,e),r=o.icon;return t.jsx(it,{icon:t.jsx(r,{sx:{fontSize:14}}),label:o.label,size:"small",statusColor:o.color,statusBg:o.bgColor})}},{field:"createdAt",headerName:"Started",width:160,renderCell:e=>t.jsx(f,{sx:{fontSize:"14px",color:"text.secondary"},children:e?new Date(e).toLocaleString():"-"})},{field:"completedAt",headerName:"Completed",width:160,renderCell:e=>t.jsx(f,{sx:{fontSize:"14px",color:"text.secondary"},children:e?new Date(e).toLocaleString():"-"})},{field:"artifacts",headerName:"Downloads",width:150,renderCell:(e,o)=>{const r=e||{};return r.pdf_url||r.html_url||r.docx_url||r.xlsx_url?t.jsxs(P,{direction:"row",spacing:.5,children:[r.pdf_url&&t.jsx(R,{title:"Download PDF",children:t.jsx(U,{size:"small",onClick:u=>H(u,o,"pdf"),sx:{color:"text.secondary"},"aria-label":"Download PDF",children:t.jsx(pe,{sx:{fontSize:18}})})}),r.html_url&&t.jsx(R,{title:"View HTML",children:t.jsx(U,{size:"small",onClick:u=>H(u,o,"html"),sx:{color:"text.secondary"},"aria-label":"View HTML",children:t.jsx(Ke,{sx:{fontSize:18}})})}),r.docx_url&&t.jsx(R,{title:"Download DOCX",children:t.jsx(U,{size:"small",onClick:u=>H(u,o,"docx"),sx:{color:"text.secondary"},"aria-label":"Download DOCX",children:t.jsx(Je,{sx:{fontSize:18}})})}),r.xlsx_url&&t.jsx(R,{title:"Download XLSX",children:t.jsx(U,{size:"small",onClick:u=>H(u,o,"xlsx"),sx:{color:"text.secondary"},"aria-label":"Download XLSX",children:t.jsx(de,{sx:{fontSize:18}})})})]}):t.jsx(f,{sx:{fontSize:"0.75rem",color:"text.disabled"},children:o.status==="completed"?"No files":"-"})}}];return t.jsxs(Qe,{children:[t.jsx(et,{children:t.jsxs(P,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[t.jsxs(k,{children:[t.jsx(tt,{children:"Report History"}),t.jsx(f,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:"View and download previously generated reports"})]}),t.jsxs(P,{direction:"row",spacing:1.5,children:[t.jsx(R,{title:"Refresh history",children:t.jsx("span",{children:t.jsx($e,{onClick:ve,disabled:_,"aria-label":"Refresh history",children:_?t.jsx(se,{size:20}):t.jsx(He,{})})})}),t.jsx(at,{onClick:()=>z("/reports","Open reports"),startIcon:t.jsx(oe,{}),children:"Generate New"})]})]})}),t.jsx(Ne,{severity:"info",sx:{mb:2,borderRadius:1},children:"History lists completed report outputs. Deleting a history record only removes the entry here; downloaded files are not affected."}),t.jsxs(st,{direction:"row",spacing:2,children:[t.jsxs(re,{size:"small",children:[t.jsx(ae,{children:"Status"}),t.jsxs(ne,{value:y,onChange:e=>{const o=e.target.value;we(o)},label:"Status",children:[t.jsx(S,{value:"",children:"All"}),t.jsx(S,{value:"completed",children:"Completed"}),t.jsx(S,{value:"failed",children:"Failed"}),t.jsx(S,{value:"running",children:"Running"}),t.jsx(S,{value:"cancelled",children:"Cancelled"})]})]}),t.jsxs(re,{size:"small",sx:{minWidth:200},children:[t.jsx(ae,{children:"Design"}),t.jsxs(ne,{value:b,onChange:e=>{const o=e.target.value;De(o)},label:"Design",children:[t.jsx(S,{value:"",children:"All Designs"}),he.map(e=>t.jsx(S,{value:e.id,children:e.name||e.id.slice(0,12)},e.id))]})]})]}),t.jsx(ot,{children:_&&D.length===0?t.jsxs(ie,{children:[t.jsx(se,{size:40}),t.jsx(f,{sx:{mt:2,fontSize:"0.875rem",color:"text.secondary"},children:"Loading history..."})]}):D.length===0?t.jsxs(ie,{children:[t.jsx(rt,{}),t.jsx(f,{sx:{fontSize:"1rem",fontWeight:600,color:"text.secondary"},children:"No report history found"}),t.jsx(f,{sx:{fontSize:"0.875rem",color:"text.disabled",mt:.5},children:"Generate reports to see them here"}),t.jsx(nt,{variant:"outlined",onClick:()=>z("/reports","Open reports"),sx:{mt:3},startIcon:t.jsx(oe,{}),children:"Generate Report"})]}):t.jsx(qe,{columns:ze,data:D,loading:_,searchPlaceholder:"Search reports...",onRowClick:be,selectable:!0,onSelectionChange:ke,bulkActions:Pe,pagination:{page:B,rowsPerPage:I,total:M,onPageChange:Ie,onRowsPerPageChange:Re}})}),t.jsx(Ze,{open:ge,onClose:Se,onConfirm:Ce,title:"Delete History Records",message:`Remove ${C.length} history record${C.length!==1?"s":""}? You can undo within a few seconds. Downloaded files are not affected.`,confirmLabel:"Delete",severity:"error",loading:ye})]})}function It(){return ce(),t.jsx(ut,{})}export{It as default};
