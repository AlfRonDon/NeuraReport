import{g as Me,j as e,i as g,bN as Oe,a as pe,r as d,Z as Le,B as l,ci as ae,o as u,C as k,K as f,a1 as Fe,A as T,P as I,aJ as M,b3 as Be,p as Y,n as ne,f as ie,e as ce,G as oe,aY as He,T as Ge,E as We,aZ as $e,ak as Ye,ah as Je,aj as Ke,al as Ue,F as Ze,m as qe,S as Ve,M as Qe,am as Xe,R as A,I as N}from"./index-COTlR4Mk.js";import{u as es}from"./useSharedData-CmfHiy_j.js";import{C as ss}from"./ConnectionSelector-DIWHs3I4.js";import{C as le}from"./ConfirmModal-BKTCaXkL.js";import{A as rs}from"./AiUsageNotice-D5uMWf9C.js";import{u as ts,F as O,T as as,O as ue}from"./useCrossPageActions-B2ZCWXOL.js";import{u as ns,I as is}from"./ImportFromMenu-ClSHoFCE.js";import{S as cs}from"./SendToMenu-BMkSDk7u.js";import{T as os,a as de}from"./Tabs-BjIVdfAN.js";import{G as y}from"./Grid-BMfuCMsI.js";import{C as ls}from"./CardContent-Cdyni_Bl.js";import{P as us}from"./Preview-EgZOPd84.js";import{T as ds}from"./TableContainer-BGfNH4cD.js";import{T as hs,a as ms,b as he,c as me,d as ps}from"./TableRow-9uVWzbJ3.js";import"./CheckCircleOutline-KPLvK3qz.js";import"./WarningAmber-Ua-LQj3f.js";import"./SummarizeRounded-DKHAHydN.js";import"./KeyboardArrowRight-C1lIa1Bi.js";const xs=Me(e.jsx("path",{d:"m19 8-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4z"}));async function fs(){return(await g.get("/enrichment/sources")).data}async function ys({data:t,sources:h,sampleSize:r=5}){return(await g.post("/enrichment/preview",{data:t,sources:h,sample_size:r})).data}async function gs({data:t,sources:h,options:r={}}){return(await g.post("/enrichment/enrich",{data:t,sources:h,options:r})).data}async function js({name:t,type:h,description:r,config:i={},cacheTtlHours:c=24}){return(await g.post("/enrichment/sources/create",{name:t,type:h,description:r,config:i,cache_ttl_hours:c})).data}async function Cs(t){return(await g.delete(`/enrichment/sources/${t}`)).data}async function bs(){return(await g.get("/enrichment/cache/stats")).data}async function Ss(t=null){const h=t?`?source_id=${t}`:"";return(await g.delete(`/enrichment/cache${h}`)).data}const ws=Oe((t,h)=>({sources:[],customSources:[],cacheStats:null,previewResult:null,enrichmentResult:null,loading:!1,error:null,setLoading:r=>t({loading:r}),setError:r=>t({error:r}),fetchSources:async()=>{t({loading:!0,error:null});try{const r=await fs(),i=Array.isArray(r.sources)?r.sources:[],c=[],o=[];i.forEach(p=>{!!(p?.created_at||p?.updated_at||p?.cache_ttl_hours!==void 0||p?.config)?o.push(p):c.push(p)}),t({sources:c,customSources:o,loading:!1})}catch(r){t({error:r.message,loading:!1})}},createSource:async({name:r,type:i,description:c,config:o,cacheTtlHours:p})=>{t({loading:!0,error:null});try{const C=(await js({name:r,type:i,description:c,config:o,cacheTtlHours:p})).source;return t(L=>({customSources:[...L.customSources.filter(b=>b.id!==C.id),C].slice(0,200),loading:!1})),C}catch(j){return t({error:j.message,loading:!1}),null}},deleteSource:async r=>{t({loading:!0,error:null});try{return await Cs(r),t(i=>({customSources:i.customSources.filter(c=>c.id!==r),sources:i.sources.filter(c=>c.id!==r),loading:!1})),!0}catch(i){return t({error:i.message,loading:!1}),!1}},fetchCacheStats:async()=>{try{const r=await bs();return t({cacheStats:r.stats}),r.stats}catch(r){return t({error:r.message}),null}},clearCache:async(r=null)=>{t({loading:!0,error:null});try{const i=await Ss(r);return await h().fetchCacheStats(),t({loading:!1}),i.cleared_entries}catch(i){return t({error:i.message,loading:!1}),null}},previewEnrichment:async(r,i,c=5)=>{t({loading:!0,error:null,previewResult:null});try{const o=await ys({data:r,sources:i,sampleSize:c});return t({previewResult:o,loading:!1}),o}catch(o){return t({error:o.message,loading:!1}),null}},enrichData:async(r,i,c={})=>{t({loading:!0,error:null,enrichmentResult:null});try{const o=await gs({data:r,sources:i,options:c});return t({enrichmentResult:o,loading:!1}),o}catch(o){return t({error:o.message,loading:!1}),null}},reset:()=>t({previewResult:null,enrichmentResult:null,error:null})})),vs=[{id:"company",name:"Company Information",description:"Enrich with company details (industry, size, revenue)"},{id:"address",name:"Address Standardization",description:"Standardize and validate addresses"},{id:"exchange",name:"Currency Exchange",description:"Convert currencies to target currency"}],Es=[{value:"company_info",label:"Company Information"},{value:"address",label:"Address Standardization"},{value:"exchange_rate",label:"Currency Exchange"}];function Ts(){const{sources:t,customSources:h,cacheStats:r,previewResult:i,enrichmentResult:c,loading:o,error:p,fetchSources:j,createSource:C,deleteSource:L,fetchCacheStats:b,clearCache:xe,previewEnrichment:fe,enrichData:ye,reset:F}=ws(),{execute:S}=pe(),{registerOutput:ge}=ts(O.ENRICHMENT);ns(O.ENRICHMENT,{[as.ENRICH]:async s=>{const a=s.data?.rows||s.data;Array.isArray(a)&&(v(a),H(JSON.stringify(a,null,2)))}});const{activeConnectionId:je}=es(),[J,Ce]=d.useState(je||""),[be,K]=Le(),B=be.get("tab")==="cache"?1:0,[U,Z]=d.useState(!0),Se=d.useCallback((s,a)=>{K(a===1?{tab:"cache"}:{},{replace:!0})},[K]),[w,H]=d.useState(""),[m,we]=d.useState([]),[x,v]=d.useState(null),[ve,D]=d.useState(!1),[_,q]=d.useState(""),[G,V]=d.useState("company_info"),[Q,X]=d.useState(""),[ee,se]=d.useState(24),[R,W]=d.useState({open:!1,sourceId:null,sourceName:""}),[P,z]=d.useState({open:!1,sourceId:null,sourceName:""});d.useEffect(()=>((async()=>(Z(!0),await Promise.all([j(),b()]),Z(!1)))(),()=>F()),[j,b,F]);const Ee=d.useCallback(()=>{try{const s=JSON.parse(w);Array.isArray(s)?v(s):v([s])}catch{const a=w.trim().split(`
`);if(a.length>1){const n=a[0].split(",").map($=>$.trim()),E=a.slice(1).map($=>{const Pe=$.split(","),te={};return n.forEach((ze,ke)=>{te[ze]=Pe[ke]?.trim()||""}),te});v(E)}}},[w]),Te=async()=>{!x||m.length===0||await S({type:N.ANALYZE,label:"Preview enrichment",reversibility:A.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{sourceIds:m,action:"preview_enrichment"},action:async()=>{const s=await fe(x,m,3);if(!s)throw new Error("Preview enrichment failed");return s}})},Ie=async()=>{!x||m.length===0||await S({type:N.GENERATE,label:"Enrich data",reversibility:A.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{sourceIds:m,action:"enrich_data"},action:async()=>{const s=await ye(x,m);if(!s)throw new Error("Enrichment failed");const a=s.enriched_data||[],n=a.length>0?Object.keys(a[0]).map(E=>({name:E})):[];return ge({type:ue.TABLE,title:`Enriched Data (${a.length} rows)`,summary:`Enriched with ${m.length} source(s)`,data:{columns:n,rows:a},format:"table"}),s}})},Ae=s=>{we(a=>a.includes(s)?a.filter(n=>n!==s):[...a,s])},Ne=async()=>{_.trim()&&await S({type:N.CREATE,label:"Create enrichment source",reversibility:A.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{sourceType:G,action:"create_enrichment_source"},action:async()=>{const s=await C({name:_,type:G,description:Q,config:{},cacheTtlHours:ee});if(s&&(D(!1),q(""),V("company_info"),X(""),se(24)),!s)throw new Error("Create source failed");return s}})},De=async()=>{const s=R.sourceId,a=R.sourceName;W({open:!1,sourceId:null,sourceName:""}),s&&await S({type:N.DELETE,label:"Delete enrichment source",reversibility:A.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{sourceId:s,sourceName:a,action:"delete_enrichment_source"},action:async()=>{const n=await L(s);if(!n)throw new Error("Delete source failed");return n}})},_e=async()=>{const s=P.sourceId||null,a=P.sourceName;z({open:!1,sourceId:null,sourceName:""}),await S({type:N.DELETE,label:"Clear enrichment cache",reversibility:A.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{sourceId:s,sourceName:a,action:"clear_enrichment_cache"},action:async()=>{const n=await xe(s);if(n==null)throw new Error("Clear cache failed");return n}})},Re=t.length===0&&!U,re=[...t.length>0?t:vs,...h];return U?e.jsxs(l,{sx:{p:3,maxWidth:1400,mx:"auto"},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[e.jsx(ae,{}),e.jsx(u,{variant:"h5",children:"Data Enrichment"})]}),e.jsx(l,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:300},children:e.jsx(k,{})})]}):e.jsxs(l,{sx:{p:3,maxWidth:1400,mx:"auto"},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(l,{children:[e.jsxs(u,{variant:"h5",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ae,{})," Data Enrichment"]}),e.jsx(u,{variant:"body1",color:"text.secondary",children:"Enrich your data with external information sources using AI"})]}),e.jsx(f,{variant:"outlined",startIcon:e.jsx(Fe,{}),onClick:()=>D(!0),children:"Add Custom Source"})]}),p&&e.jsx(T,{severity:"error",sx:{mb:2},onClose:()=>F(),children:p}),e.jsx(rs,{title:"AI enrichment",description:"Enrichment adds fields to a new output based on the sources you select. Preview before running.",chips:[{label:"Source: Input data",color:"info",variant:"outlined"},{label:"Confidence: Review results",color:"warning",variant:"outlined"},{label:"Original data unchanged",color:"success",variant:"outlined"}],dense:!0,sx:{mb:2}}),Re&&e.jsx(T,{severity:"info",sx:{mb:2},children:"Using default enrichment sources. Create custom sources below to configure specific enrichment behavior."}),e.jsxs(os,{value:B,onChange:Se,sx:{mb:3},children:[e.jsx(de,{label:"Enrich Data"}),e.jsx(de,{label:"Cache Admin",icon:e.jsx(xs,{}),iconPosition:"start"})]}),B===0&&e.jsxs(y,{container:!0,spacing:3,children:[e.jsx(y,{size:{xs:12,md:6},children:e.jsxs(I,{sx:{p:3,height:"100%"},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1},children:[e.jsx(u,{variant:"h6",children:"Input Data"}),e.jsx(is,{currentFeature:O.ENRICHMENT,onImport:s=>{const a=s.data?.rows||s.data;Array.isArray(a)&&(v(a),H(JSON.stringify(a,null,2)))},size:"small"})]}),e.jsx(ss,{value:J,onChange:Ce,label:"Data Source (Optional)",size:"small",showStatus:!0,sx:{mb:2}}),J&&e.jsx(T,{severity:"info",sx:{mb:2},children:"Data will be pulled from the selected database connection"}),e.jsx(M,{fullWidth:!0,multiline:!0,rows:10,placeholder:`Paste JSON array or CSV data:

[
  {"name": "Acme Corp", "address": "123 Main St"},
  {"name": "Tech Inc", "address": "456 Oak Ave"}
]

Or CSV:
name,address
Acme Corp,123 Main St
Tech Inc,456 Oak Ave`,value:w,onChange:s=>H(s.target.value),sx:{mb:2,fontFamily:"monospace"}}),e.jsx(f,{variant:"outlined",onClick:Ee,disabled:!w.trim(),children:"Parse Data"}),x&&e.jsxs(T,{severity:"success",sx:{mt:2},children:["Parsed ",x.length," records with columns: ",Object.keys(x[0]||{}).join(", ")]})]})}),e.jsx(y,{size:{xs:12,md:6},children:e.jsxs(I,{sx:{p:3,height:"100%"},children:[e.jsx(u,{variant:"h6",gutterBottom:!0,children:"Enrichment Sources"}),e.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:re.map(s=>{const a=h.some(n=>n.id===s.id);return e.jsx(Be,{variant:"outlined",sx:{cursor:"pointer",borderColor:m.includes(s.id)?"text.secondary":"divider",bgcolor:m.includes(s.id)?"action.selected":"background.paper"},onClick:()=>Ae(s.id),children:e.jsx(ls,{sx:{py:1.5,"&:last-child":{pb:1.5}},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(l,{children:[e.jsx(u,{variant:"subtitle1",children:s.name}),e.jsx(u,{variant:"body2",color:"text.secondary",children:s.description})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[a?e.jsx(Y,{label:"Custom",size:"small",sx:{bgcolor:n=>n.palette.mode==="dark"?ie(n.palette.text.primary,.1):ne[200],color:"text.secondary"}}):e.jsx(Y,{label:"Built-in",size:"small",variant:"outlined"}),m.includes(s.id)&&e.jsx(Y,{label:"Selected",size:"small",sx:{bgcolor:n=>n.palette.mode==="dark"?ie(n.palette.text.primary,.1):ne[200],color:"text.secondary"}}),a&&e.jsx(ce,{size:"small",onClick:n=>{n.stopPropagation(),W({open:!0,sourceId:s.id,sourceName:s.name})},children:e.jsx(oe,{fontSize:"small"})})]})]})})},s.id)})}),e.jsxs(l,{sx:{mt:3,display:"flex",gap:2},children:[e.jsx(f,{variant:"outlined",startIcon:o?e.jsx(k,{size:20}):e.jsx(us,{}),onClick:Te,disabled:!x||m.length===0||o,children:"Preview"}),e.jsx(f,{variant:"contained",startIcon:o?e.jsx(k,{size:20}):e.jsx(He,{}),onClick:Ie,disabled:!x||m.length===0||o,children:"Enrich All"})]})]})}),(i||c)&&e.jsx(y,{size:12,children:e.jsxs(I,{sx:{p:3},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1},children:[e.jsx(u,{variant:"h6",children:c?"Enrichment Results":"Preview Results"}),c&&e.jsx(cs,{outputType:ue.TABLE,payload:{title:`Enriched Data (${c.enriched_data?.length||0} rows)`,content:JSON.stringify(c.enriched_data),data:{columns:Object.keys(c.enriched_data?.[0]||{}).map(s=>({name:s})),rows:c.enriched_data||[]}},sourceFeature:O.ENRICHMENT})]}),e.jsx(ds,{sx:{maxHeight:400},children:e.jsxs(hs,{stickyHeader:!0,size:"small",children:[e.jsx(ms,{children:e.jsx(he,{children:Object.keys((c?.enriched_data||i?.preview)?.[0]||{}).map(s=>e.jsx(me,{children:s},s))})}),e.jsx(ps,{children:(c?.enriched_data||i?.preview||[]).map((s,a)=>e.jsx(he,{children:Object.values(s).map((n,E)=>e.jsx(me,{children:typeof n=="object"?JSON.stringify(n):String(n)},E))},a))})]})})]})})]}),B===1&&e.jsxs(y,{container:!0,spacing:3,children:[e.jsx(y,{size:{xs:12,md:6},children:e.jsxs(I,{sx:{p:3},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(u,{variant:"h6",children:"Cache Statistics"}),e.jsx(Ge,{title:"Refresh cache stats",children:e.jsx(ce,{onClick:b,size:"small","aria-label":"Refresh cache stats",children:e.jsx(We,{})})})]}),r?e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(l,{children:[e.jsx(u,{variant:"body2",color:"text.secondary",children:"Total Entries"}),e.jsx(u,{variant:"h4",children:r.total_entries||0})]}),e.jsxs(l,{children:[e.jsx(u,{variant:"body2",color:"text.secondary",children:"Hit Rate"}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx($e,{variant:"determinate",value:(r.hit_rate||0)*100,sx:{flex:1,height:10,borderRadius:1}}),e.jsxs(u,{variant:"body1",children:[((r.hit_rate||0)*100).toFixed(1),"%"]})]})]}),e.jsxs(l,{children:[e.jsx(u,{variant:"body2",color:"text.secondary",children:"Cache Hits / Misses"}),e.jsxs(u,{variant:"body1",children:[r.hits||0," hits / ",r.misses||0," misses"]})]}),r.size_bytes&&e.jsxs(l,{children:[e.jsx(u,{variant:"body2",color:"text.secondary",children:"Cache Size"}),e.jsxs(u,{variant:"body1",children:[(r.size_bytes/1024).toFixed(2)," KB"]})]})]}):e.jsx(u,{color:"text.secondary",children:"No cache stats available"})]})}),e.jsx(y,{size:{xs:12,md:6},children:e.jsxs(I,{sx:{p:3},children:[e.jsx(u,{variant:"h6",gutterBottom:!0,children:"Cache Management"}),e.jsx(T,{severity:"info",sx:{mb:3},children:"Clearing the cache will remove all cached enrichment results. New enrichment requests will fetch fresh data from sources."}),e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(f,{variant:"outlined",startIcon:o?e.jsx(k,{size:20}):e.jsx(oe,{}),onClick:()=>z({open:!0,sourceId:null,sourceName:"all sources"}),disabled:o,sx:{color:"text.secondary",borderColor:"divider"},children:"Clear All Cache"}),e.jsx(Ye,{sx:{my:1}}),e.jsx(u,{variant:"subtitle2",color:"text.secondary",children:"Clear cache for specific source:"}),re.map(s=>e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(u,{variant:"body2",children:s.name}),e.jsx(f,{size:"small",onClick:()=>z({open:!0,sourceId:s.id,sourceName:s.name}),disabled:o,children:"Clear"})]},s.id))]})]})})]}),e.jsxs(Je,{open:ve,onClose:()=>D(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ke,{children:"Create Custom Enrichment Source"}),e.jsxs(Ue,{children:[e.jsx(M,{fullWidth:!0,label:"Source Name",value:_,onChange:s=>q(s.target.value),sx:{mt:2,mb:2}}),e.jsxs(Ze,{fullWidth:!0,sx:{mb:2},children:[e.jsx(qe,{children:"Source Type"}),e.jsx(Ve,{value:G,label:"Source Type",onChange:s=>V(s.target.value),children:Es.map(s=>e.jsx(Qe,{value:s.value,children:s.label},s.value))})]}),e.jsx(M,{fullWidth:!0,label:"Description",value:Q,onChange:s=>X(s.target.value),multiline:!0,rows:2,sx:{mb:2}}),e.jsx(M,{fullWidth:!0,label:"Cache TTL (hours)",type:"number",value:ee,onChange:s=>se(parseInt(s.target.value)||24),inputProps:{min:1,max:720}})]}),e.jsxs(Xe,{children:[e.jsx(f,{onClick:()=>D(!1),children:"Cancel"}),e.jsx(f,{variant:"contained",onClick:Ne,disabled:!_.trim()||o,children:"Create"})]})]}),e.jsx(le,{open:R.open,onClose:()=>W({open:!1,sourceId:null,sourceName:""}),onConfirm:De,title:"Delete Source",message:`Are you sure you want to delete "${R.sourceName}"? This will remove the source configuration and all associated cache data.`,confirmLabel:"Delete",severity:"error"}),e.jsx(le,{open:P.open,onClose:()=>z({open:!1,sourceId:null,sourceName:""}),onConfirm:_e,title:"Clear Cache",message:`Are you sure you want to clear cache for ${P.sourceName}? New enrichment requests will fetch fresh data from the source.`,confirmLabel:"Clear Cache",severity:"warning"})]})}function Ks(){return pe(),e.jsx(Ts,{})}export{Ks as default};
