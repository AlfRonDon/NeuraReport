import{l as q,r as c,bW as xe,bl as pe,bm as fe,i as S,bN as ge,ch as ye,a as se,R as E,I as z,j as e,B as m,cj as H,o as h,C as W,K as I,a1 as je,A as Z,P as Q,bP as be,bQ as Se,aT as Ce,t as F,aU as we,T as ve,e as Ee,G as Ie,s as Ae,p as A,b3 as ee,n as M,f as J,ak as ke,aJ as P,aY as De,ah as Te,aj as Re,al as Ne,am as _e}from"./index-DeRHNZar.js";import{C as Le}from"./ConfirmModal-BHWqBz2Z.js";import{g as qe}from"./sqlSafety-CLxawa7_.js";import{A as ze}from"./AiUsageNotice-BgIrRfUH.js";import{u as Fe,F as Oe,O as Be}from"./useCrossPageActions-BCB3hlt6.js";import{G as k}from"./Grid-C8zRHJnX.js";import{C as te}from"./CardContent-B7RWOLhy.js";import{U as We}from"./Link-_rBKu0oG.js";import"./CheckCircleOutline-BoLve1SG.js";import"./WarningAmber-Bt52ndVT.js";const V=a=>Array.isArray(a)?a:[];function Qe(){const a=q(i=>i.savedConnections),n=q(i=>i.setSavedConnections),t=q(i=>i.updateSavedConnection),o=q(i=>i.removeSavedConnection),[r,d]=c.useState(!1),[C,x]=c.useState(null),j=c.useMemo(()=>V(a),[a]),D=c.useCallback(i=>{const l=typeof i=="function"?i(a):i;n(V(l))},[a,n]),w=c.useCallback(async()=>{d(!0),x(null);try{const i=await xe(),l=V(i?.connections);return n(l),d(!1),l}catch(i){return x(i.message||"Failed to load connections"),d(!1),[]}},[n]),T=c.useCallback(async i=>{try{const l=await pe(i);return t(i,{lastLatencyMs:l.latency_ms,status:"connected"}),l}catch(l){throw t(i,{status:"error"}),l}},[t]),b=c.useCallback(async i=>{d(!0),x(null);try{return await fe(i),o(i),d(!1),!0}catch(l){return x(l.message||"Failed to delete connection"),d(!1),!1}},[o]),R=c.useCallback(i=>j.find(l=>l.id===i)||null,[j]),v=c.useCallback(()=>{n([]),x(null)},[n]);return c.useMemo(()=>({connections:j,loading:r,error:C,setConnections:D,setLoading:d,setError:x,fetchConnections:w,healthCheck:T,removeConnection:b,getConnection:R,reset:v}),[j,r,C,D,d,x,w,T,b,R,v])}function ae(a,n=[]){if(Array.isArray(a))return a;if(!a||typeof a!="object")return[];for(const t of n)if(Array.isArray(a[t]))return a[t];return[]}async function Me({name:a,connectionIds:n,description:t}){return(await S.post("/federation/schemas",{name:a,connection_ids:n,description:t})).data}async function Je({limit:a,offset:n}={}){const t={};a!=null&&(t.limit=a),n!=null&&(t.offset=n);const r=(await S.get("/federation/schemas",{params:t})).data;if(Array.isArray(r))return{schemas:r,total:r.length};if(r&&typeof r=="object"){const d=ae(r,["schemas","items","results"]);return{...r,schemas:d,total:r.total??d.length}}return{schemas:[],total:0}}async function Pe(a){const t=(await S.get(`/federation/schemas/${a}`)).data;return t&&typeof t=="object"&&t.schema?t:t&&typeof t=="object"?{status:"ok",schema:t}:{status:"ok",schema:null}}async function Ve(a){const t=(await S.post("/federation/suggest-joins",{connection_ids:a})).data;return Array.isArray(t)?{suggestions:t}:t&&typeof t=="object"?{...t,suggestions:ae(t,["suggestions","joins"])}:{suggestions:[]}}async function $e({schemaId:a,query:n,limit:t=100}){const r=(await S.post("/federation/query",{virtual_schema_id:a,sql:n,limit:t})).data;return r&&typeof r=="object"&&Object.prototype.hasOwnProperty.call(r,"result")?r:{status:"ok",result:r}}async function Ue(a){return(await S.delete(`/federation/schemas/${a}`)).data}const Ge=ge((a,n)=>({schemas:[],currentSchema:null,joinSuggestions:[],queryResult:null,loading:!1,error:null,setLoading:t=>a({loading:t}),setError:t=>a({error:t}),fetchSchemas:async()=>{a({loading:!0,error:null});try{const t=await Je();a({schemas:t.schemas||[],loading:!1})}catch(t){a({error:t.message,loading:!1})}},createSchema:async t=>{a({loading:!0,error:null});try{const r=(await Me(t)).schema;return a(d=>({schemas:[...d.schemas,r].slice(0,200),currentSchema:r,loading:!1})),r}catch(o){return a({error:o.message,loading:!1}),null}},deleteSchema:async t=>{a({loading:!0,error:null});try{return await Ue(t),a(o=>({schemas:o.schemas.filter(r=>r.id!==t),currentSchema:o.currentSchema?.id===t?null:o.currentSchema,loading:!1})),!0}catch(o){return a({error:o.message,loading:!1}),!1}},suggestJoins:async()=>{const{currentSchema:t}=n();if(!t?.connections||t.connections.length<2)return a({error:"Need at least 2 connections to suggest joins",loading:!1}),[];a({loading:!0,error:null});try{const o=await Ve(t.connections);return a({joinSuggestions:o.suggestions||[],loading:!1}),o.suggestions}catch(o){return a({error:o.message,loading:!1}),[]}},executeQuery:async(t,o)=>{a({loading:!0,error:null,queryResult:null});try{const r=await $e({schemaId:t,query:o});return a({queryResult:r.result,loading:!1}),r.result}catch(r){return a({error:r.message,loading:!1}),null}},getSchema:async t=>{a({loading:!0,error:null});try{const o=await Pe(t);return a({currentSchema:o.schema||o,loading:!1}),o}catch(o){return a({error:o.message,loading:!1}),null}},setCurrentSchema:t=>a({currentSchema:t,joinSuggestions:[],queryResult:null}),reset:()=>a({currentSchema:null,joinSuggestions:[],queryResult:null,error:null})}));function Ye(){const{schemas:a,currentSchema:n,joinSuggestions:t,queryResult:o,loading:r,error:d,fetchSchemas:C,createSchema:x,deleteSchema:j,suggestJoins:D,executeQuery:w,setCurrentSchema:T,reset:b}=Ge(),{connections:R,fetchConnections:v}=Qe(),i=ye("EXECUTE_WRITE_QUERY"),{execute:l}=se(),{registerOutput:$}=Fe(Oe.FEDERATION),[ne,N]=c.useState(!1),[_,U]=c.useState(""),[G,Y]=c.useState(""),[y,X]=c.useState([]),[p,re]=c.useState(""),[L,O]=c.useState({open:!1,schemaId:null,schemaName:""}),[oe,K]=c.useState(!0),g=qe(p);c.useEffect(()=>((async()=>(K(!0),await Promise.all([C(),v()]),K(!1)))(),()=>b()),[C,v,b]);const ie=async()=>{!_||y.length<2||await l({type:z.CREATE,label:"Create federation schema",reversibility:E.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{connectionIds:y,action:"create_federation_schema"},action:async()=>{const s=await x({name:_,connectionIds:y,description:G});if(!s)throw new Error("Create schema failed");return N(!1),U(""),Y(""),X([]),s}})},ce=async()=>{n&&await l({type:z.GENERATE,label:"Suggest joins",reversibility:E.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{schemaId:n.id,action:"suggest_joins"},action:async()=>{const s=await D();if(!s)throw new Error("Suggest joins failed");return s}})},B=c.useCallback(async()=>{!n||!p.trim()||await l({type:z.EXECUTE,label:"Run federated query",reversibility:g?E.IRREVERSIBLE:E.FULLY_REVERSIBLE,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{schemaId:n.id,action:"execute_federation_query",writeOperation:g},action:async()=>{const s=await w(n.id,p);if(!s)throw new Error("Query execution failed");const u=s.rows||[],f=u.length>0?Object.keys(u[0]).map(he=>({name:he})):[];return $({type:Be.TABLE,title:`Federation: ${n.name||"Query"} (${u.length} rows)`,summary:p.slice(0,100),data:{columns:f,rows:u},format:"table"}),s}})},[n,w,p,l,g,$]),le=c.useCallback(async()=>{if(!(!n||!p.trim())){if(g){i(n.name||n.id||"selected schema",B);return}await B()}},[i,n,p,B,g]),ue=c.useCallback(s=>{O({open:!0,schemaId:s?.id||null,schemaName:s?.name||"this schema"})},[]),de=async()=>{const s=L.schemaId,u=L.schemaName;O({open:!1,schemaId:null,schemaName:""}),s&&await l({type:z.DELETE,label:"Delete federation schema",reversibility:E.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{schemaId:s,schemaName:u,action:"delete_federation_schema"},action:async()=>{const f=await j(s);if(!f)throw new Error("Delete schema failed");return f}})},me=s=>{X(u=>u.includes(s)?u.filter(f=>f!==s):[...u,s])};return oe?e.jsxs(m,{sx:{p:3,maxWidth:1400,mx:"auto"},children:[e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[e.jsx(H,{}),e.jsx(h,{variant:"h5",children:"Cross-Database Federation"})]}),e.jsx(m,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:300},children:e.jsx(W,{})})]}):e.jsxs(m,{sx:{p:3,maxWidth:1400,mx:"auto"},children:[e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(m,{children:[e.jsxs(h,{variant:"h5",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(H,{})," Cross-Database Federation"]}),e.jsx(h,{variant:"body1",color:"text.secondary",children:"Create virtual schemas to query across multiple databases"})]}),e.jsx(I,{variant:"contained",startIcon:e.jsx(je,{}),onClick:()=>N(!0),children:"New Virtual Schema"})]}),d&&e.jsx(Z,{severity:"error",sx:{mb:2},onClose:()=>b(),children:d}),e.jsx(ze,{title:"AI join suggestions",description:"Join suggestions are generated from schema metadata. Review before running cross-database queries.",chips:[{label:"Source: Selected schemas",variant:"outlined"},{label:"Confidence: Provided per suggestion",variant:"outlined"},{label:"Read-only recommended",variant:"outlined"}],dense:!0,sx:{mb:2}}),e.jsxs(k,{container:!0,spacing:3,children:[e.jsx(k,{size:{xs:12,md:4},children:e.jsxs(Q,{sx:{p:2},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:"Virtual Schemas"}),a.length===0?e.jsx(h,{color:"text.secondary",sx:{py:2,textAlign:"center"},children:"No virtual schemas yet. Create one to get started."}):e.jsx(be,{children:a.map(s=>e.jsxs(Se,{button:!0,selected:n?.id===s.id,onClick:()=>T(s),secondaryAction:e.jsx(ve,{title:"Delete schema",children:e.jsx(Ee,{edge:"end","aria-label":`Delete ${s.name}`,onClick:u=>{u.stopPropagation(),ue(s)},children:e.jsx(Ie,{})})}),children:[e.jsx(Ce,{children:e.jsx(F,{})}),e.jsx(we,{primary:s.name,secondary:`${s.connections?.length||0} databases`})]},s.id))})]})}),e.jsx(k,{size:{xs:12,md:8},children:n?e.jsxs(Q,{sx:{p:3},children:[e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(h,{variant:"h6",children:n.name}),e.jsx(I,{variant:"outlined",startIcon:r?e.jsx(W,{size:20}):e.jsx(Ae,{}),onClick:ce,disabled:r,children:"AI Join Suggestions"})]}),n.description&&e.jsx(h,{color:"text.secondary",sx:{mb:2},children:n.description}),e.jsx(m,{sx:{display:"flex",gap:1,mb:3,flexWrap:"wrap"},children:(n.connections||[]).map((s,u)=>e.jsx(A,{icon:e.jsx(F,{}),label:s.name||s,variant:"outlined"},u))}),t.length>0&&e.jsxs(m,{sx:{mb:3},children:[e.jsx(h,{variant:"subtitle1",gutterBottom:!0,children:"Suggested Joins"}),e.jsx(k,{container:!0,spacing:2,children:t.map((s,u)=>e.jsx(k,{size:{xs:12,sm:6},children:e.jsx(ee,{variant:"outlined",children:e.jsxs(te,{sx:{py:1.5},children:[e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(We,{sx:{color:"text.secondary"}}),e.jsxs(h,{variant:"subtitle2",children:[s.left_table," â†” ",s.right_table]})]}),e.jsxs(h,{variant:"body2",color:"text.secondary",children:[s.left_column," = ",s.right_column]}),s.reason&&e.jsx(h,{variant:"caption",color:"text.secondary",display:"block",sx:{mt:.5},children:s.reason}),e.jsx(A,{size:"small",label:`${Math.round((s.confidence||0)*100)}% confidence`,sx:{mt:1,bgcolor:f=>f.palette.mode==="dark"?J(f.palette.text.primary,.1):M[200],color:"text.secondary"}})]})})},u))})]}),e.jsx(ke,{sx:{my:2}}),e.jsx(h,{variant:"subtitle1",gutterBottom:!0,children:"Federated Query"}),e.jsx(P,{fullWidth:!0,multiline:!0,rows:4,placeholder:"SELECT * FROM db1.users u JOIN db2.orders o ON u.id = o.user_id",value:p,onChange:s=>re(s.target.value),sx:{mb:2,fontFamily:"monospace"}}),e.jsxs(m,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:2},children:[e.jsx(A,{size:"small",label:"Read-only recommended",variant:"outlined",sx:{fontSize:"12px"}}),g&&e.jsx(A,{size:"small",label:`${g.toUpperCase()} detected`,sx:{fontSize:"12px",bgcolor:s=>s.palette.mode==="dark"?J(s.palette.text.primary,.1):M[200],color:"text.secondary"}})]}),e.jsx(I,{variant:"contained",startIcon:r?e.jsx(W,{size:20}):e.jsx(De,{}),onClick:le,disabled:!p.trim()||r,children:"Execute Query"}),g&&e.jsx(Z,{severity:"warning",sx:{mt:2},children:"Write queries can modify data and may not be reversible. You will be asked to confirm before execution."}),o&&e.jsxs(m,{sx:{mt:3},children:[e.jsxs(h,{variant:"subtitle1",gutterBottom:!0,children:["Results (",o.rows?.length||0," rows)"]}),e.jsx(m,{sx:{overflowX:"auto"},children:e.jsx("pre",{style:{fontSize:12,margin:0},children:JSON.stringify(o,null,2)})})]})]}):e.jsxs(Q,{sx:{p:4,textAlign:"center"},children:[e.jsx(F,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(h,{color:"text.secondary",children:"Select a virtual schema or create a new one to get started"})]})})]}),e.jsxs(Te,{open:ne,onClose:()=>N(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Re,{children:"Create Virtual Schema"}),e.jsxs(Ne,{children:[e.jsx(P,{fullWidth:!0,label:"Schema Name",value:_,onChange:s=>U(s.target.value),sx:{mt:2,mb:2}}),e.jsx(P,{fullWidth:!0,label:"Description",value:G,onChange:s=>Y(s.target.value),multiline:!0,rows:2,sx:{mb:2}}),e.jsx(h,{variant:"subtitle2",gutterBottom:!0,children:"Select Databases (minimum 2)"}),e.jsx(m,{sx:{display:"flex",flexDirection:"column",gap:1},children:R.map(s=>e.jsx(ee,{variant:"outlined",sx:{cursor:"pointer",borderColor:y.includes(s.id)?"text.secondary":"divider",bgcolor:y.includes(s.id)?"action.selected":"background.paper"},onClick:()=>me(s.id),children:e.jsx(te,{sx:{py:1,"&:last-child":{pb:1}},children:e.jsxs(m,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(F,{}),e.jsx(h,{children:s.name})]}),y.includes(s.id)&&e.jsx(A,{label:"Selected",size:"small",sx:{bgcolor:u=>u.palette.mode==="dark"?J(u.palette.text.primary,.1):M[200],color:"text.secondary"}})]})})},s.id))})]}),e.jsxs(_e,{children:[e.jsx(I,{onClick:()=>N(!1),children:"Cancel"}),e.jsx(I,{variant:"contained",onClick:ie,disabled:!_||y.length<2,children:"Create"})]})]}),e.jsx(Le,{open:L.open,onClose:()=>O({open:!1,schemaId:null,schemaName:""}),onConfirm:de,title:"Delete Virtual Schema",message:`Delete "${L.schemaName}"? This will remove the virtual schema and its saved join logic.`,confirmLabel:"Delete",severity:"error"})]})}function ot(){return se(),e.jsx(Ye,{})}export{ot as default};
