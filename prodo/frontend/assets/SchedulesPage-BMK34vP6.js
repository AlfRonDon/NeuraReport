import{c as se,j as t,e as ye,d as We,u as je,a4 as Be,f as q,r as l,aW as qe,aX as Ne,aT as Oe,R as J,I as N,aY as xe,aZ as Ue,a_ as He,B as R,T as C,S as z,P as Ve,x as ae,n as Ye,a$ as Je,o as Qe,A as Ze,H as ve,_ as Q,a0 as Ge,$ as Z,aI as Ke,a1 as Xe,J as p,v as Ce,k as d,p as r,b0 as ge,t as et,a2 as tt,a3 as O,ai as G,aj as K,b1 as at,K as ke,ak as nt,al as st,am as lt,N as rt,an as it,ao as ot,s as ct}from"./index-B8Eu23bA.js";import{D as dt}from"./DataTable-_yVGBakl.js";import{C as ut}from"./ConfirmModal-Bm9QL03g.js";import{C as pt}from"./Container-nBfdHHf8.js";import{M as mt}from"./MoreVert-BRjwX6CI.js";import{S as ht}from"./Switch-CKmzMGzD.js";import{E as xt}from"./Email-Dwi3AvV1.js";import"./KeyboardArrowDown-C4qqpONU.js";import"./FilterList-lKi4AKs9.js";import"./Check-BATZaRrq.js";import"./TableRow-Gv3OwSlT.js";import"./TableContainer-CxteWhu6.js";import"./KeyboardArrowRight-BOQXGjwe.js";import"./CheckCircleOutline-BKKyaL-x.js";import"./WarningAmber-DtVJgAFk.js";const gt=se(t.jsx("path",{d:"M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 16H5V10h14zM9 14H7v-2h2zm4 0h-2v-2h2zm4 0h-2v-2h2zm-8 4H7v-2h2zm4 0h-2v-2h2zm4 0h-2v-2h2z"})),ft=se(t.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-6h2zm0-8h-2V7h2z"})),bt=se(t.jsx("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"})),St=ke`
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
`;ke`
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
`;const yt=p(R)(({theme:e})=>({padding:e.spacing(3),animation:`${St} 0.4s ease-out`})),jt=p(nt)(({theme:e})=>({"& .MuiDialog-paper":{backgroundColor:r(e.palette.background.paper,.95),backdropFilter:"blur(20px)",borderRadius:8,border:`1px solid ${r(e.palette.divider,.1)}`,boxShadow:`0 24px 48px ${r(e.palette.common.black,.2)}`},"& .MuiBackdrop-root":{backgroundColor:r(e.palette.common.black,.5),backdropFilter:"blur(4px)"}})),vt=p(st)(({theme:e})=>({display:"flex",alignItems:"center",gap:e.spacing(2),padding:e.spacing(3),borderBottom:`1px solid ${r(e.palette.divider,.1)}`})),Ct=p(R)(({theme:e})=>({width:48,height:48,borderRadius:14,backgroundColor:e.palette.mode==="dark"?r(e.palette.text.primary,.08):d[300],display:"flex",alignItems:"center",justifyContent:"center","& svg":{fontSize:24,color:e.palette.text.secondary}})),kt=p(lt)(({theme:e})=>({padding:e.spacing(3)})),It=p(ot)(({theme:e})=>({padding:e.spacing(2,3),borderTop:`1px solid ${r(e.palette.divider,.1)}`,backgroundColor:r(e.palette.background.paper,.3),gap:e.spacing(1)})),X=p(C)(({theme:e})=>({fontSize:"0.75rem",fontWeight:600,textTransform:"uppercase",letterSpacing:"0.05em",color:e.palette.text.disabled,marginBottom:e.spacing(2),marginTop:e.spacing(3),display:"flex",alignItems:"center",gap:e.spacing(1),"&:first-of-type":{marginTop:0}})),L=p(rt)(({theme:e})=>({"& .MuiOutlinedInput-root":{borderRadius:12,transition:"all 0.2s ease","&:hover .MuiOutlinedInput-notchedOutline":{borderColor:e.palette.mode==="dark"?r(e.palette.text.primary,.3):d[600]},"&.Mui-focused":{"& .MuiOutlinedInput-notchedOutline":{borderColor:e.palette.mode==="dark"?d[1e3]:d[1100],borderWidth:2}}}})),ee=p(it)(({theme:e})=>({"& .MuiOutlinedInput-root":{borderRadius:12}})),Dt=p(Ce,{shouldForwardProp:e=>e!=="active"})(({theme:e,active:o})=>({borderRadius:8,fontWeight:500,fontSize:"0.75rem",backgroundColor:o?e.palette.mode==="dark"?r(e.palette.text.primary,.1):d[300]:e.palette.mode==="dark"?r(e.palette.text.primary,.06):d[200],color:e.palette.text.secondary,border:`1px solid ${o?e.palette.mode==="dark"?r(e.palette.text.primary,.15):d[500]:r(e.palette.divider,.2)}`})),Rt=p(Ce)(({theme:e})=>({borderRadius:8,fontWeight:500,fontSize:"0.75rem",backgroundColor:e.palette.mode==="dark"?r(e.palette.text.primary,.08):d[300],color:e.palette.text.secondary,border:`1px solid ${e.palette.mode==="dark"?r(e.palette.text.primary,.12):d[500]}`})),Ie=p(ht)(({theme:e})=>({"& .MuiSwitch-switchBase.Mui-checked":{color:e.palette.mode==="dark"?d[1e3]:d[1100],"& + .MuiSwitch-track":{backgroundColor:e.palette.mode==="dark"?d[1e3]:d[1100]}}})),Et=p(tt)(({theme:e})=>({"& .MuiPaper-root":{backgroundColor:r(e.palette.background.paper,.95),backdropFilter:"blur(20px)",borderRadius:12,border:`1px solid ${r(e.palette.divider,.1)}`,boxShadow:`0 8px 32px ${r(e.palette.common.black,.15)}`,minWidth:180}})),te=p(O)(({theme:e})=>({borderRadius:8,margin:e.spacing(.5,1),padding:e.spacing(1,1.5),transition:"all 0.15s ease","&:hover":{backgroundColor:e.palette.mode==="dark"?r(e.palette.text.primary,.08):d[200]}})),Tt=p(R,{shouldForwardProp:e=>e!=="status"})(({theme:e,status:o})=>{const i=e.palette.mode==="dark"?d[1e3]:d[1100],j=e.palette.mode==="dark"?r(e.palette.text.primary,.1):d[300],g={ok:{bg:j,border:i,text:i},warning:{bg:j,border:i,text:i},disabled:{bg:e.palette.mode==="dark"?r(e.palette.text.primary,.06):d[200],border:r(e.palette.divider,.3),text:e.palette.text.secondary},error:{bg:j,border:i,text:i}},k=g[o]||g.warning;return{display:"flex",alignItems:"center",gap:e.spacing(1.5),padding:e.spacing(1.5,2),marginBottom:e.spacing(2),borderRadius:12,backgroundColor:k.bg,border:`1px solid ${k.border}`,color:k.text}}),De=p(ct)(({theme:e})=>({borderRadius:10,textTransform:"none",fontWeight:500,padding:e.spacing(1,2.5),transition:"all 0.2s ease"})),wt=p(De)(({theme:e})=>({background:e.palette.mode==="dark"?d[1100]:d[1200],color:"#fff",boxShadow:`0 4px 14px ${r(e.palette.common.black,.15)}`,"&:hover":{background:e.palette.mode==="dark"?d[1e3]:d[1100],boxShadow:`0 6px 20px ${r(e.palette.common.black,.2)}`,transform:"translateY(-1px)"},"&:disabled":{background:r(e.palette.text.primary,.1),color:r(e.palette.text.primary,.4),boxShadow:"none"}})),ne=[{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"},{value:"monthly",label:"Monthly"}],fe={daily:1440,weekly:10080,monthly:43200},be=e=>{if(!e)return"";const o=String(e).match(/^(\d{4}-\d{2}-\d{2})/);return o?o[1]:""},Se=(e,o=!1)=>e?`${e} ${o?"23:59:59":"00:00:00"}`:"",Mt=e=>e?e.split(/[;,]/).map(o=>o.trim()).filter(Boolean):[],Lt=e=>Array.isArray(e)?e.filter(Boolean).join(", "):"",_t=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);function $t({open:e,onClose:o,schedule:i,templates:j,connections:g,defaultTemplateId:k,defaultConnectionId:_,onSave:U,onError:E}){ye();const[s,$]=l.useState({name:"",templateId:"",connectionId:"",startDate:"",endDate:"",frequency:"daily",emailRecipients:"",emailSubject:"",emailMessage:"",active:!0}),[A,W]=l.useState(!1),v=!!i;l.useEffect(()=>{if(i){$({name:i.name||"",templateId:i.template_id||"",connectionId:i.connection_id||"",startDate:be(i.start_date),endDate:be(i.end_date),frequency:i.frequency||"daily",emailRecipients:Lt(i.email_recipients),emailSubject:i.email_subject||"",emailMessage:i.email_message||"",active:i.active!==!1});return}const c=k||j[0]?.id||"",m=_||g[0]?.id||"";$({name:"",templateId:c,connectionId:m,startDate:"",endDate:"",frequency:"daily",emailRecipients:"",emailSubject:"",emailMessage:"",active:!0})},[i,j,g,e,k,_]);const x=c=>m=>{const T=m.target.type==="checkbox"?m.target.checked:m.target.value;$(w=>({...w,[c]:T}))},P=async()=>{const c=fe[s.frequency]||fe.daily,m=Mt(s.emailRecipients),T=Se(s.startDate),w=Se(s.endDate,!0);if(s.startDate&&s.endDate&&s.endDate<s.startDate){E?.("End date must be on or after start date");return}if(m.length>0){const F=m.find(f=>!_t(f));if(F){E?.(`Invalid email address: ${F}`);return}}W(!0);try{await U({name:s.name,templateId:s.templateId,connectionId:s.connectionId,startDate:T,endDate:w,frequency:s.frequency,intervalMinutes:c,emailRecipients:m.length?m:void 0,emailSubject:s.emailSubject||void 0,emailMessage:s.emailMessage||void 0,active:s.active}),o()}finally{W(!1)}},H=A||!s.name||!s.templateId||!s.connectionId||!s.startDate||!s.endDate;return t.jsxs(jt,{open:e,onClose:o,maxWidth:"sm",fullWidth:!0,TransitionComponent:ve,children:[t.jsxs(vt,{children:[t.jsx(Ct,{children:t.jsx(ae,{})}),t.jsxs(R,{children:[t.jsx(C,{variant:"h6",sx:{fontWeight:600},children:v?"Edit Schedule":"Create Schedule"}),t.jsx(C,{variant:"body2",color:"text.secondary",children:v?"Update the schedule configuration":"Set up automated report generation"})]})]}),t.jsxs(kt,{children:[t.jsxs(X,{children:[t.jsx(ae,{sx:{fontSize:16}}),"Basic Information"]}),t.jsxs(z,{spacing:2.5,children:[t.jsx(L,{label:"Schedule Name",value:s.name,onChange:x("name"),fullWidth:!0,required:!0,placeholder:"e.g., Weekly Sales Report"}),t.jsxs(ee,{fullWidth:!0,required:!0,children:[t.jsx(G,{children:"Template"}),t.jsx(K,{value:s.templateId,onChange:x("templateId"),label:"Template",disabled:v,children:j.map(c=>t.jsx(O,{value:c.id,children:c.name||c.id},c.id))})]}),t.jsxs(ee,{fullWidth:!0,required:!0,children:[t.jsx(G,{children:"Connection"}),t.jsx(K,{value:s.connectionId,onChange:x("connectionId"),label:"Connection",disabled:v,children:g.map(c=>t.jsx(O,{value:c.id,children:c.name||c.id},c.id))})]})]}),t.jsxs(X,{children:[t.jsx(gt,{sx:{fontSize:16}}),"Schedule Timing"]}),t.jsxs(z,{spacing:2.5,children:[t.jsxs(z,{direction:{xs:"column",sm:"row"},spacing:2,children:[t.jsx(L,{label:"Start Date",type:"date",value:s.startDate,onChange:x("startDate"),InputLabelProps:{shrink:!0},fullWidth:!0,required:!0}),t.jsx(L,{label:"End Date",type:"date",value:s.endDate,onChange:x("endDate"),InputLabelProps:{shrink:!0},fullWidth:!0,required:!0})]}),t.jsxs(ee,{fullWidth:!0,children:[t.jsx(G,{children:"Frequency"}),t.jsx(K,{value:s.frequency,onChange:x("frequency"),label:"Frequency",children:ne.map(c=>t.jsx(O,{value:c.value,children:c.label},c.value))})]})]}),t.jsxs(X,{children:[t.jsx(xt,{sx:{fontSize:16}}),"Email Notifications (Optional)"]}),t.jsxs(z,{spacing:2.5,children:[t.jsx(L,{label:"Email recipients",value:s.emailRecipients,onChange:x("emailRecipients"),placeholder:"ops@example.com, finance@example.com",helperText:"Comma or semicolon separated list",fullWidth:!0}),t.jsx(L,{label:"Email subject",value:s.emailSubject,onChange:x("emailSubject"),fullWidth:!0}),t.jsx(L,{label:"Email message",value:s.emailMessage,onChange:x("emailMessage"),multiline:!0,minRows:2,fullWidth:!0})]}),t.jsx(R,{sx:{mt:3},children:t.jsx(at,{control:t.jsx(Ie,{checked:s.active,onChange:x("active")}),label:t.jsxs(R,{children:[t.jsx(C,{variant:"body2",fontWeight:500,children:"Active"}),t.jsx(C,{variant:"caption",color:"text.secondary",children:"Enable this schedule to run automatically"})]})})})]}),t.jsxs(It,{children:[t.jsx(De,{onClick:o,children:"Cancel"}),t.jsx(wt,{onClick:P,disabled:H,children:A?"Saving...":v?"Update Schedule":"Create Schedule"})]})]})}function At(){ye();const e=We(),{execute:o}=je(),[i,j]=Be(),g=q(a=>a.templates),k=q(a=>a.setTemplates),_=q(a=>a.savedConnections),U=q(a=>a.activeConnectionId),[E,s]=l.useState([]),[$,A]=l.useState(!1),[W,v]=l.useState(!1),[x,P]=l.useState(null),[H,c]=l.useState(!1),[m,T]=l.useState(null),[w,F]=l.useState(null),[f,le]=l.useState(null),[re,ie]=l.useState(null),[oe,Re]=l.useState(null),M=l.useRef(null),ce=l.useRef(!1),de=l.useRef(!1),I=l.useCallback(async()=>{A(!0);try{const a=await qe();s(a||[])}catch(a){e.show(a.message||"Failed to load schedules","error")}finally{A(!1)}},[e]),ue=l.useCallback(async()=>{try{const a=await Ne();Re(a)}catch(a){console.warn("Failed to fetch scheduler status:",a)}},[]);l.useEffect(()=>{ce.current||(ce.current=!0,I(),ue())},[I,ue]);const pe=l.useCallback(async()=>{if(!(g.length>0))try{const a=await Oe();Array.isArray(a)&&a.length>0&&k(a)}catch(a){e.show(a.message||"Failed to load templates","error")}},[g.length,k,e]);l.useEffect(()=>{de.current||(de.current=!0,pe())},[pe]);const V=i.get("template"),Ee=V||g[0]?.id||"",Te=U||_[0]?.id||"";l.useEffect(()=>{if(!V)return;P(null),v(!0);const a=new URLSearchParams(i);a.delete("template"),j(a,{replace:!0})},[V,i,j]);const we=l.useCallback((a,n)=>{a.stopPropagation(),F(a.currentTarget),le(n)},[]),D=l.useCallback(()=>{F(null),le(null)},[]),me=l.useCallback(()=>{P(null),v(!0)},[]),Me=l.useCallback(()=>{P(f),v(!0),D()},[f,D]),Le=l.useCallback(()=>{T(f),c(!0),D()},[f,D]),B=l.useCallback(async(a,n)=>{a&&o({type:N.UPDATE,label:`${n?"Enable":"Pause"} schedule "${a.name||a.id}"`,reversibility:J.FULLY_REVERSIBLE,successMessage:`Schedule ${n?"enabled":"paused"}`,errorMessage:"Failed to update schedule",action:async()=>{ie(a.id);try{await xe(a.id,{active:n}),await I()}finally{ie(null)}}})},[I,o]),_e=l.useCallback(async()=>{if(!f)return;const n=!(f.active??f.enabled??!0);await B(f,n),D()},[f,D,B]),$e=l.useCallback(async a=>{const n=!!x;await o({type:n?N.UPDATE:N.CREATE,label:n?`Update schedule "${a.name}"`:`Create schedule "${a.name}"`,reversibility:J.FULLY_REVERSIBLE,successMessage:n?"Schedule updated":"Schedule created",errorMessage:"Failed to save schedule",action:async()=>{n?await xe(x.id,a):await Ue(a),I()}})},[x,I,o]),Ae=l.useCallback(async()=>{if(!m)return;const a=m,n=E.findIndex(u=>u.id===a.id);c(!1),T(null),M.current?.timeoutId&&(clearTimeout(M.current.timeoutId),M.current=null),o({type:N.DELETE,label:`Delete schedule "${a.name||a.id}"`,reversibility:J.PARTIALLY_REVERSIBLE,successMessage:"Schedule removed",errorMessage:"Failed to delete schedule",action:async()=>{s(S=>S.filter(h=>h.id!==a.id));let u=!1;const b=setTimeout(async()=>{if(!u)try{await He(a.id),I()}catch(S){throw s(h=>{if(h.some(Y=>Y.id===a.id))return h;const y=[...h];return n>=0&&n<=y.length?y.splice(n,0,a):y.push(a),y}),S}finally{M.current=null}},5e3);M.current={timeoutId:b,schedule:a},e.showWithUndo(`Schedule "${a.name||a.id}" removed`,()=>{u=!0,clearTimeout(b),M.current=null,s(S=>{if(S.some(y=>y.id===a.id))return S;const h=[...S];return n>=0&&n<=h.length?h.splice(n,0,a):h.push(a),h}),e.show("Schedule restored","success")},{severity:"info"})}})},[m,E,I,o,e]),Pe=l.useMemo(()=>[{field:"name",headerName:"Schedule",renderCell:(a,n)=>t.jsxs(R,{children:[t.jsx(C,{variant:"body2",fontWeight:600,children:a||n.id}),t.jsx(C,{variant:"caption",color:"text.secondary",children:g.find(u=>u.id===n.template_id)?.name||n.template_name||n.template_id})]})},{field:"frequency",headerName:"Frequency",width:120,renderCell:a=>{const u=ne.find(b=>b.value===a)?.label||a||"daily";return t.jsx(Rt,{label:u,size:"small"})}},{field:"enabled",headerName:"Status",width:140,renderCell:(a,n)=>{const u=n.active??a??!0;return t.jsxs(z,{direction:"row",alignItems:"center",spacing:1,children:[t.jsx(Ie,{size:"small",checked:u,disabled:re===n.id,onChange:b=>{b.stopPropagation(),B(n,b.target.checked)}}),t.jsx(Dt,{label:u?"Active":"Paused",size:"small",active:u})]})}},{field:"last_run",headerName:"Last Run",width:180,renderCell:(a,n)=>{const u=a||n.last_run_at;return t.jsx(C,{variant:"body2",color:u?"text.primary":"text.secondary",children:u?new Date(u).toLocaleString():"Never"})}},{field:"next_run",headerName:"Next Run",width:180,renderCell:(a,n)=>{const u=n.active??n.enabled??!0,b=a||n.next_run_at;return t.jsx(C,{variant:"body2",color:u&&b?"text.primary":"text.secondary",children:u&&b?new Date(b).toLocaleString():"-"})}}],[g,B,re]),Fe=l.useMemo(()=>[{key:"frequency",label:"Frequency",options:ne},{key:"active",label:"Status",options:[{value:!0,label:"Active"},{value:!1,label:"Paused"}]}],[]),he=f?.active??f?.enabled??!0,ze=()=>{if(!oe)return null;const{scheduler:a,schedules:n}=oe,u=a?.running,b=a?.enabled;let S=t.jsx(ft,{}),h="",y="warning";if(!b)S=t.jsx(ge,{}),h="Scheduler is disabled. Schedules will not run automatically.",y="disabled";else if(!u)S=t.jsx(ge,{}),h="Scheduler is not running. Restart the server to enable automatic scheduling.",y="warning";else if(S=t.jsx(et,{}),y="ok",n?.next_run){const Y=new Date(n.next_run.next_run_at).toLocaleString();h=`Scheduler running. Next: "${n.next_run.schedule_name}" at ${Y}`}else h=`Scheduler running (polling every ${a?.poll_interval_seconds||60}s). ${n?.active||0} active schedule(s).`;return t.jsxs(Tt,{status:y,children:[S,t.jsx(C,{variant:"body2",fontWeight:500,children:h})]})};return t.jsx(yt,{children:t.jsxs(pt,{maxWidth:"xl",children:[ze(),t.jsx(Ve,{severity:"info",sx:{mb:2,borderRadius:1},children:"Schedules create future report runs. Progress appears in Jobs and finished reports show up in History."}),t.jsx(dt,{title:"Scheduled Reports",subtitle:"Automate report generation on a schedule",columns:Pe,data:E,loading:$,searchPlaceholder:"Search schedules...",filters:Fe,actions:[{label:"Create Schedule",icon:t.jsx(Ze,{}),variant:"contained",onClick:me}],rowActions:a=>t.jsx(Ye,{title:"More actions",arrow:!0,TransitionComponent:Je,children:t.jsx(Qe,{size:"small",onClick:n=>we(n,a),"aria-label":"More actions",children:t.jsx(mt,{})})}),emptyState:{icon:ae,title:"No schedules yet",description:"Create a schedule to automatically generate reports on a recurring basis.",actionLabel:"Create Schedule",onAction:me}}),t.jsxs(Et,{anchorEl:w,open:!!w,onClose:D,TransitionComponent:ve,children:[t.jsxs(te,{onClick:Me,children:[t.jsx(Q,{children:t.jsx(Ge,{fontSize:"small"})}),t.jsx(Z,{children:"Edit"})]}),t.jsxs(te,{onClick:_e,children:[t.jsx(Q,{children:he?t.jsx(bt,{fontSize:"small"}):t.jsx(Ke,{fontSize:"small"})}),t.jsx(Z,{children:he?"Pause":"Enable"})]}),t.jsxs(te,{onClick:Le,sx:{color:"error.main"},children:[t.jsx(Q,{children:t.jsx(Xe,{fontSize:"small",sx:{color:"text.secondary"}})}),t.jsx(Z,{children:"Delete"})]})]}),t.jsx($t,{open:W,onClose:()=>v(!1),schedule:x,templates:g,connections:_,defaultTemplateId:Ee,defaultConnectionId:Te,onSave:$e,onError:a=>e.show(a,"error")}),t.jsx(ut,{open:H,onClose:()=>c(!1),onConfirm:Ae,title:"Delete Schedule",message:`Remove "${m?.name||m?.id}"? You can undo within a few seconds. This stops future runs; past downloads remain in History.`,confirmLabel:"Delete",severity:"error"})]})})}function Gt(){return je(),t.jsx(At,{})}export{Gt as default};
