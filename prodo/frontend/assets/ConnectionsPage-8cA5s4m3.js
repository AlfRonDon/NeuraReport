import{c as we,j as e,e as le,u as G,r,L as ke,R as M,I as S,M as Te,S as R,N as Ee,k as c,p as d,O as te,P as q,s as N,T as _,v as H,Q as Ie,B as h,q as ce,d as Re,f as I,i as Me,U as oe,V as ze,X as ae,Y as Le,w as ne,t as Ae,Z as Pe,n as De,A as $e,_ as Y,$ as B,a0 as Fe,a1 as _e,J as U,o as Ue,a2 as Oe,a3 as Ye,K as Be}from"./index-B8Eu23bA.js";import{M as Ve}from"./MoreVert-BRjwX6CI.js";import{D as We}from"./DataTable-_yVGBakl.js";import{C as He}from"./ConfirmModal-Bm9QL03g.js";import{D as de,C as Ne}from"./ConnectionForm-hEATkMM4.js";import{F as qe}from"./FavoriteButton-C4GlRvDk.js";import{P as Ge}from"./Visibility-DQVh5lRN.js";import{A as Xe,a as Ke,b as Qe}from"./AccordionSummary-CvHbDzcW.js";import{T as se,a as re,b as V,c as x,d as ie}from"./TableRow-Gv3OwSlT.js";import"./KeyboardArrowDown-C4qqpONU.js";import"./FilterList-lKi4AKs9.js";import"./Check-BATZaRrq.js";import"./TableContainer-CxteWhu6.js";import"./KeyboardArrowRight-BOQXGjwe.js";import"./CheckCircleOutline-BKKyaL-x.js";import"./WarningAmber-DtVJgAFk.js";import"./Switch-CKmzMGzD.js";import"./Star-BdvflhJ9.js";import"./StarBorder-fpAfr7cR.js";const Ze=we(e.jsx("path",{d:"M19 7H9c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2m0 2v2H9V9zm-6 6v-2h2v2zm2 2v2h-2v-2zm-4-2H9v-2h2zm6-2h2v2h-2zm-8 4h2v2H9zm8 2v-2h2v2zM6 17H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v1h-2V5H5v10h1z"})),Je=o=>o==null?"n/a":o.toLocaleString();function et({open:o,onClose:m,connection:p}){const a=le(),{execute:f}=G(),[w,O]=r.useState(null),[z,L]=r.useState(!1),[C,y]=r.useState(null),[A,v]=r.useState(""),[j,k]=r.useState({}),T=r.useCallback(async()=>{if(p?.id){L(!0),y(null);try{const s=await ke(p.id,{includeRowCounts:!0,includeForeignKeys:!0});O(s)}catch(s){y(s.message||"Failed to load schema")}finally{L(!1)}}},[p?.id]);r.useEffect(()=>{o&&T()},[o,T]);const P=r.useMemo(()=>{const s=w?.tables||[],l=A.trim().toLowerCase();return l?s.filter(i=>i.name.toLowerCase().includes(l)):s},[w,A]),E=r.useCallback(s=>{if(!(!p?.id||!s))return f({type:S.EXECUTE,label:`Preview ${s}`,reversibility:M.FULLY_REVERSIBLE,suppressSuccessToast:!0,intent:{connectionId:p.id,table:s},action:async()=>{k(l=>({...l,[s]:{...l[s]||{},loading:!0,error:null}}));try{const l=await Te(p.id,{table:s,limit:6});k(i=>({...i,[s]:{loading:!1,error:null,columns:l.columns||[],rows:l.rows||[]}}))}catch(l){k(i=>({...i,[s]:{...i[s]||{},loading:!1,error:l.message||"Preview failed"}}))}}})},[p?.id,f]),D=r.useCallback(()=>f({type:S.EXECUTE,label:"Refresh schema",reversibility:M.FULLY_REVERSIBLE,suppressSuccessToast:!0,intent:{connectionId:p?.id},action:T}),[p?.id,f,T]);return e.jsx(de,{open:o,onClose:m,title:"Connection Schema",subtitle:p?.name||p?.summary||"Database overview",width:680,actions:e.jsx(R,{direction:"row",spacing:1,justifyContent:"flex-end",children:e.jsx(N,{variant:"outlined",onClick:D,startIcon:e.jsx(ce,{}),sx:{borderRadius:1,textTransform:"none",borderColor:d(a.palette.divider,.2),color:a.palette.text.secondary,"&:hover":{borderColor:a.palette.mode==="dark"?c[1e3]:c[1100],bgcolor:a.palette.mode==="dark"?d(a.palette.text.primary,.08):c[300]}},children:"Refresh"})}),children:e.jsxs(R,{spacing:2,children:[e.jsx(Ee,{label:"Filter tables",value:A,onChange:s=>v(s.target.value),size:"small",fullWidth:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:1,bgcolor:d(a.palette.background.paper,.5),"& .MuiOutlinedInput-notchedOutline":{borderColor:d(a.palette.divider,.15)},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:d(a.palette.divider,.3)},"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:a.palette.mode==="dark"?c[1e3]:c[1100]}}}}),z&&e.jsx(te,{sx:{borderRadius:1,bgcolor:s=>s.palette.mode==="dark"?d(s.palette.text.primary,.1):c[300],"& .MuiLinearProgress-bar":{bgcolor:s=>s.palette.mode==="dark"?c[1e3]:c[1100]}}}),C&&e.jsx(q,{severity:"error",sx:{borderRadius:1},action:e.jsx(N,{color:"inherit",size:"small",onClick:D,children:"Retry"}),children:C==="Failed to load schema"?"Unable to connect to database. Please verify the connection is active and try again.":C}),!z&&!C&&e.jsxs(_,{variant:"body2",sx:{color:a.palette.text.secondary},children:[w?.table_count||0," tables found"]}),P.map(s=>{const l=j[s.name]||{};return e.jsxs(Xe,{disableGutters:!0,sx:{bgcolor:d(a.palette.background.paper,.5),border:`1px solid ${d(a.palette.divider,.1)}`,borderRadius:"8px !important","&:before":{display:"none"},"&.Mui-expanded":{margin:0}},children:[e.jsx(Ke,{expandIcon:e.jsx(Ie,{sx:{color:a.palette.text.secondary}}),sx:{borderRadius:1,"&:hover":{bgcolor:a.palette.mode==="dark"?d(a.palette.text.primary,.05):c[200]}},children:e.jsxs(R,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(_,{sx:{fontWeight:600,color:a.palette.text.primary},children:s.name}),e.jsx(H,{size:"small",label:`${Je(s.row_count)} rows`,sx:{bgcolor:a.palette.mode==="dark"?d(a.palette.text.primary,.08):c[300],color:a.palette.text.secondary,fontSize:"0.7rem",height:22,borderRadius:1}})]})}),e.jsx(Qe,{children:e.jsxs(R,{spacing:1.5,children:[e.jsxs(h,{children:[e.jsx(_,{variant:"subtitle2",sx:{mb:1,color:a.palette.text.primary},children:"Columns"}),e.jsxs(se,{size:"small",sx:{"& .MuiTableCell-head":{bgcolor:a.palette.mode==="dark"?d(a.palette.text.primary,.05):c[200],fontWeight:600,fontSize:"0.75rem",color:a.palette.text.secondary},"& .MuiTableCell-body":{fontSize:"0.8125rem",color:a.palette.text.primary}},children:[e.jsx(re,{children:e.jsxs(V,{children:[e.jsx(x,{children:"Name"}),e.jsx(x,{children:"Type"}),e.jsx(x,{children:"PK"}),e.jsx(x,{children:"Required"})]})}),e.jsx(ie,{children:(s.columns||[]).map(i=>e.jsxs(V,{children:[e.jsx(x,{children:i.name}),e.jsx(x,{children:i.type||"-"}),e.jsx(x,{children:i.pk?"Yes":"-"}),e.jsx(x,{children:i.notnull?"Yes":"-"})]},i.name))})]})]}),e.jsxs(h,{children:[e.jsxs(R,{direction:"row",spacing:1,alignItems:"center",justifyContent:"space-between",children:[e.jsx(_,{variant:"subtitle2",sx:{color:a.palette.text.primary},children:"Preview"}),e.jsx(N,{size:"small",variant:"outlined",startIcon:e.jsx(Ge,{}),onClick:()=>E(s.name),sx:{borderRadius:1,textTransform:"none",fontSize:"0.75rem",borderColor:d(a.palette.divider,.2),"&:hover":{borderColor:a.palette.mode==="dark"?c[1e3]:c[1100],bgcolor:a.palette.mode==="dark"?d(a.palette.text.primary,.08):c[300]}},children:"Load preview"})]}),l.loading&&e.jsx(te,{sx:{mt:1,borderRadius:1,bgcolor:i=>i.palette.mode==="dark"?d(i.palette.text.primary,.1):c[300],"& .MuiLinearProgress-bar":{bgcolor:i=>i.palette.mode==="dark"?c[1e3]:c[1100]}}}),l.error&&e.jsxs(q,{severity:"error",sx:{mt:1,borderRadius:1},children:["  ",l.error]}),l.rows&&l.rows.length>0&&e.jsxs(se,{size:"small",sx:{mt:1,"& .MuiTableCell-head":{bgcolor:a.palette.mode==="dark"?d(a.palette.text.primary,.05):c[200],fontWeight:600,fontSize:"0.75rem",color:a.palette.text.secondary},"& .MuiTableCell-body":{fontSize:"0.75rem",color:a.palette.text.primary}},children:[e.jsx(re,{children:e.jsx(V,{children:(l.columns||[]).map(i=>e.jsx(x,{children:i},i))})}),e.jsx(ie,{children:l.rows.map((i,$)=>e.jsx(V,{children:(l.columns||[]).map(F=>e.jsx(x,{children:i[F]==null?"-":String(i[F])},`${s.name}-${$}-${F}`))},`${s.name}-row-${$}`))})]}),!l.loading&&l.rows&&l.rows.length===0&&e.jsx(_,{variant:"body2",sx:{mt:1,color:a.palette.text.secondary},children:"No rows returned."})]})]})})]},s.name)})]})})}const ue=Be`
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
`,tt=U(h)(({theme:o})=>({padding:o.spacing(3),maxWidth:1400,margin:"0 auto",width:"100%",minHeight:"100vh",backgroundColor:o.palette.background.default,animation:`${ue} 0.5s ease-out`})),ot=U(Oe)(({theme:o})=>({"& .MuiPaper-root":{backgroundColor:d(o.palette.background.paper,.95),backdropFilter:"blur(20px)",border:`1px solid ${d(o.palette.divider,.1)}`,borderRadius:8,boxShadow:`0 8px 32px ${d(o.palette.common.black,.15)}`,minWidth:160,animation:`${ue} 0.2s ease-out`}})),W=U(Ye)(({theme:o})=>({borderRadius:8,margin:o.spacing(.5,1),padding:o.spacing(1,1.5),fontSize:"0.8125rem",transition:"all 0.2s ease","&:hover":{backgroundColor:o.palette.mode==="dark"?d(o.palette.text.primary,.08):c[300]}})),at=U(h)(({theme:o})=>({width:32,height:32,borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s ease"})),nt=U(Ue)(({theme:o})=>({borderRadius:8,transition:"all 0.2s ease","&:hover":{backgroundColor:o.palette.mode==="dark"?d(o.palette.text.primary,.08):c[300],transform:"scale(1.05)"}}));function st(){const o=le(),m=Re(),{execute:p}=G(),a=I(t=>t.savedConnections),f=I(t=>t.setSavedConnections),w=I(t=>t.addSavedConnection),O=I(t=>t.removeSavedConnection),z=I(t=>t.setActiveConnectionId),L=I(t=>t.activeConnectionId),[C,y]=r.useState(!1),[A,v]=r.useState(!1),[j,k]=r.useState(null),[T,P]=r.useState(!1),[E,D]=r.useState(null),[s,l]=r.useState(null),[i,$]=r.useState(null),[F,X]=r.useState(!1),[pe,me]=r.useState(null),[K,Q]=r.useState(new Set),Z=r.useRef(!1);r.useEffect(()=>{Z.current||(Z.current=!0,Me().then(t=>{const n=(t.connections||[]).map(u=>u.id);Q(new Set(n))}).catch(t=>{console.error("Failed to load favorites:",t)}))},[]);const J=r.useCallback((t,n)=>{Q(u=>{const b=new Set(u);return n?b.add(t):b.delete(t),b})},[]),xe=r.useCallback((t,n)=>{t.stopPropagation(),l(t.currentTarget),$(n)},[]),g=r.useCallback(()=>{l(null),$(null)},[]),ee=r.useCallback(()=>{k(null),v(!0)},[]),he=r.useCallback(()=>{k(i),v(!0),g()},[i,g]),ye=r.useCallback(()=>{D(i),P(!0),g()},[i,g]),be=r.useCallback(async()=>{if(!i)return;const t=i;g(),p({type:S.ANALYZE,label:`Inspect schema for "${t.name}"`,reversibility:M.SYSTEM_MANAGED,errorMessage:"Unable to connect to database. Please verify the connection is active.",action:async()=>{y(!0);try{if((await oe(t.id)).status!=="ok")throw new Error("Connection is unavailable. Please verify connection settings.");me(t),X(!0)}finally{y(!1)}}})},[i,g,p]),fe=r.useCallback(async()=>{if(!E)return;const t=E,n=a.find(u=>u.id===t.id);P(!1),D(null),p({type:S.DELETE,label:`Delete data source "${t.name}"`,reversibility:M.PARTIALLY_REVERSIBLE,successMessage:`"${t.name}" removed`,errorMessage:"Failed to delete connection",action:async()=>{O(t.id);try{await ze(t.id)}catch(u){throw n&&f(b=>[...b,n]),u}m.showWithUndo(`"${t.name}" removed`,async()=>{if(n)try{const u=await ae({name:n.name,dbType:n.db_type,dbUrl:n.db_url,database:n.database||n.summary,status:n.status||"connected",latencyMs:n.latency_ms});f(b=>[...b,u]),m.show("Data source restored","success")}catch(u){console.error("Failed to restore connection:",u),m.show("Failed to restore connection","error")}},{severity:"info"})}})},[E,a,O,f,m,p]),Ce=r.useCallback(async t=>{const n=!!j;p({type:n?S.UPDATE:S.CREATE,label:n?`Update data source "${t.name}"`:`Add data source "${t.name}"`,reversibility:M.FULLY_REVERSIBLE,successMessage:n?"Data source updated":"Data source added",errorMessage:"Failed to save connection",action:async()=>{y(!0);try{const u=await Le(t);if(!u.ok)throw new Error(u.detail||"Connection test failed");const b=await ae({id:j?.id||u.connection_id,name:t.name,dbType:t.db_type,dbUrl:t.db_url,database:t.database,status:"connected",latencyMs:u.latency_ms});w(b),v(!1)}finally{y(!1)}}})},[j,w,p]),ge=r.useCallback(async t=>{p({type:S.EXECUTE,label:`Test connection "${t.name}"`,reversibility:M.SYSTEM_MANAGED,errorMessage:"Connection test failed",action:async()=>{y(!0);try{const n=await oe(t.id);if(n.status==="ok")m.show(`Connected (${n.latency_ms}ms)`,"success");else throw new Error("Connection unavailable")}finally{y(!1)}}})},[m,p]),ve=r.useCallback(t=>{z(t.id),m.show(`Selected: ${t.name}`,"info")},[z,m]),je=r.useMemo(()=>[{field:"name",headerName:"Name",renderCell:(t,n)=>e.jsxs(h,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(qe,{entityType:"connections",entityId:n.id,initialFavorite:K.has(n.id),onToggle:u=>J(n.id,u)}),e.jsx(at,{sx:{bgcolor:o.palette.mode==="dark"?d(o.palette.text.primary,.08):c[300]},children:e.jsx(ne,{sx:{color:o.palette.text.secondary,fontSize:16}})}),e.jsxs(h,{sx:{minWidth:0},children:[e.jsxs(R,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(h,{sx:{fontWeight:500,fontSize:"0.8125rem",color:o.palette.text.primary},children:t}),L===n.id&&e.jsx(H,{size:"small",label:"Active",sx:{bgcolor:u=>u.palette.mode==="dark"?d(u.palette.text.primary,.1):c[400],color:"text.secondary"}})]}),e.jsx(h,{sx:{fontSize:"0.75rem",color:o.palette.text.secondary},children:n.summary||n.db_type})]})]})},{field:"db_type",headerName:"Type",width:120,renderCell:t=>e.jsx(H,{label:t||"Unknown",size:"small",sx:{bgcolor:o.palette.mode==="dark"?d(o.palette.text.primary,.08):c[300],color:o.palette.text.secondary,fontSize:"0.75rem",borderRadius:1}})},{field:"status",headerName:"Status",width:140,renderCell:t=>e.jsx(H,{icon:t==="connected"?e.jsx(Ae,{sx:{fontSize:14}}):e.jsx(Pe,{sx:{fontSize:14}}),label:t||"Unknown",size:"small",sx:{fontSize:"0.75rem",textTransform:"capitalize",borderRadius:1,bgcolor:n=>n.palette.mode==="dark"?d(n.palette.text.primary,.1):c[400],color:"text.secondary"}})},{field:"lastLatencyMs",headerName:"Latency",width:100,renderCell:t=>e.jsx(h,{sx:{color:o.palette.text.secondary,fontSize:"0.8125rem"},children:t?`${t}ms`:"-"})},{field:"lastConnected",headerName:"Last Connected",width:180,renderCell:t=>e.jsx(h,{sx:{color:o.palette.text.secondary,fontSize:"0.8125rem"},children:t?new Date(t).toLocaleString():"-"})}],[K,J,o,L]),Se=r.useMemo(()=>[{key:"status",label:"Status",options:[{value:"connected",label:"Connected"},{value:"disconnected",label:"Disconnected"},{value:"error",label:"Error"}]},{key:"db_type",label:"Type",options:[{value:"sqlite",label:"SQLite"}]}],[]);return e.jsxs(tt,{children:[e.jsx(q,{severity:"info",sx:{mb:2,borderRadius:1},children:"Data sources power report runs and AI tools. Use a read-only account when possible. Active sources are labeled and can be switched anytime."}),e.jsx(We,{title:"Data Sources",subtitle:"Connect to your databases and data files",columns:je,data:a,loading:C,searchPlaceholder:"Search connections...",filters:Se,actions:[{label:"Add Data Source",icon:e.jsx($e,{sx:{fontSize:18}}),variant:"contained",onClick:ee}],onRowClick:ve,rowActions:t=>e.jsx(De,{title:"More actions",children:e.jsx(nt,{size:"small",onClick:n=>xe(n,t),"aria-label":"More actions",sx:{color:o.palette.text.secondary},children:e.jsx(Ve,{sx:{fontSize:18}})})}),emptyState:{icon:ne,title:"No data sources yet",description:"Connect to a database to start pulling data for your reports.",actionLabel:"Add Data Source",onAction:ee}}),e.jsxs(ot,{anchorEl:s,open:!!s,onClose:g,children:[e.jsxs(W,{onClick:()=>{ge(i),g()},children:[e.jsx(Y,{children:e.jsx(ce,{sx:{fontSize:16,color:o.palette.text.secondary}})}),e.jsx(B,{primaryTypographyProps:{fontSize:"0.8125rem"},children:"Test Connection"})]}),e.jsxs(W,{onClick:be,children:[e.jsx(Y,{children:e.jsx(Ze,{sx:{fontSize:16,color:o.palette.text.secondary}})}),e.jsx(B,{primaryTypographyProps:{fontSize:"0.8125rem"},children:"Inspect Schema"})]}),e.jsxs(W,{onClick:he,children:[e.jsx(Y,{children:e.jsx(Fe,{sx:{fontSize:16,color:o.palette.text.secondary}})}),e.jsx(B,{primaryTypographyProps:{fontSize:"0.8125rem"},children:"Edit"})]}),e.jsxs(W,{onClick:ye,sx:{color:o.palette.text.primary},children:[e.jsx(Y,{children:e.jsx(_e,{sx:{fontSize:16,color:o.palette.text.secondary}})}),e.jsx(B,{primaryTypographyProps:{fontSize:"0.8125rem"},children:"Delete"})]})]}),e.jsx(de,{open:A,onClose:()=>v(!1),title:j?"Edit Data Source":"Add Data Source",subtitle:"Enter your database details to connect",width:520,children:e.jsx(Ne,{connection:j,onSave:Ce,onCancel:()=>v(!1),loading:C})}),e.jsx(He,{open:T,onClose:()=>P(!1),onConfirm:fe,title:"Remove Data Source",message:`Remove "${E?.name}"? This only removes it from NeuraReport and does not change your database. You can undo this within a few seconds.`,confirmLabel:"Remove",severity:"error",loading:C}),e.jsx(et,{open:F,onClose:()=>X(!1),connection:pe})]})}function kt(){return G(),e.jsx(st,{})}export{kt as default};
