import{b2 as Ct,b3 as kt,r as n,b4 as At,j as e,b5 as Et,b6 as It,J as Tt,T as g,b8 as Rt,c as le,B as a,d as dt,cE as ae,u as $e,R as ve,I as we,cF as Mt,cG as zt,S as b,o as ee,q as Dt,k,N as De,as as Se,bh as Lt,p as A,cH as Nt,aM as Ht,t as Ve,s as q,aN as ut,Q as ht,C as xt,v as xe,A as Le,n as V,bs as Ne,c4 as pt,cI as ft,bg as Pt,a0 as Ft,cJ as He,P as mt,cK as Ut,b as _t,cL as $t,f as Ye,cM as Wt,cN as Bt,cO as Ot,cP as Kt,bA as Vt,bB as Yt,cQ as Gt,cR as qt,aJ as ze,ak as Ge,al as qe,aG as Je,am as Qe,ao as Jt}from"./index-B8Eu23bA.js";import{T as We,a as ge,A as Qt}from"./ArrowBack-Cc4DCRzt.js";import{C as Xt}from"./Code-C_kZAZjt.js";import{S as Zt}from"./Save-CpotRqw9.js";import{A as er}from"./AutoFixHigh-C6xFegD4.js";import{F as Xe}from"./Fullscreen-onvHAcuw.js";import{S as tr}from"./Surface-DvkcgJ6N.js";import{L as rr}from"./Lightbulb-CLdW-uXX.js";import{K as sr,S as D}from"./KeyboardArrowDown-C4qqpONU.js";import{F as nr}from"./FilterList-lKi4AKs9.js";import{A as gt}from"./AccessTime-DOFLvw9F.js";import{G as se}from"./Grid-5L9Rvqba.js";import{R as Ze}from"./Restore-C-BeXrk4.js";import{C as ir}from"./ConfirmModal-Bm9QL03g.js";import{A as or}from"./AiUsageNotice-DRuwRFKl.js";import"./CheckCircleOutline-BKKyaL-x.js";import"./WarningAmber-DtVJgAFk.js";function ar(t){return Ct("MuiAlertTitle",t)}kt("MuiAlertTitle",["root"]);const lr=t=>{const{classes:r}=t;return It({root:["root"]},ar,r)},cr=Tt(g,{name:"MuiAlertTitle",slot:"Root"})(Rt(({theme:t})=>({fontWeight:t.typography.fontWeightMedium,marginTop:-2}))),dr=n.forwardRef(function(r,s){const o=At({props:r,name:"MuiAlertTitle"}),{className:i,...c}=o,m=o,d=lr(m);return e.jsx(cr,{gutterBottom:!0,component:"div",ownerState:m,ref:s,className:Et(d.root,i),...c})}),Pe=le(e.jsx("path",{d:"M9.01 14H2v2h7.01v3L13 15l-3.99-4zm5.98-1v-3H22V8h-7.01V5L11 9z"})),ur=le(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM8 9h8v10H8zm7.5-5-1-1h-5l-1 1H5v2h14V4z"})),et=le(e.jsx("path",{d:"M5 16h3v3h2v-5H5zm3-8H5v2h5V5H8zm6 11h2v-3h3v-2h-5zm2-11V5h-2v5h5V8z"})),hr=le(e.jsx("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"})),Fe=le(e.jsx("path",{d:"M19 13H5v-2h14z"})),xr=le(e.jsx("path",{d:"M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3m-2 10H6V7h12zm-9-6c-.83 0-1.5-.67-1.5-1.5S8.17 10 9 10s1.5.67 1.5 1.5S9.83 13 9 13m7.5-1.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5 1.5.67 1.5 1.5M8 15h8v2H8z"})),pr=le(e.jsx("path",{d:"M7.41 18.59 8.83 20 12 16.83 15.17 20l1.41-1.41L12 14zm9.18-13.18L15.17 4 12 7.17 8.83 4 7.41 5.41 12 10z"})),fr=le(e.jsx("path",{d:"M12 5.83 15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15z"})),tt={width:794,height:1123},mr=.01,gr=()=>typeof window<"u"&&window.devicePixelRatio?window.devicePixelRatio:1,rt=t=>{if(!t||t==="none"||t==="auto"||typeof t!="string")return null;const r=t.toLowerCase(),s=Number.parseFloat(r);if(!Number.isFinite(s)||s<=0)return null;if(r.endsWith("px"))return s;if(typeof window<"u"){if(r.endsWith("vh"))return window.innerHeight*(s/100);if(r.endsWith("vw"))return window.innerWidth*(s/100)}return null},br=t=>{if(!Number.isFinite(t)||t<=0)return 1;const r=gr(),s=Math.max(100,Math.round(r*100));return Math.max(mr,Math.round(t*s)/s)},yr=t=>{if(t==null)return null;const r=(s,o)=>{const i=Number(s),c=Number(o);return!Number.isFinite(i)||!Number.isFinite(c)||i<=0||c<=0?null:{css:`${i} / ${c}`,ratio:i/c}};if(Array.isArray(t)&&t.length===2)return r(t[0],t[1]);if(typeof t=="number")return t>0?r(t,1):null;if(typeof t=="string"){const s=t.trim();if(!s)return null;const o=s.match(/^(\d*\.?\d+)\s*\/\s*(\d*\.?\d+)$/);if(o)return r(o[1],o[2]);const i=Number(s);return Number.isFinite(i)&&i>0?r(i,1):{css:s,ratio:null}}return null};function Ue({src:t,title:r,pageWidth:s=tt.width,pageHeight:o=tt.height,sx:i,loading:c="lazy",background:m="white",frameAspectRatio:d=null,fit:y="contain",contentAlign:x="center",pageShadow:p=!1,pageBorderColor:u="rgba(15,23,42,0.12)",pageRadius:E=0,marginGuides:R=!1,clampToParentHeight:_=!1,pageChrome:T=!0}){const f=n.useRef(null),j=n.useRef(null),S=n.useRef(null),I=n.useRef(null),[X,te]=n.useState(1),[z,ne]=n.useState({width:s,height:o}),Z=n.useRef(z),W=n.useMemo(()=>yr(d),[d]),B=n.useMemo(()=>R?typeof R=="object"?{inset:Math.max(0,Number(R.inset??R.offset??36)),color:R.color||"rgba(79,70,229,0.28)"}:{inset:36,color:"rgba(79,70,229,0.28)"}:null,[R]),Y=n.useCallback(C=>{S.current&&cancelAnimationFrame(S.current),S.current=requestAnimationFrame(()=>{S.current=null,C()})},[]),L=n.useCallback(C=>{const w=C||Z.current,K=f.current;if(!K||!w.width||!w.height)return;const Q=K.getBoundingClientRect(),F=Q.width||K.clientWidth||w.width;let U=Q.height||K.clientHeight||0;if(!U&&W?.ratio&&(U=F/W.ratio),U||(U=w.height),_){let M=K.parentElement;for(;M;){const pe=M.getBoundingClientRect?.()?.height||M.clientHeight||0,fe=typeof window<"u"?window.getComputedStyle?.(M):null;if(fe){const ye=rt(fe.maxHeight);ye&&(U=Math.min(U,ye));const Ae=rt(fe.height);Ae&&(U=Math.min(U,Ae))}if(pe>0){U=Math.min(U,pe);break}M=M.parentElement}}const oe=F/w.width,re=U>0?U/w.height:oe;let $;y==="width"?($=oe,re>0&&re<$&&($=re)):y==="height"?$=re:$=Math.min(oe,re),(!Number.isFinite($)||$<=0)&&($=1);const ke=br($);te(M=>Math.abs(M-ke)<.002?M:ke)},[W?.ratio,y,_]),P=n.useCallback(C=>{const w={width:Math.max(1,Math.ceil(C?.width||s)),height:Math.max(1,Math.ceil(C?.height||o))};Z.current=w,ne(w),Y(()=>L(w))},[o,s,Y,L]),O=n.useCallback(()=>{const C={width:s,height:o},w=j.current;if(!w)return C;try{const K=w.contentDocument||w.contentWindow?.document;if(!K)return C;const Q=K.body,F=K.documentElement;Q&&(Q.style.overflow="hidden"),F&&(F.style.overflow="hidden");const U=Math.max(Q?.scrollWidth||0,Q?.offsetWidth||0,F?.scrollWidth||0,F?.offsetWidth||0,C.width),oe=Math.max(Q?.scrollHeight||0,Q?.offsetHeight||0,F?.scrollHeight||0,F?.offsetHeight||0,C.height);return{width:Math.ceil(U),height:Math.ceil(oe)}}catch{return C}},[o,s]),ce=n.useCallback(()=>{const C=O();P(C),I.current&&clearTimeout(I.current),I.current=setTimeout(()=>{I.current=null;const w=O();P(w)},150)},[P,O]);n.useEffect(()=>{const C=j.current;if(!C)return;const w=()=>ce();return C.addEventListener("load",w),()=>{C.removeEventListener("load",w)}},[ce,t]),n.useEffect(()=>{P({width:s,height:o})},[P,o,s,t]),n.useEffect(()=>{if(typeof ResizeObserver>"u")return;const C=f.current;if(!C)return;const w=new ResizeObserver(()=>Y(()=>L()));return w.observe(C),()=>w.disconnect()},[Y,L]),n.useEffect(()=>{const C=()=>Y(()=>L());return window.addEventListener("resize",C),()=>window.removeEventListener("resize",C)},[Y,L]),n.useEffect(()=>()=>{S.current&&cancelAnimationFrame(S.current),I.current&&clearTimeout(I.current)},[]);const de=z.height*X,G=z.width*X,ue=x==="top",ie={position:"relative",width:"100%",overflow:"hidden",...i};W?.css&&(ie.aspectRatio=W.css,ie.height="auto");const h=!!W?.css,J=T&&Number.isFinite(Number(E))?Math.max(Number(E),0):0,N=T&&p?typeof p=="string"?p:"0 32px 48px rgba(15,23,42,0.18)":"none",H=T&&typeof u=="string"&&u.trim()?u:null,Ce=T?m:"transparent",be=B?Math.max(0,Math.min(B.inset,Math.min(z.width,z.height)/2)):0;return e.jsxs(a,{ref:f,sx:ie,children:[e.jsx(a,{sx:{position:h?"absolute":"relative",top:h?ue?0:"50%":0,left:h?"50%":0,width:z.width,height:z.height,transform:`scale(${X})`,transformOrigin:"top left",pointerEvents:"auto"},style:h?{marginLeft:`${-G/2}px`,...ue?{}:{marginTop:`${-de/2}px`}}:void 0,children:e.jsxs(a,{sx:{width:z.width,height:z.height,borderRadius:J,overflow:"hidden",bgcolor:Ce,boxShadow:N,border:H?`1px solid ${H}`:"none",position:"relative"},children:[e.jsx("iframe",{ref:j,src:t,title:r,loading:c,style:{width:z.width,height:z.height,border:0,display:"block",background:T?m:void 0}}),B&&be>0&&e.jsx(a,{"aria-hidden":!0,sx:{position:"absolute",inset:be,border:"1px dashed",borderColor:B.color,borderRadius:Math.max(J-6,0),pointerEvents:"none"},style:{borderStyle:"dashed"}})]})}),!h&&e.jsx(a,{sx:{width:"100%",height:de,visibility:"hidden",pointerEvents:"none"}})]})}const jr={manual:"Manual edit",ai:"AI edit",undo:"Undo"},vr={manual:"primary",ai:"secondary",undo:"warning"},wr={manual:"filled",ai:"filled",undo:"outlined"},Ee=t=>String(t).padStart(2,"0"),Sr=t=>{if(!t)return null;const r=new Date(t);return Number.isNaN(r.getTime())?null:`${r.getFullYear()}-${Ee(r.getMonth()+1)}-${Ee(r.getDate())} ${Ee(r.getHours())}:${Ee(r.getMinutes())}`},Cr=t=>{if(!t||typeof t!="object")return null;const r=typeof t.lastEditType=="string"?t.lastEditType.trim().toLowerCase():null,s=r==="manual"||r==="ai"||r==="undo"?r:null,o=s?jr[s]:null,i=Sr(t.lastEditAt);if(!o&&!i)return null;const c=o&&i?`${o} · ${i}`:o||(i?`Edited ${i}`:null);return{type:s,typeLabel:o,timestampLabel:i,chipLabel:c,color:s&&vr[s]||"default",variant:s&&wr[s]||"outlined"}},st={user:{icon:Nt,label:"You",bgcolor:k[1200],textColor:"#fff"},assistant:{icon:xr,label:"NeuraReport",bgcolor:"background.paper",textColor:"text.primary"}};function kr({message:t}){const{role:r,content:s,timestamp:o}=t,i=st[r]||st.assistant,c=i.icon,m=r==="user";return e.jsxs(a,{sx:{display:"flex",flexDirection:m?"row-reverse":"row",gap:1.5,px:2,py:1.5},children:[e.jsx(a,{sx:{width:32,height:32,borderRadius:"50%",bgcolor:m?k[1200]:k[900],display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:e.jsx(c,{sx:{fontSize:18,color:"white"}})}),e.jsxs(a,{sx:{flex:1,maxWidth:m?"calc(100% - 100px)":"calc(100% - 48px)",minWidth:0},children:[e.jsxs(b,{direction:"row",spacing:1,alignItems:"center",sx:{mb:.5,justifyContent:m?"flex-end":"flex-start"},children:[e.jsx(g,{variant:"caption",fontWeight:600,color:"text.primary",children:i.label}),o&&e.jsx(g,{variant:"caption",color:"text.disabled",children:new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsx(a,{sx:{p:2,borderRadius:1,bgcolor:m?k[1200]:"background.paper",color:m?"#fff":"text.primary",boxShadow:m?"0 2px 8px rgba(33, 32, 28, 0.2)":"0 1px 3px rgba(0,0,0,0.08)"},children:e.jsxs(g,{variant:"body2",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word",lineHeight:1.6},children:[s,t.streaming&&e.jsx(a,{component:"span",sx:{display:"inline-block",width:6,height:16,ml:.5,bgcolor:"currentColor",animation:"blink 1s steps(1) infinite","@keyframes blink":{"50%":{opacity:0}}}})]})})]})]})}function Ar({changes:t,proposedHtml:r,onApply:s,onReject:o,applying:i}){const[c,m]=n.useState(!1),[d,y]=n.useState(null);return n.useEffect(()=>{if(!r){y(null);return}const x=new Blob([r],{type:"text/html"}),p=URL.createObjectURL(x);return y(p),()=>{URL.revokeObjectURL(p)}},[r]),!t||t.length===0?null:e.jsx(Ht,{elevation:0,sx:{p:2,mx:2,mb:2,borderRadius:1,border:"1px solid",borderColor:x=>A(x.palette.divider,.3),bgcolor:x=>x.palette.mode==="dark"?A(x.palette.text.primary,.04):k[200]},children:e.jsxs(b,{spacing:2,children:[e.jsxs(b,{direction:"row",alignItems:"center",spacing:1,children:[e.jsx(Ve,{sx:{color:"text.secondary"},fontSize:"small"}),e.jsx(g,{variant:"subtitle2",fontWeight:600,children:"Ready to Apply Changes"})]}),e.jsxs(a,{children:[e.jsx(g,{variant:"body2",color:"text.secondary",sx:{mb:1},children:"Proposed modifications:"}),e.jsx(b,{spacing:.5,children:t.map((x,p)=>e.jsxs(b,{direction:"row",spacing:1,alignItems:"flex-start",children:[e.jsx(g,{variant:"body2",color:"text.secondary",children:"•"}),e.jsx(g,{variant:"body2",children:x})]},p))})]}),r&&e.jsxs(a,{children:[e.jsx(q,{size:"small",variant:"text",onClick:()=>m(!c),endIcon:c?e.jsx(ut,{}):e.jsx(ht,{}),sx:{mb:1},children:c?"Hide Preview":"Show Preview"}),e.jsx(xt,{in:c,children:e.jsx(a,{sx:{borderRadius:1,border:"1px solid",borderColor:"divider",bgcolor:"background.paper",p:1,height:300,overflow:"hidden"},children:d&&e.jsx(Ue,{src:d,title:"Proposed changes preview",fit:"contain",pageShadow:!0,frameAspectRatio:"210 / 297"})})})]}),e.jsxs(b,{direction:"row",spacing:1.5,children:[e.jsx(q,{variant:"contained",onClick:s,disabled:i,startIcon:i?e.jsx(Se,{size:16}):e.jsx(Ve,{}),children:i?"Applying...":"Apply Changes"}),e.jsx(q,{variant:"outlined",color:"inherit",onClick:o,disabled:i,children:"Request Different Changes"})]})]})})}function Er({questions:t,onQuestionClick:r}){return!t||t.length===0?null:e.jsxs(a,{sx:{px:2,pb:1.5},children:[e.jsxs(b,{direction:"row",alignItems:"center",spacing:1,sx:{mb:1},children:[e.jsx(rr,{fontSize:"small",color:"action"}),e.jsx(g,{variant:"caption",color:"text.secondary",children:"Quick responses:"})]}),e.jsx(b,{direction:"row",flexWrap:"wrap",gap:1,children:t.map((s,o)=>e.jsx(xe,{label:s,size:"small",variant:"outlined",onClick:()=>r(s),sx:{cursor:"pointer","&:hover":{bgcolor:"action.hover"}}},o))})]})}function Ir({templateId:t,templateName:r,currentHtml:s,onHtmlUpdate:o,onApplySuccess:i}){const c=dt(),m=n.useRef(null),d=n.useRef(null),[y,x]=n.useState(""),[p,u]=n.useState(!1),[E,R]=n.useState(!1),[_,T]=n.useState(null),f=ae(h=>h.getOrCreateSession),j=ae(h=>h.getSession),S=ae(h=>h.addUserMessage),I=ae(h=>h.addAssistantMessage),X=ae(h=>h.getMessagesForApi),te=ae(h=>h.setProposedChanges),z=ae(h=>h.clearProposedChanges),ne=ae(h=>h.clearSession),{execute:Z}=$e();n.useEffect(()=>{t&&f(t,r)},[t,r,f]);const W=j(t),B=W?.messages||[],Y=W?.proposedChanges,L=W?.proposedHtml,P=W?.readyToApply;n.useEffect(()=>{m.current?.scrollIntoView({behavior:"smooth"})},[B.length]),n.useEffect(()=>{d.current?.focus()},[]);const O=n.useCallback(async()=>{const h=y.trim();!h||p||!t||(x(""),T(null),S(t,h),await Z({type:we.GENERATE,label:"Generate edit suggestions",reversibility:ve.FULLY_REVERSIBLE,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{templateId:t,action:"template_chat"},action:async()=>{u(!0);try{const J=[...X(t),{role:"user",content:h}],N=await Mt(t,J,s);return I(t,N.message,{proposedChanges:N.proposed_changes,proposedHtml:N.updated_html,readyToApply:N.ready_to_apply}),te(t,{proposedChanges:N.proposed_changes,proposedHtml:N.updated_html,readyToApply:N.ready_to_apply}),N.follow_up_questions&&T(N.follow_up_questions),N}catch(J){throw c.show(String(J.message||J),"error"),I(t,"I apologize, but I encountered an error. Please try again or rephrase your request."),J}finally{u(!1)}}}))},[y,p,t,s,S,I,X,te,c,Z]),ce=n.useCallback(async()=>{!L||!t||await Z({type:we.UPDATE,label:"Apply template changes",reversibility:ve.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{templateId:t,action:"apply_template_changes"},action:async()=>{R(!0);try{const h=await zt(t,L);return z(t),o?.(L),i?.(h),I(t,"The changes have been applied successfully. Is there anything else you'd like to modify?"),c.show("Template changes applied successfully.","success"),h}catch(h){throw c.show(String(h.message||h),"error"),h}finally{R(!1)}}})},[L,t,z,I,o,i,c,Z]),de=n.useCallback(()=>{z(t),I(t,"No problem! What different changes would you like me to make instead?")},[t,z,I]),G=n.useCallback(h=>{x(h),T(null),d.current?.focus()},[]),ue=n.useCallback(h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),O())},[O]),ie=n.useCallback(()=>{ne(t,r),T(null),c.show("Chat cleared. Starting fresh conversation.","info")},[t,r,ne,c]);return e.jsxs(a,{sx:{height:"100%",display:"flex",flexDirection:"column",bgcolor:"background.default",borderRadius:1,border:"1px solid",borderColor:"divider",overflow:"hidden"},children:[e.jsx(a,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.paper"},children:e.jsxs(b,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(a,{children:[e.jsx(g,{variant:"subtitle1",fontWeight:600,children:"AI Template Editor"}),e.jsx(g,{variant:"caption",color:"text.secondary",children:"Describe the changes you want and I'll help you implement them"})]}),e.jsx(ee,{size:"small",onClick:ie,title:"Clear chat and start over",children:e.jsx(Dt,{fontSize:"small"})})]})}),e.jsxs(a,{sx:{flex:1,overflow:"auto",py:1},children:[B.map(h=>e.jsx(kr,{message:h},h.id)),e.jsx("div",{ref:m})]}),P&&Y&&e.jsx(Ar,{changes:Y,proposedHtml:L,onApply:ce,onReject:de,applying:E}),e.jsx(Er,{questions:_,onQuestionClick:G}),e.jsxs(a,{sx:{p:2,borderTop:"1px solid",borderColor:"divider",bgcolor:"background.paper"},children:[e.jsxs(a,{sx:{display:"flex",gap:1,p:1.5,borderRadius:1,bgcolor:h=>A(h.palette.action.hover,.5),border:1,borderColor:"divider",transition:"all 150ms ease","&:focus-within":{borderColor:h=>h.palette.mode==="dark"?k[1e3]:k[1100],boxShadow:h=>`0 0 0 2px ${A(h.palette.text.primary,.08)}`}},children:[e.jsx(De,{inputRef:d,fullWidth:!0,multiline:!0,maxRows:4,placeholder:p?"Processing...":P?"Apply the changes above or describe different modifications...":"Describe what changes you want to make to the template...",value:y,onChange:h=>x(h.target.value),onKeyDown:ue,disabled:p,variant:"standard",InputProps:{disableUnderline:!0,sx:{fontSize:"0.9375rem",lineHeight:1.5}},sx:{"& .MuiInputBase-root":{py:.5}}}),e.jsx(ee,{onClick:O,disabled:!y.trim()||p,sx:{bgcolor:h=>y.trim()&&!p?h.palette.mode==="dark"?k[1100]:k[1200]:"action.disabledBackground",color:y.trim()&&!p?"#fff":"text.disabled","&:hover":{bgcolor:h=>y.trim()&&!p?h.palette.mode==="dark"?k[1e3]:k[1100]:"action.disabledBackground"}},children:p?e.jsx(Se,{size:20,color:"inherit"}):e.jsx(Lt,{fontSize:"small"})})]}),e.jsx(b,{direction:"row",spacing:2,justifyContent:"center",sx:{mt:1},children:e.jsx(g,{variant:"caption",color:"text.disabled",children:"Press Enter to send, Shift+Enter for new line"})})]})]})}function he(t){if(!t)return null;const r=t.replace(/(&lt;|<)(\/?)([\w-]+)/g,(s,o,i,c)=>`<span class="html-bracket">&lt;</span><span class="html-slash">${i}</span><span class="html-tag">${c}</span>`).replace(/(\s)([\w-]+)(=)/g,(s,o,i,c)=>`${o}<span class="html-attr">${i}</span><span class="html-eq">=</span>`).replace(/("[^"]*"|'[^']*')/g,'<span class="html-string">$1</span>').replace(/(>)/g,'<span class="html-bracket">$1</span>').replace(/(\{[^}]+\})/g,'<span class="html-token">$1</span>');return e.jsx("span",{dangerouslySetInnerHTML:{__html:r}})}function Tr(t,r,s=3){const o=(t||"").split(`
`),i=(r||"").split(`
`),c=[],m=Math.max(o.length,i.length);let d=null;const y=[];for(let x=0;x<m;x++){const p=o[x]??null,u=i[x]??null;p===u&&p!==null?(d===null&&(d=x),y.push({type:"unchanged",lineNumber:{before:x+1,after:x+1},content:p})):(y.length>0&&(y.length<=s*2+1?c.push(...y):(c.push(...y.slice(0,s)),c.push({type:"collapsed",count:y.length-s*2,startLine:d+s+1}),c.push(...y.slice(-s))),y.length=0,d=null),p!==null&&u!==null?c.push({type:"modified",lineNumber:{before:x+1,after:x+1},beforeContent:p,afterContent:u}):p!==null?c.push({type:"removed",lineNumber:{before:x+1,after:null},content:p}):u!==null&&c.push({type:"added",lineNumber:{before:null,after:x+1},content:u}))}return y.length>0&&(y.length<=s?c.push(...y):(c.push(...y.slice(0,s)),y.length>s&&c.push({type:"collapsed",count:y.length-s,startLine:d+s+1}))),c}function Rr({item:t,viewMode:r,expanded:s,onToggleExpand:o,syntaxHighlight:i}){const c={width:48,minWidth:48,px:1,py:.5,bgcolor:"action.hover",color:"text.disabled",fontFamily:"monospace",fontSize:"0.75rem",textAlign:"right",userSelect:"none",borderRight:"1px solid",borderColor:"divider"},m={flex:1,px:1.5,py:.5,fontFamily:"monospace",fontSize:"0.8rem",whiteSpace:"pre-wrap",wordBreak:"break-all",minHeight:24,"& .html-tag":{color:"#569cd6"},"& .html-attr":{color:"#9cdcfe"},"& .html-string":{color:"#ce9178"},"& .html-bracket":{color:"#808080"},"& .html-slash":{color:"#808080"},"& .html-eq":{color:"#d4d4d4"},"& .html-token":{color:"#dcdcaa",fontWeight:600}};return t.type==="collapsed"?e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"center",py:.5,px:2,bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.04):k[200],borderTop:"1px dashed",borderBottom:"1px dashed",borderColor:"divider",cursor:"pointer","&:hover":{bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.08):k[300]}},onClick:()=>o?.(t.startLine),children:[e.jsx(fr,{fontSize:"small",sx:{mr:1,color:"text.secondary"}}),e.jsxs(g,{variant:"caption",color:"text.secondary",children:[t.count," unchanged lines (click to expand)"]})]}):t.type==="unchanged"?e.jsxs(a,{sx:{display:"flex",bgcolor:"transparent"},children:[e.jsx(a,{sx:c,children:t.lineNumber.before}),r==="split"&&e.jsx(a,{sx:c,children:t.lineNumber.after}),e.jsx(a,{sx:m,children:i?he(t.content):t.content})]}):t.type==="removed"?e.jsxs(a,{sx:{display:"flex",bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.04):k[200]},children:[e.jsx(a,{sx:{...c,bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.08):k[300]},children:t.lineNumber.before}),r==="split"&&e.jsx(a,{sx:c}),e.jsxs(a,{sx:{...m,color:"text.secondary",textDecoration:"line-through"},children:[e.jsx(Fe,{sx:{fontSize:14,mr:.5,verticalAlign:"middle"}}),i?he(t.content):t.content]})]}):t.type==="added"?e.jsxs(a,{sx:{display:"flex",bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.06):k[400]},children:[e.jsx(a,{sx:c}),r==="split"&&e.jsx(a,{sx:{...c,bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.1):k[500]},children:t.lineNumber.after}),e.jsxs(a,{sx:{...m,color:"text.primary"},children:[e.jsx(Le,{sx:{fontSize:14,mr:.5,verticalAlign:"middle"}}),i?he(t.content):t.content]})]}):t.type==="modified"?r==="split"?e.jsx(e.Fragment,{children:e.jsxs(a,{sx:{display:"flex",bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.04):k[200]},children:[e.jsx(a,{sx:{...c,bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.08):k[300]},children:t.lineNumber.before}),e.jsx(a,{sx:{...m,color:"text.secondary",textDecoration:"line-through",flex:.5},children:i?he(t.beforeContent):t.beforeContent}),e.jsx(a,{sx:{...c,bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.1):k[500]},children:t.lineNumber.after}),e.jsx(a,{sx:{...m,color:"text.primary",flex:.5},children:i?he(t.afterContent):t.afterContent})]})}):e.jsxs(e.Fragment,{children:[e.jsxs(a,{sx:{display:"flex",bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.04):k[200]},children:[e.jsx(a,{sx:{...c,bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.08):k[300]},children:t.lineNumber.before}),e.jsxs(a,{sx:{...m,color:"text.secondary",textDecoration:"line-through"},children:[e.jsx(Fe,{sx:{fontSize:14,mr:.5,verticalAlign:"middle"}}),i?he(t.beforeContent):t.beforeContent]})]}),e.jsxs(a,{sx:{display:"flex",bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.06):k[400]},children:[e.jsx(a,{sx:{...c,bgcolor:d=>d.palette.mode==="dark"?A(d.palette.text.primary,.1):k[500]},children:t.lineNumber.after}),e.jsxs(a,{sx:{...m,color:"text.primary"},children:[e.jsx(Le,{sx:{fontSize:14,mr:.5,verticalAlign:"middle"}}),i?he(t.afterContent):t.afterContent]})]})]}):null}function Mr({beforeText:t,afterText:r,contextLines:s=3}){const[o,i]=n.useState("unified"),[c,m]=n.useState(!0),[d,y]=n.useState(new Set),[x,p]=n.useState(0),u=n.useMemo(()=>Tr(t,r,s),[t,r,s]),E=n.useMemo(()=>{let f=0,j=0,S=0;return u.forEach(I=>{I.type==="added"&&f++,I.type==="removed"&&j++,I.type==="modified"&&S++}),{added:f,removed:j,modified:S,total:f+j+S}},[u]),R=n.useMemo(()=>u.map((f,j)=>f.type!=="unchanged"&&f.type!=="collapsed"?j:null).filter(f=>f!==null),[u]),_=f=>{y(j=>{const S=new Set(j);return S.has(f)?S.delete(f):S.add(f),S})},T=f=>{if(R.length===0)return;let j=x+f;j<0&&(j=R.length-1),j>=R.length&&(j=0),p(j)};return!t&&!r?e.jsx(a,{sx:{p:3,textAlign:"center"},children:e.jsx(g,{color:"text.secondary",children:"No content to compare"})}):t===r?e.jsx(a,{sx:{p:3,textAlign:"center"},children:e.jsx(g,{color:"text.secondary",children:"No differences found"})}):e.jsxs(a,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs(b,{direction:"row",spacing:2,alignItems:"center",justifyContent:"space-between",sx:{px:2,py:1,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsxs(b,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(xe,{size:"small",icon:e.jsx(Le,{}),label:`+${E.added}`,variant:"outlined",sx:{borderColor:f=>A(f.palette.divider,.3),color:"text.secondary"}}),e.jsx(xe,{size:"small",icon:e.jsx(Fe,{}),label:`-${E.removed}`,variant:"outlined",sx:{borderColor:f=>A(f.palette.divider,.3),color:"text.secondary"}}),E.modified>0&&e.jsx(xe,{size:"small",icon:e.jsx(Pe,{}),label:`~${E.modified}`,variant:"outlined",sx:{borderColor:f=>A(f.palette.divider,.3),color:"text.secondary"}})]}),e.jsxs(b,{direction:"row",spacing:1,alignItems:"center",children:[R.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(g,{variant:"caption",color:"text.secondary",children:[x+1," / ",R.length]}),e.jsx(V,{title:"Previous change",children:e.jsx(ee,{size:"small",onClick:()=>T(-1),"aria-label":"Previous change",children:e.jsx(hr,{fontSize:"small"})})}),e.jsx(V,{title:"Next change",children:e.jsx(ee,{size:"small",onClick:()=>T(1),"aria-label":"Next change",children:e.jsx(sr,{fontSize:"small"})})})]}),e.jsxs(We,{size:"small",value:o,exclusive:!0,onChange:(f,j)=>j&&i(j),children:[e.jsx(ge,{value:"unified",children:e.jsx(V,{title:"Unified view",children:e.jsx(pr,{fontSize:"small"})})}),e.jsx(ge,{value:"split",children:e.jsx(V,{title:"Split view",children:e.jsx(Pe,{fontSize:"small"})})})]})]})]}),e.jsx(a,{sx:{flex:1,overflow:"auto",bgcolor:"background.default","& > *:nth-of-type(even)":{bgcolor:f=>A(f.palette.action.hover,.3)}},children:u.map((f,j)=>e.jsx(Rr,{item:f,viewMode:o,syntaxHighlight:c,onToggleExpand:_},j))})]})}const Ie={manual:{icon:Ft,label:"Manual",color:"default"},ai:{icon:Pt,label:"AI",color:"default"},chat:{icon:ft,label:"Chat AI",color:"default"},undo:{icon:pt,label:"Undo",color:"default"},default:{icon:Ne,label:"Edit",color:"default"}};function zr(t){if(!t)return"Unknown time";const r=new Date(t),o=new Date-r,i=Math.floor(o/1e3),c=Math.floor(i/60),m=Math.floor(c/60),d=Math.floor(m/24);return i<60?"Just now":c<60?`${c}m ago`:m<24?`${m}h ago`:d<7?`${d}d ago`:r.toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Dr({entry:t,isLatest:r}){const s=Ie[t.type]||Ie.default,o=s.icon;return e.jsxs(a,{sx:{display:"flex",gap:1.5,py:1,px:1.5,borderRadius:1,bgcolor:r?i=>i.palette.mode==="dark"?A(i.palette.text.primary,.04):k[200]:"transparent","&:hover":{bgcolor:"action.hover"}},children:[e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",pt:.5},children:[e.jsx(a,{sx:{width:28,height:28,borderRadius:"50%",bgcolor:i=>i.palette.mode==="dark"?A(i.palette.text.primary,.08):k[300],display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(o,{sx:{fontSize:16,color:"text.secondary"}})}),e.jsx(a,{sx:{width:2,flex:1,mt:.5,bgcolor:"divider",minHeight:8}})]}),e.jsxs(a,{sx:{flex:1,minWidth:0},children:[e.jsxs(b,{direction:"row",spacing:1,alignItems:"center",sx:{mb:.25},children:[e.jsx(xe,{label:s.label,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem",borderColor:i=>A(i.palette.divider,.3),color:"text.secondary"}}),r&&e.jsx(xe,{label:"Latest",size:"small",sx:{height:20,fontSize:"0.7rem",bgcolor:i=>i.palette.mode==="dark"?k[1100]:k[1200],color:"#fff"}})]}),t.notes&&e.jsx(g,{variant:"body2",color:"text.primary",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"100%"},children:t.notes}),e.jsxs(b,{direction:"row",spacing:.5,alignItems:"center",sx:{mt:.5},children:[e.jsx(gt,{sx:{fontSize:12,color:"text.disabled"}}),e.jsx(g,{variant:"caption",color:"text.disabled",children:zr(t.timestamp)})]})]})]})}const nt=500;function Lr({history:t=[],maxVisible:r=5}){const[s,o]=n.useState(!1),[i,c]=n.useState("all"),m=n.useMemo(()=>{if(!Array.isArray(t))return[];let u=[...t.length>nt?t.slice(-nt):t].reverse();return i!=="all"&&(u=u.filter(E=>E.type===i)),u},[t,i]),d=s?m:m.slice(0,r),y=m.length>r,x=n.useMemo(()=>{const p=new Set(["all"]);return t.forEach(u=>{u.type&&p.add(u.type)}),Array.from(p)},[t]);return!t||t.length===0?e.jsxs(a,{sx:{py:2,px:1.5,textAlign:"center"},children:[e.jsx(Ne,{sx:{fontSize:32,color:"text.disabled",mb:1}}),e.jsx(g,{variant:"body2",color:"text.secondary",children:"No edit history yet"}),e.jsx(g,{variant:"caption",color:"text.disabled",children:"Your changes will appear here"})]}):e.jsxs(a,{children:[e.jsxs(b,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:1},children:[e.jsxs(b,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(Ne,{fontSize:"small",color:"action"}),e.jsx(g,{variant:"subtitle2",children:"History"}),e.jsx(xe,{label:m.length,size:"small",sx:{height:18,fontSize:"0.7rem"}})]}),x.length>2&&e.jsxs(We,{size:"small",value:i,exclusive:!0,onChange:(p,u)=>u&&c(u),sx:{"& .MuiToggleButton-root":{py:.25,px:.75,fontSize:"0.7rem"}},children:[e.jsx(ge,{value:"all",children:e.jsx(V,{title:"All edits",children:e.jsx(nr,{sx:{fontSize:14}})})}),x.filter(p=>p!=="all").map(p=>{const u=Ie[p]||Ie.default,E=u.icon;return e.jsx(ge,{value:p,children:e.jsx(V,{title:u.label,children:e.jsx(E,{sx:{fontSize:14}})})},p)})]})]}),e.jsxs(a,{sx:{borderRadius:1.5,border:"1px solid",borderColor:"divider",bgcolor:"background.paper",overflow:"hidden"},children:[d.map((p,u)=>e.jsx(Dr,{entry:p,isLatest:u===0},`${p.timestamp}-${u}`)),y&&e.jsx(a,{sx:{borderTop:"1px solid",borderColor:"divider",py:.75,textAlign:"center"},children:e.jsx(ee,{size:"small",onClick:()=>o(!s),sx:{fontSize:"0.8rem"},children:s?e.jsxs(e.Fragment,{children:[e.jsx(ut,{fontSize:"small"}),e.jsx(g,{variant:"caption",sx:{ml:.5},children:"Show less"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ht,{fontSize:"small"}),e.jsxs(g,{variant:"caption",sx:{ml:.5},children:["Show ",m.length-r," more"]})]})})})]})]})}function Nr({mode:t="manual"}){return e.jsxs(se,{container:!0,spacing:2.5,sx:{alignItems:"stretch"},children:[e.jsx(se,{size:{xs:12,md:t==="chat"?5:6},sx:{minWidth:0},children:e.jsxs(b,{spacing:1.5,sx:{height:"100%"},children:[e.jsx(D,{variant:"text",width:80,height:28}),e.jsx(a,{sx:{borderRadius:1.5,border:"1px solid",borderColor:"divider",bgcolor:"background.paper",p:1.5,minHeight:t==="chat"?400:200,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(D,{variant:"rectangular",width:"80%",height:t==="chat"?350:180,sx:{borderRadius:1}})}),e.jsx(D,{variant:"text",width:150,height:20})]})}),e.jsx(se,{size:{xs:12,md:t==="chat"?7:6},sx:{minWidth:0},children:t==="chat"?e.jsxs(a,{sx:{height:600,borderRadius:1,border:"1px solid",borderColor:"divider",overflow:"hidden",display:"flex",flexDirection:"column"},children:[e.jsxs(a,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(D,{variant:"text",width:180,height:28}),e.jsx(D,{variant:"text",width:250,height:18})]}),e.jsx(a,{sx:{flex:1,p:2},children:e.jsx(b,{spacing:2,children:[1,2,3].map(r=>e.jsxs(b,{direction:"row",spacing:1.5,children:[e.jsx(D,{variant:"circular",width:32,height:32}),e.jsxs(a,{sx:{flex:1},children:[e.jsx(D,{variant:"text",width:80,height:18}),e.jsx(D,{variant:"rectangular",width:"80%",height:60,sx:{borderRadius:1,mt:.5}})]})]},r))})}),e.jsx(a,{sx:{p:2,borderTop:"1px solid",borderColor:"divider"},children:e.jsx(D,{variant:"rectangular",height:56,sx:{borderRadius:1}})})]}):e.jsxs(b,{spacing:1.5,sx:{height:"100%"},children:[e.jsx(D,{variant:"text",width:150,height:28}),e.jsx(D,{variant:"rectangular",height:260,sx:{borderRadius:1}}),e.jsx(D,{variant:"rectangular",height:100,sx:{borderRadius:1}}),e.jsxs(b,{direction:"row",spacing:1.5,children:[e.jsx(D,{variant:"rectangular",width:100,height:36,sx:{borderRadius:1}}),e.jsx(D,{variant:"rectangular",width:120,height:36,sx:{borderRadius:1}}),e.jsx(D,{variant:"rectangular",width:130,height:36,sx:{borderRadius:1}}),e.jsx(D,{variant:"rectangular",width:90,height:36,sx:{borderRadius:1}})]}),e.jsx(D,{variant:"text",width:350,height:18}),e.jsxs(a,{children:[e.jsx(D,{variant:"text",width:80,height:24}),e.jsx(b,{spacing:.5,sx:{mt:1},children:[1,2,3].map(r=>e.jsx(D,{variant:"text",width:`${90-r*10}%`,height:18},r))})]})]})})]})}function Hr({onSave:t,onUndo:r,onRedo:s,onApplyAi:o,onEscape:i,enabled:c=!0,dirty:m=!1,hasInstructions:d=!1}){const y=n.useCallback(x=>{if(!c)return;const u=navigator.platform.toUpperCase().indexOf("MAC")>=0?x.metaKey:x.ctrlKey,E=x.shiftKey;if(u&&x.key==="s"){x.preventDefault(),m&&t&&t();return}if(u&&x.key==="z"&&!E){x.preventDefault(),r&&r();return}if(u&&x.key==="z"&&E){x.preventDefault(),s&&s();return}if(u&&x.key==="Enter"&&d){x.preventDefault(),o&&o();return}if(x.key==="Escape"){i&&i();return}},[c,m,d,t,r,s,o,i]);n.useEffect(()=>{if(c)return window.addEventListener("keydown",y),()=>{window.removeEventListener("keydown",y)}},[c,y])}function _e(t){const s=typeof navigator<"u"&&navigator.platform.toUpperCase().indexOf("MAC")>=0?"⌘":"Ctrl";return{save:`${s}+S`,undo:`${s}+Z`,redo:`${s}+Shift+Z`,applyAi:`${s}+Enter`}[t]||t}const it=[{key:"save",label:"Save HTML",description:"Save current changes"},{key:"undo",label:"Undo",description:"Revert to previous version"},{key:"applyAi",label:"Apply AI",description:"Apply AI instructions (when filled)"}];function Pr({children:t}){return e.jsx(a,{component:"kbd",sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",px:.75,py:.25,minWidth:24,height:22,borderRadius:.5,bgcolor:"background.paper",border:"1px solid",borderColor:"divider",boxShadow:r=>`0 1px 0 ${A(r.palette.common.black,.1)}`,fontFamily:"monospace",fontSize:"0.7rem",fontWeight:600,color:"text.secondary"},children:t})}function ot({shortcutKey:t}){const s=_e(t).split("+");return e.jsx(b,{direction:"row",spacing:.5,alignItems:"center",children:s.map((o,i)=>e.jsx(Pr,{children:o},i))})}function at({compact:t=!1}){return t?e.jsxs(b,{direction:"row",spacing:2,sx:{py:1,px:1.5,borderRadius:1,bgcolor:r=>r.palette.mode==="dark"?A(r.palette.text.primary,.04):k[200],border:"1px solid",borderColor:r=>A(r.palette.divider,.1)},children:[e.jsxs(b,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(He,{sx:{fontSize:14,color:"text.disabled"}}),e.jsx(g,{variant:"caption",color:"text.disabled",children:"Shortcuts:"})]}),it.slice(0,3).map(r=>e.jsxs(b,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ot,{shortcutKey:r.key}),e.jsx(g,{variant:"caption",color:"text.secondary",children:r.label})]},r.key))]}):e.jsxs(a,{sx:{p:2,borderRadius:1.5,bgcolor:"background.paper",border:"1px solid",borderColor:"divider"},children:[e.jsxs(b,{direction:"row",spacing:1,alignItems:"center",sx:{mb:2},children:[e.jsx(He,{fontSize:"small",color:"action"}),e.jsx(g,{variant:"subtitle2",children:"Keyboard Shortcuts"})]}),e.jsx(b,{spacing:1.5,children:it.map(r=>e.jsxs(b,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(a,{children:[e.jsx(g,{variant:"body2",children:r.label}),e.jsx(g,{variant:"caption",color:"text.secondary",children:r.description})]}),e.jsx(ot,{shortcutKey:r.key})]},r.key))})]})}function bt(t){if(!t)return"Unknown time";const r=new Date(t),o=new Date-r,i=Math.floor(o/6e4),c=Math.floor(i/60);return i<1?"Just now":i<60?`${i} minute${i>1?"s":""} ago`:c<24?`${c} hour${c>1?"s":""} ago`:r.toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Fr({show:t,draftData:r,onRestore:s,onDiscard:o,restoring:i=!1}){return!t||!r?null:e.jsx(xt,{in:t,children:e.jsxs(mt,{severity:"info",icon:e.jsx(Ze,{}),sx:{mb:2,borderRadius:1,"& .MuiAlert-message":{width:"100%"}},action:e.jsxs(b,{direction:"row",spacing:1,children:[e.jsx(q,{size:"small",variant:"contained",startIcon:e.jsx(Ze,{}),onClick:s,disabled:i,children:i?"Restoring...":"Restore"}),e.jsx(q,{size:"small",variant:"outlined",color:"inherit",startIcon:e.jsx(ur,{}),onClick:o,disabled:i,children:"Discard"})]}),children:[e.jsx(dr,{sx:{fontWeight:600},children:"Unsaved Draft Found"}),e.jsxs(b,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(g,{variant:"body2",children:"You have unsaved changes from a previous session."}),e.jsxs(b,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(gt,{sx:{fontSize:14,color:"text.secondary"}}),e.jsx(g,{variant:"caption",color:"text.secondary",children:bt(r.savedAt)})]})]})]})})}function Ur({lastSaved:t,dirty:r}){return!t&&!r?null:e.jsxs(b,{direction:"row",spacing:.5,alignItems:"center",sx:{py:.5,px:1,borderRadius:1,bgcolor:s=>r?A(s.palette.text.primary,.05):A(s.palette.text.primary,.05)},children:[e.jsx(a,{sx:{width:6,height:6,borderRadius:"50%",bgcolor:"text.secondary"}}),e.jsx(g,{variant:"caption",color:"text.secondary",children:r?"Unsaved changes":t?`Draft saved ${bt(t)}`:"All changes saved"})]})}const lt="neura-template-draft-",ct=1440*60*1e3;function _r(t,{autoSaveInterval:r=1e4,enabled:s=!0}={}){const[o,i]=n.useState(!1),[c,m]=n.useState(null),[d,y]=n.useState(null),x=n.useRef(null),p=n.useRef(null),u=`${lt}${t}`;n.useEffect(()=>{if(!(!t||!s))try{const f=localStorage.getItem(u);if(f){const j=JSON.parse(f);Date.now()-(j.savedAt||0)<ct?(i(!0),m(j)):localStorage.removeItem(u)}}catch(f){console.warn("Failed to load draft:",f)}},[t,u,s]),n.useEffect(()=>{if(s)try{Object.keys(localStorage).filter(j=>j.startsWith(lt)).forEach(j=>{try{const S=localStorage.getItem(j);if(S){const I=JSON.parse(S);Date.now()-(I.savedAt||0)>=ct&&localStorage.removeItem(j)}}catch{localStorage.removeItem(j)}})}catch(f){console.warn("Failed to clean up drafts:",f)}},[s]);const E=n.useCallback((f,j="")=>{if(!t||!s)return!1;try{const S={html:f,instructions:j,savedAt:Date.now(),templateId:t};return localStorage.setItem(u,JSON.stringify(S)),y(new Date),!0}catch(S){return console.warn("Failed to save draft:",S),!1}},[t,u,s]),R=n.useCallback(()=>{if(t)try{localStorage.removeItem(u),i(!1),m(null)}catch(f){console.warn("Failed to discard draft:",f)}},[t,u]),_=n.useCallback((f,j="")=>{s&&(p.current={html:f,instructions:j},x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{p.current&&E(p.current.html,p.current.instructions)},r))},[s,r,E]);n.useEffect(()=>()=>{x.current&&clearTimeout(x.current)},[]);const T=n.useCallback(()=>{R()},[R]);return{hasDraft:o,draftData:c,lastSaved:d,saveDraft:E,discardDraft:R,scheduleAutoSave:_,clearDraftAfterSave:T}}const $r={gap:{xs:2,md:2.5}},Wr=n.forwardRef(function(r,s){return e.jsx("textarea",{...r,ref:s})});function Br(){const{templateId:t}=Ut(),r=_t(),s=$t(),o=dt(),{execute:i}=$e(),c=Ye(l=>l.templates),m=Ye(l=>l.updateTemplate),d=s.state?.from||"/generate",y=n.useMemo(()=>c.find(l=>l.id===t)||null,[c,t]),[x,p]=n.useState(!0),[u,E]=n.useState(""),[R,_]=n.useState(""),[T,f]=n.useState(""),[j,S]=n.useState(null),[I,X]=n.useState(!1),[te,z]=n.useState(!1),[ne,Z]=n.useState(!1),[W,B]=n.useState(null),[Y,L]=n.useState(null),[P,O]=n.useState([]),[ce,de]=n.useState(null),[G,ue]=n.useState("manual"),[ie,h]=n.useState(!1),[J,N]=n.useState(!1),[H,Ce]=n.useState(!1),[be,C]=n.useState({open:!1,nextMode:null}),w=u!==R,K=(T||"").trim().length>0,{hasDraft:Q,draftData:F,lastSaved:U,scheduleAutoSave:oe,discardDraft:re,clearDraftAfterSave:$,saveDraft:ke}=_r(t,{enabled:G==="manual"});n.useEffect(()=>{w&&G==="manual"&&oe(u,T)},[u,T,w,G,oe]);const M=n.useCallback(l=>{!l||!t||typeof m!="function"||m(t,v=>{if(!v)return v;const je=v.generator||{},Me={...je.summary||{}},St=["lastEditType","lastEditAt","lastEditNotes"];let Ke=!1;return St.forEach(me=>{Object.prototype.hasOwnProperty.call(l,me)&&l[me]!==void 0&&Me[me]!==l[me]&&(Me[me]=l[me],Ke=!0)}),Ke?{...v,generator:{...je,summary:Me}}:v})},[t,m]),Te=n.useCallback(async()=>{if(t){p(!0),de(null);try{const l=await Wt(t),v=typeof l?.html=="string"?l.html:"";E(v),_(v),B(l?.metadata||null),L(l?.diff_summary||null),O(Array.isArray(l?.history)?l.history:[]),l?.metadata&&M(l.metadata)}catch(l){de(String(l?.message||l)),o.show(String(l),"error")}finally{p(!1)}}},[t,o,M]);n.useEffect(()=>{Te()},[Te]),n.useEffect(()=>{if(!u){S(null);return}const l=new Blob([u],{type:"text/html"}),v=URL.createObjectURL(l);return S(v),()=>{URL.revokeObjectURL(v)}},[u]),n.useEffect(()=>{const l=v=>{w&&(v.preventDefault(),v.returnValue="")};return window.addEventListener("beforeunload",l),()=>{window.removeEventListener("beforeunload",l)}},[w]);const pe=n.useCallback(async()=>{t&&await i({type:we.UPDATE,label:"Save template",reversibility:ve.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{templateId:t,action:"edit_manual"},action:async()=>{X(!0);try{const l=await Bt(t,u),v=typeof l?.html=="string"?l.html:u;return E(v),_(v),B(l?.metadata||null),L(l?.diff_summary||null),O(Array.isArray(l?.history)?l.history:P),l?.metadata&&M(l.metadata),$(),o.show("Template HTML saved.","success"),l}catch(l){throw o.show(String(l),"error"),l}finally{X(!1)}}})},[t,u,o,M,$,P,i]),fe=n.useCallback(async()=>{if(!t)return;const l=(T||"").trim();if(!l){o.show("Enter AI instructions before applying.","info");return}await i({type:we.GENERATE,label:"Apply AI edit",reversibility:ve.FULLY_REVERSIBLE,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{templateId:t,action:"edit_ai"},action:async()=>{z(!0);try{const v=await Ot(t,l,u),je=typeof v?.html=="string"?v.html:u;E(je),_(je),B(v?.metadata||null),L(v?.diff_summary||null),O(Array.isArray(v?.history)?v.history:P),v?.metadata&&M(v.metadata),f(""),$();const Re=Array.isArray(v?.summary)?v.summary:[];return Re.length?o.show(`AI updated template: ${Re.join("; ")}`,"success"):o.show("AI updated the template HTML.","success"),v}catch(v){throw o.show(String(v),"error"),v}finally{z(!1)}}})},[t,u,T,o,M,$,P,i]),ye=n.useCallback(async()=>{t&&await i({type:we.UPDATE,label:"Undo template edit",reversibility:ve.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{templateId:t,action:"undo_edit"},action:async()=>{Z(!0);try{const l=await Kt(t),v=typeof l?.html=="string"?l.html:u;return E(v),_(v),B(l?.metadata||null),L(l?.diff_summary||null),O(Array.isArray(l?.history)?l.history:P),l?.metadata&&M(l.metadata),o.show("Reverted to the previous template version.","success"),l}catch(l){throw o.show(String(l),"error"),l}finally{Z(!1)}}})},[t,u,o,M,P,i]),Ae=()=>{w&&typeof window<"u"&&!window.confirm("You have unsaved changes. Leave the editor and discard them?")||r(d,{label:"Back to templates",intent:{referrer:d}})},yt=(l,v)=>{if(v!==null){if(w&&v==="chat"){C({open:!0,nextMode:v});return}ue(v)}},jt=n.useCallback(l=>{E(l),_(l)},[]),vt=n.useCallback(l=>{l?.metadata&&(B(l.metadata),M(l.metadata)),l?.diff_summary&&L(l.diff_summary),Array.isArray(l?.history)&&O(l.history)},[M]),wt=n.useCallback(()=>{F&&(E(F.html||""),F.instructions&&f(F.instructions),re(),o.show("Draft restored successfully.","success"))},[F,re,o]);Hr({onSave:pe,onUndo:ye,onApplyAi:fe,onEscape:()=>{ie&&h(!1),J&&N(!1)},enabled:G==="manual"&&!x,dirty:w,hasInstructions:K});const Be=Cr(W),Oe=d==="/"?"Setup":"Generate";return e.jsxs(e.Fragment,{children:[e.jsx(a,{sx:{mb:2},children:e.jsxs(Vt,{separator:e.jsx(qt,{fontSize:"small"}),"aria-label":"breadcrumb",children:[e.jsx(Yt,{component:Gt,to:d,underline:"hover",color:"text.secondary",sx:{display:"flex",alignItems:"center",gap:.5},children:Oe}),e.jsx(g,{color:"text.primary",fontWeight:600,children:"Edit Design"})]})}),e.jsxs(tr,{sx:$r,children:[e.jsxs(b,{direction:"row",justifyContent:"space-between",alignItems:"flex-start",spacing:1.5,flexWrap:"wrap",children:[e.jsxs(a,{sx:{minWidth:0,flex:1},children:[e.jsxs(b,{direction:"row",spacing:1.5,alignItems:"center",flexWrap:"wrap",children:[e.jsx(g,{variant:"h5",fontWeight:700,children:y?.name||"Design Editor"}),e.jsx(Ur,{lastSaved:U,dirty:w})]}),e.jsx(g,{variant:"body2",color:"text.secondary",children:t?`ID: ${t}`:"No template selected"}),Be&&e.jsxs(g,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:["Last edit: ",Be.chipLabel]}),Y&&e.jsxs(g,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:["Recent change: ",Y]})]}),e.jsxs(b,{direction:"row",spacing:1.5,alignItems:"center",flexWrap:"wrap",children:[e.jsxs(We,{value:G,exclusive:!0,onChange:yt,size:"small","aria-label":"Edit mode",children:[e.jsx(ge,{value:"manual","aria-label":"Manual edit mode",children:e.jsx(V,{title:"Code Editor - Edit HTML directly with AI assistance",children:e.jsxs(b,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(Xt,{fontSize:"small"}),e.jsx(g,{variant:"body2",sx:{display:{xs:"none",sm:"block"}},children:"Code"})]})})}),e.jsx(ge,{value:"chat","aria-label":"Chat edit mode",children:e.jsx(V,{title:"Chat Editor - Conversational AI editing",children:e.jsxs(b,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(ft,{fontSize:"small"}),e.jsx(g,{variant:"body2",sx:{display:{xs:"none",sm:"block"}},children:"Chat"})]})})})]}),e.jsx(V,{title:"Keyboard shortcuts",children:e.jsx(ee,{size:"small",onClick:()=>N(!0),"aria-label":"Keyboard shortcuts",children:e.jsx(He,{fontSize:"small"})})}),e.jsxs(q,{variant:"outlined",onClick:Ae,startIcon:e.jsx(Qt,{}),sx:{textTransform:"none",fontWeight:600},children:["Back to ",Oe]})]})]}),e.jsx(or,{dense:!0,title:"AI editing",description:"AI edits apply to this report design. Review changes before saving.",chips:[{label:"Source: Design + instructions",color:"info",variant:"outlined"},{label:"Confidence: Review required",color:"warning",variant:"outlined"},{label:"Undo available",color:"success",variant:"outlined"}],sx:{mb:1}}),e.jsx(Fr,{show:Q&&!x&&G==="manual",draftData:F,onRestore:wt,onDiscard:re}),ce&&e.jsx(mt,{severity:"error",children:ce}),x?e.jsxs(e.Fragment,{children:[e.jsx(ze,{}),e.jsx(Nr,{mode:G})]}):G==="chat"?e.jsxs(e.Fragment,{children:[e.jsx(ze,{}),e.jsxs(se,{container:!0,spacing:2.5,sx:{alignItems:"stretch"},children:[e.jsx(se,{size:{xs:12,md:H?12:5},sx:{minWidth:0},children:e.jsxs(b,{spacing:1.5,sx:{height:"100%"},children:[e.jsxs(b,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(g,{variant:"subtitle1",children:"Preview"}),e.jsx(V,{title:H?"Exit fullscreen":"Fullscreen preview",children:e.jsx(ee,{size:"small",onClick:()=>Ce(!H),"aria-label":H?"Exit fullscreen":"Fullscreen preview",children:H?e.jsx(et,{fontSize:"small"}):e.jsx(Xe,{fontSize:"small"})})})]}),j?e.jsx(a,{sx:{borderRadius:1.5,border:"1px solid",borderColor:"divider",bgcolor:"background.paper",p:1.5,minHeight:H?600:400,transition:"min-height 0.2s ease"},children:e.jsx(Ue,{src:j,title:`Template preview for ${t}`,fit:"contain",pageShadow:!0,frameAspectRatio:"210 / 297",clampToParentHeight:!0})}):e.jsx(a,{sx:{borderRadius:1.5,border:"1px dashed",borderColor:"divider",bgcolor:"background.default",p:2,minHeight:400,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(g,{variant:"body2",color:"text.secondary",children:"No HTML loaded yet."})})]})}),!H&&e.jsx(se,{size:{xs:12,md:7},sx:{minWidth:0},children:e.jsx(a,{sx:{height:600},children:e.jsx(Ir,{templateId:t,templateName:y?.name||"Template",currentHtml:u,onHtmlUpdate:jt,onApplySuccess:vt})})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{}),e.jsxs(se,{container:!0,spacing:2.5,sx:{alignItems:"stretch"},children:[e.jsx(se,{size:{xs:12,md:H?12:6},sx:{minWidth:0},children:e.jsxs(b,{spacing:1.5,sx:{height:"100%"},children:[e.jsxs(b,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(g,{variant:"subtitle1",children:"Preview"}),e.jsx(V,{title:H?"Exit fullscreen":"Fullscreen preview",children:e.jsx(ee,{size:"small",onClick:()=>Ce(!H),"aria-label":H?"Exit fullscreen":"Fullscreen preview",children:H?e.jsx(et,{fontSize:"small"}):e.jsx(Xe,{fontSize:"small"})})})]}),j?e.jsx(a,{sx:{borderRadius:1.5,border:"1px solid",borderColor:"divider",bgcolor:"background.paper",p:1.5,minHeight:H?500:200,flex:1,transition:"min-height 0.2s ease"},children:e.jsx(Ue,{src:j,title:`Template preview for ${t}`,fit:"contain",pageShadow:!0,frameAspectRatio:"210 / 297",clampToParentHeight:!0})}):e.jsx(a,{sx:{borderRadius:1.5,border:"1px dashed",borderColor:"divider",bgcolor:"background.default",p:2,minHeight:200,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(g,{variant:"body2",color:"text.secondary",children:"No HTML loaded yet."})})]})}),!H&&e.jsx(se,{size:{xs:12,md:6},sx:{minWidth:0},children:e.jsxs(b,{spacing:1.5,sx:{height:"100%"},children:[e.jsx(g,{variant:"subtitle1",children:"HTML & AI Guidance"}),e.jsx(De,{label:"Design HTML",value:u,onChange:l=>E(l.target.value),inputProps:{"aria-label":"Template HTML"},multiline:!0,minRows:10,maxRows:24,fullWidth:!0,variant:"outlined",size:"small",error:w,helperText:w?`Unsaved changes. Press ${_e("save")} to save.`:"HTML is in sync with the saved template.",InputLabelProps:{shrink:!0},sx:{"& .MuiInputBase-input":{fontFamily:"monospace",fontSize:"0.85rem"}}}),e.jsx(De,{label:"AI Instructions",value:T,onChange:l=>f(l.target.value),multiline:!0,rows:3,InputProps:{inputComponent:Wr},fullWidth:!0,variant:"outlined",size:"small",placeholder:"Describe how the template should change. AI will preserve tokens and structure unless you ask otherwise.",helperText:K?`Press ${_e("applyAi")} or click Apply to run AI.`:"Enter instructions to enable AI editing.",InputLabelProps:{shrink:!0}}),e.jsxs(b,{direction:"row",spacing:1,flexWrap:"wrap",sx:{gap:1},children:[e.jsx(q,{variant:"contained",color:"primary",onClick:pe,disabled:I||x||!w||te,startIcon:I?e.jsx(Se,{size:16}):e.jsx(Zt,{}),sx:{minWidth:110},children:I?"Saving...":"Save"}),e.jsx(q,{variant:"outlined",onClick:fe,disabled:te||x||!K,startIcon:te?e.jsx(Se,{size:16}):e.jsx(er,{}),sx:{minWidth:130,color:"text.secondary",borderColor:"divider"},children:te?"Applying...":"Apply AI"}),e.jsx(q,{variant:"text",color:"inherit",onClick:ye,disabled:ne||x,startIcon:ne?e.jsx(Se,{size:16}):e.jsx(pt,{}),children:ne?"Undoing...":"Undo"}),e.jsx(q,{variant:"text",onClick:()=>h(!0),disabled:x||!w,startIcon:e.jsx(Pe,{}),sx:{color:"text.secondary"},children:"View Diff"})]}),e.jsx(g,{variant:"caption",color:"text.secondary",children:"AI edits are generated and may need review before use in production runs."}),e.jsx(at,{compact:!0}),e.jsx(Lr,{history:P,maxVisible:5})]})})]})]})]}),e.jsxs(Ge,{open:ie,onClose:()=>h(!1),maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"80vh",maxHeight:800}},children:[e.jsxs(qe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(a,{children:[e.jsx(g,{variant:"h6",children:"HTML Changes"}),e.jsx(g,{variant:"caption",color:"text.secondary",children:"Compare saved version with current edits"})]}),e.jsx(V,{title:"Close",children:e.jsx(ee,{onClick:()=>h(!1),"aria-label":"Close dialog",children:e.jsx(Je,{})})})]}),e.jsx(Qe,{dividers:!0,sx:{p:0,display:"flex",flexDirection:"column"},children:e.jsx(Mr,{beforeText:R,afterText:u,contextLines:3})}),e.jsxs(Jt,{children:[e.jsx(q,{onClick:()=>h(!1),children:"Close"}),e.jsx(q,{variant:"contained",onClick:()=>{pe(),h(!1)},disabled:I||!w,children:"Save Changes"})]})]}),e.jsxs(Ge,{open:J,onClose:()=>N(!1),maxWidth:"xs",fullWidth:!0,children:[e.jsxs(qe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:["Keyboard Shortcuts",e.jsx(V,{title:"Close",children:e.jsx(ee,{onClick:()=>N(!1),"aria-label":"Close dialog",children:e.jsx(Je,{})})})]}),e.jsx(Qe,{children:e.jsx(at,{})})]}),e.jsx(ir,{open:be.open,onClose:()=>C({open:!1,nextMode:null}),onConfirm:()=>{w&&ke(u,T),C({open:!1,nextMode:null}),ue(be.nextMode||"chat"),o.show("Draft saved. Your current edits are still available in chat and manual modes.","info")},title:"Switch to Chat Mode",message:"Switching to chat mode keeps your current edits and saves a draft for manual mode.",confirmLabel:"Switch",severity:"warning"})]})}function as(){return $e(),e.jsx(Br,{})}export{as as default};
