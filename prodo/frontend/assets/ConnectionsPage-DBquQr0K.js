import{g as Re,j as e,u as he,a as X,r as a,bi as Le,R,I as j,bj as Ae,q as z,aJ as De,n as d,f as c,aZ as ie,A as K,K as J,o as U,p as Q,bb as Pe,B as m,E as be,v as $e,l as I,bk as Fe,bl as le,bm as _e,bf as ce,b8 as Oe,t as de,bn as W,a7 as Ue,a6 as Be,T as ue,a1 as Ve,aT as Y,aU as q,bo as We,G as Ye,N as B,O as fe,e as qe,a_ as He,M as Ne}from"./index-COTlR4Mk.js";import{M as Qe}from"./MoreVert-C6fI3_5K.js";import{D as Ge}from"./DataTable-DCTRUeN1.js";import{C as Je}from"./ConfirmModal-BKTCaXkL.js";import{D as ye,C as Ke}from"./ConnectionForm-CoxfDqtf.js";import{F as Xe}from"./FavoriteButton-BI6d44PM.js";import{P as Ze}from"./Visibility-BrMHOUUu.js";import{A as et,a as tt,b as ot}from"./AccordionSummary-CjL3APeR.js";import{T as pe,a as me,b as H,c as h,d as xe}from"./TableRow-9uVWzbJ3.js";import"./KeyboardArrowDown-CbAvUKjN.js";import"./FilterList-B2nv-Yj9.js";import"./Check-JruGOof3.js";import"./TableContainer-BGfNH4cD.js";import"./KeyboardArrowRight-C1lIa1Bi.js";import"./CheckCircleOutline-KPLvK3qz.js";import"./WarningAmber-Ua-LQj3f.js";import"./Switch-DF6Waffn.js";import"./Star-Ct4JJ-ai.js";import"./StarBorder-X-7SSBaM.js";const nt=Re(e.jsx("path",{d:"M19 7H9c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2m0 2v2H9V9zm-6 6v-2h2v2zm2 2v2h-2v-2zm-4-2H9v-2h2zm6-2h2v2h-2zm-8 4h2v2H9zm8 2v-2h2v2zM6 17H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v1h-2V5H5v10h1z"})),st=n=>n==null?"n/a":n.toLocaleString();function at({open:n,onClose:x,connection:p}){const s=he(),{execute:w}=X(),[y,V]=a.useState(null),[L,A]=a.useState(!1),[C,b]=a.useState(null),[D,S]=a.useState(""),[v,k]=a.useState({}),T=a.useCallback(async()=>{if(p?.id){A(!0),b(null);try{const r=await Le(p.id,{includeRowCounts:!0,includeForeignKeys:!0});V(r)}catch(r){b(r.message||"Failed to load schema")}finally{A(!1)}}},[p?.id]);a.useEffect(()=>{n&&T()},[n,T]);const P=a.useMemo(()=>{const r=y?.tables||[],l=D.trim().toLowerCase();return l?r.filter(i=>i.name.toLowerCase().includes(l)):r},[y,D]),E=a.useCallback(r=>{if(!(!p?.id||!r))return w({type:j.EXECUTE,label:`Preview ${r}`,reversibility:R.FULLY_REVERSIBLE,suppressSuccessToast:!0,intent:{connectionId:p.id,table:r},action:async()=>{k(l=>({...l,[r]:{...l[r]||{},loading:!0,error:null}}));try{const l=await Ae(p.id,{table:r,limit:6});k(i=>({...i,[r]:{loading:!1,error:null,columns:l.columns||[],rows:l.rows||[]}}))}catch(l){k(i=>({...i,[r]:{...i[r]||{},loading:!1,error:l.message||"Preview failed"}}))}}})},[p?.id,w]),$=a.useCallback(()=>w({type:j.EXECUTE,label:"Refresh schema",reversibility:R.FULLY_REVERSIBLE,suppressSuccessToast:!0,intent:{connectionId:p?.id},action:T}),[p?.id,w,T]);return e.jsx(ye,{open:n,onClose:x,title:"Connection Schema",subtitle:p?.name||p?.summary||"Database overview",width:680,actions:e.jsx(z,{direction:"row",spacing:1,justifyContent:"flex-end",children:e.jsx(J,{variant:"outlined",onClick:$,startIcon:e.jsx(be,{}),sx:{borderRadius:1,textTransform:"none",borderColor:c(s.palette.divider,.2),color:s.palette.text.secondary,"&:hover":{borderColor:s.palette.mode==="dark"?d[500]:d[700],bgcolor:s.palette.mode==="dark"?c(s.palette.text.primary,.08):d[100]}},children:"Refresh"})}),children:e.jsxs(z,{spacing:2,children:[e.jsx(De,{label:"Filter tables",value:D,onChange:r=>S(r.target.value),size:"small",fullWidth:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:1,bgcolor:c(s.palette.background.paper,.5),"& .MuiOutlinedInput-notchedOutline":{borderColor:c(s.palette.divider,.15)},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:c(s.palette.divider,.3)},"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:s.palette.mode==="dark"?d[500]:d[700]}}}}),L&&e.jsx(ie,{sx:{borderRadius:1,bgcolor:r=>r.palette.mode==="dark"?c(r.palette.text.primary,.1):d[100],"& .MuiLinearProgress-bar":{bgcolor:r=>r.palette.mode==="dark"?d[500]:d[700]}}}),C&&e.jsx(K,{severity:"error",sx:{borderRadius:1},action:e.jsx(J,{color:"inherit",size:"small",onClick:$,children:"Retry"}),children:C==="Failed to load schema"?"Unable to connect to database. Please verify the connection is active and try again.":C}),!L&&!C&&e.jsxs(U,{variant:"body2",sx:{color:s.palette.text.secondary},children:[y?.table_count||0," tables found"]}),P.map(r=>{const l=v[r.name]||{};return e.jsxs(et,{disableGutters:!0,sx:{bgcolor:c(s.palette.background.paper,.5),border:`1px solid ${c(s.palette.divider,.1)}`,borderRadius:"8px !important","&:before":{display:"none"},"&.Mui-expanded":{margin:0}},children:[e.jsx(tt,{expandIcon:e.jsx(Pe,{sx:{color:s.palette.text.secondary}}),sx:{borderRadius:1,"&:hover":{bgcolor:s.palette.mode==="dark"?c(s.palette.text.primary,.05):d[50]}},children:e.jsxs(z,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(U,{sx:{fontWeight:600,color:s.palette.text.primary},children:r.name}),e.jsx(Q,{size:"small",label:`${st(r.row_count)} rows`,sx:{bgcolor:s.palette.mode==="dark"?c(s.palette.text.primary,.08):d[100],color:s.palette.text.secondary,fontSize:"12px",height:22,borderRadius:1}})]})}),e.jsx(ot,{children:e.jsxs(z,{spacing:1.5,children:[e.jsxs(m,{children:[e.jsx(U,{variant:"subtitle2",sx:{mb:1,color:s.palette.text.primary},children:"Columns"}),e.jsxs(pe,{size:"small",sx:{"& .MuiTableCell-head":{bgcolor:s.palette.mode==="dark"?c(s.palette.text.primary,.05):d[50],fontWeight:600,fontSize:"0.75rem",color:s.palette.text.secondary},"& .MuiTableCell-body":{fontSize:"14px",color:s.palette.text.primary}},children:[e.jsx(me,{children:e.jsxs(H,{children:[e.jsx(h,{children:"Name"}),e.jsx(h,{children:"Type"}),e.jsx(h,{children:"PK"}),e.jsx(h,{children:"Required"})]})}),e.jsx(xe,{children:(r.columns||[]).map(i=>e.jsxs(H,{children:[e.jsx(h,{children:i.name}),e.jsx(h,{children:i.type||"-"}),e.jsx(h,{children:i.pk?"Yes":"-"}),e.jsx(h,{children:i.notnull?"Yes":"-"})]},i.name))})]})]}),e.jsxs(m,{children:[e.jsxs(z,{direction:"row",spacing:1,alignItems:"center",justifyContent:"space-between",children:[e.jsx(U,{variant:"subtitle2",sx:{color:s.palette.text.primary},children:"Preview"}),e.jsx(J,{size:"small",variant:"outlined",startIcon:e.jsx(Ze,{}),onClick:()=>E(r.name),sx:{borderRadius:1,textTransform:"none",fontSize:"0.75rem",borderColor:c(s.palette.divider,.2),"&:hover":{borderColor:s.palette.mode==="dark"?d[500]:d[700],bgcolor:s.palette.mode==="dark"?c(s.palette.text.primary,.08):d[100]}},children:"Load preview"})]}),l.loading&&e.jsx(ie,{sx:{mt:1,borderRadius:1,bgcolor:i=>i.palette.mode==="dark"?c(i.palette.text.primary,.1):d[100],"& .MuiLinearProgress-bar":{bgcolor:i=>i.palette.mode==="dark"?d[500]:d[700]}}}),l.error&&e.jsxs(K,{severity:"error",sx:{mt:1,borderRadius:1},children:["  ",l.error]}),l.rows&&l.rows.length>0&&e.jsxs(pe,{size:"small",sx:{mt:1,"& .MuiTableCell-head":{bgcolor:s.palette.mode==="dark"?c(s.palette.text.primary,.05):d[50],fontWeight:600,fontSize:"0.75rem",color:s.palette.text.secondary},"& .MuiTableCell-body":{fontSize:"0.75rem",color:s.palette.text.primary}},children:[e.jsx(me,{children:e.jsx(H,{children:(l.columns||[]).map(i=>e.jsx(h,{children:i},i))})}),e.jsx(xe,{children:l.rows.map((i,F)=>e.jsx(H,{children:(l.columns||[]).map(_=>e.jsx(h,{children:i[_]==null?"-":String(i[_])},`${r.name}-${F}-${_}`))},`${r.name}-row-${F}`))})]}),!l.loading&&l.rows&&l.rows.length===0&&e.jsx(U,{variant:"body2",sx:{mt:1,color:s.palette.text.secondary},children:"No rows returned."})]})]})})]},r.name)})]})})}const rt=B(m)(({theme:n})=>({padding:n.spacing(3),maxWidth:1400,margin:"0 auto",width:"100%",minHeight:"100vh",backgroundColor:n.palette.background.default,animation:`${fe} 0.5s ease-out`})),it=B(He)(({theme:n})=>({"& .MuiPaper-root":{backgroundColor:c(n.palette.background.paper,.95),backdropFilter:"blur(20px)",border:`1px solid ${c(n.palette.divider,.1)}`,borderRadius:8,boxShadow:`0 8px 32px ${c(n.palette.common.black,.15)}`,minWidth:160,animation:`${fe} 0.2s ease-out`}})),N=B(Ne)(({theme:n})=>({borderRadius:8,margin:n.spacing(.5,1),padding:n.spacing(1,1.5),fontSize:"14px",transition:"all 0.2s cubic-bezier(0.22, 1, 0.36, 1)","&:hover":{backgroundColor:n.palette.mode==="dark"?c(n.palette.text.primary,.08):d[100]}})),lt=B(m)(({theme:n})=>({width:32,height:32,borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s cubic-bezier(0.22, 1, 0.36, 1)"})),ct=B(qe)(({theme:n})=>({borderRadius:8,transition:"all 0.2s cubic-bezier(0.22, 1, 0.36, 1)","&:hover":{backgroundColor:n.palette.mode==="dark"?c(n.palette.text.primary,.08):d[100],transform:"scale(1.05)"}}));function dt(){const n=he(),x=$e(),{execute:p}=X(),s=I(t=>t.savedConnections),w=I(t=>t.setSavedConnections),y=I(t=>t.addSavedConnection),V=I(t=>t.removeSavedConnection),L=I(t=>t.setActiveConnectionId),A=I(t=>t.activeConnectionId),[C,b]=a.useState(!1),[D,S]=a.useState(!1),[v,k]=a.useState(null),[T,P]=a.useState(!1),[E,$]=a.useState(null),[r,l]=a.useState(null),[i,F]=a.useState(null),[_,Z]=a.useState(!1),[Ce,ge]=a.useState(null),[ee,te]=a.useState(new Set),oe=a.useRef(!1);a.useEffect(()=>{oe.current||(oe.current=!0,Fe().then(t=>{const o=(t.connections||[]).map(u=>u.id);te(new Set(o))}).catch(t=>{console.error("Failed to load favorites:",t)}))},[]);const ne=a.useCallback((t,o)=>{te(u=>{const f=new Set(u);return o?f.add(t):f.delete(t),f})},[]),Se=a.useCallback((t,o)=>{t.stopPropagation(),l(t.currentTarget),F(o)},[]),g=a.useCallback(()=>{l(null),F(null)},[]),O=a.useRef(!1),se=a.useCallback(()=>{O.current||(O.current=!0,k(null),S(!0))},[]),ve=a.useCallback(()=>{k(i),S(!0),g()},[i,g]),je=a.useCallback(()=>{$(i),P(!0),g()},[i,g]),we=a.useCallback(async()=>{if(!i)return;const t=i;g(),p({type:j.ANALYZE,label:`Inspect schema for "${t.name}"`,reversibility:R.SYSTEM_MANAGED,errorMessage:"Unable to connect to database. Please verify the connection is active.",action:async()=>{b(!0);try{if((await le(t.id)).status!=="ok")throw new Error("Connection is unavailable. Please verify connection settings.");ge(t),Z(!0)}finally{b(!1)}}})},[i,g,p]),ke=a.useCallback(async()=>{if(!E)return;const t=E,o=s.find(u=>u.id===t.id);P(!1),$(null),p({type:j.DELETE,label:`Delete data source "${t.name}"`,reversibility:R.PARTIALLY_REVERSIBLE,successMessage:`"${t.name}" removed`,errorMessage:"Failed to delete connection",action:async()=>{V(t.id);try{await _e(t.id)}catch(u){throw o&&y(o),u}x.showWithUndo(`"${t.name}" removed`,async()=>{if(o)try{const u=await ce({name:o.name,dbType:o.db_type,dbUrl:o.db_url,database:o.database||o.summary,status:o.status||"connected",latencyMs:o.latency_ms});y(u),x.show("Data source restored","success")}catch(u){console.error("Failed to restore connection:",u),x.show("Failed to restore connection","error")}},{severity:"info"})}})},[E,s,V,w,x,p]),Te=a.useCallback(async t=>{const o=!!v;p({type:o?j.UPDATE:j.CREATE,label:o?`Update data source "${t.name}"`:`Add data source "${t.name}"`,reversibility:R.FULLY_REVERSIBLE,successMessage:o?"Data source updated":"Data source added",errorMessage:"Failed to save connection",action:async()=>{b(!0);try{const u=await Oe(t);if(!u.ok)throw new Error(u.detail||"Connection test failed");const f=await ce({id:v?.id||u.connection_id,name:t.name,dbType:t.db_type,dbUrl:t.db_url,database:t.database,status:"connected",latencyMs:u.latency_ms});y(f),O.current=!1,S(!1)}finally{b(!1)}}})},[v,y,p]),Ee=a.useCallback(async t=>{p({type:j.EXECUTE,label:`Test connection "${t.name}"`,reversibility:R.SYSTEM_MANAGED,errorMessage:"Connection test failed",action:async()=>{b(!0);try{const o=await le(t.id);if(o.status==="ok")x.show(`Connected (${o.latency_ms}ms)`,"success");else throw new Error("Connection unavailable")}finally{b(!1)}}})},[x,p]),Me=a.useCallback(t=>{L(t.id),x.show(`Selected: ${t.name}`,"info")},[L,x]),Ie=a.useMemo(()=>[{field:"name",headerName:"Name",minWidth:200,flex:1,renderCell:(t,o)=>e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Xe,{entityType:"connections",entityId:o.id,initialFavorite:ee.has(o.id),onToggle:u=>ne(o.id,u)}),e.jsx(lt,{sx:{bgcolor:n.palette.mode==="dark"?c(n.palette.text.primary,.08):d[100]},children:e.jsx(de,{sx:{color:n.palette.text.secondary,fontSize:16}})}),e.jsxs(m,{sx:{minWidth:0},children:[e.jsxs(z,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(m,{"data-testid":"connection-name",sx:{fontWeight:500,fontSize:"14px",color:n.palette.text.primary},children:t}),A===o.id&&e.jsx(Q,{size:"small",label:"Active",sx:{bgcolor:u=>u.palette.mode==="dark"?c(u.palette.text.primary,.1):d[200],color:"text.secondary"}})]}),e.jsx(m,{sx:{fontSize:"0.75rem",color:n.palette.text.secondary},children:o.summary||o.db_type})]})]})},{field:"db_type",headerName:"Type",width:120,renderCell:t=>{const o={sqlite:"SQLite",postgresql:"PostgreSQL",postgres:"PostgreSQL",mysql:"MySQL",mssql:"SQL Server",oracle:"Oracle",csv:"CSV",excel:"Excel",json:"JSON"};return e.jsx(Q,{label:o[(t||"").toLowerCase()]||t||"Unknown",size:"small","data-testid":"connection-db-type",sx:{bgcolor:n.palette.mode==="dark"?c(n.palette.text.primary,.08):d[100],color:n.palette.text.secondary,fontSize:"0.75rem",borderRadius:1}})}},{field:"status",headerName:"Status",width:140,renderCell:t=>{const o=t==="connected";return e.jsx(Q,{icon:o?e.jsx(Ue,{sx:{fontSize:14}}):e.jsx(Be,{sx:{fontSize:14}}),label:t||"Unknown",size:"small","data-testid":"connection-status",sx:{fontSize:"0.75rem",textTransform:"capitalize",borderRadius:1,bgcolor:o?c(W.success,.1):c(W.destructive,.1),color:o?W.success:W.destructive,"& .MuiChip-icon":{color:"inherit"}}})}},{field:"lastLatencyMs",headerName:"Latency",width:100,renderCell:t=>e.jsx(m,{"data-testid":"connection-latency",sx:{color:n.palette.text.secondary,fontSize:"14px"},children:t?`${t}ms`:"-"})},{field:"lastConnected",headerName:"Last Connected",width:160,renderCell:t=>{if(!t)return e.jsx(m,{sx:{color:n.palette.text.disabled,fontSize:"14px"},children:"-"});const o=new Date(t),f=new Date-o,G=Math.floor(f/6e4),ae=Math.floor(f/36e5),re=Math.floor(f/864e5);let M;return G<1?M="Just now":G<60?M=`${G}m ago`:ae<24?M=`${ae}h ago`:re<7?M=`${re}d ago`:M=o.toLocaleDateString(),e.jsx(ue,{title:o.toLocaleString(),arrow:!0,children:e.jsx(m,{"data-testid":"connection-last-connected",sx:{color:n.palette.text.secondary,fontSize:"14px",cursor:"default"},children:M})})}}],[ee,ne,n,A]),ze=a.useMemo(()=>[{key:"status",label:"Status",options:[{value:"connected",label:"Connected"},{value:"disconnected",label:"Disconnected"},{value:"error",label:"Error"}]},{key:"db_type",label:"Type",options:[{value:"sqlite",label:"SQLite"},{value:"postgresql",label:"PostgreSQL"}]}],[]);return e.jsxs(rt,{children:[e.jsx(K,{severity:"info",sx:{mb:2,borderRadius:1},children:"Data sources power report runs and AI tools. Use a read-only account when possible. Active sources are labeled and can be switched anytime."}),e.jsx(Ge,{title:"Data Sources",subtitle:"Connect to your databases and data files",columns:Ie,data:s,loading:C,searchPlaceholder:"Search connections...",filters:ze,actions:[{label:"Add Data Source",icon:e.jsx(Ve,{sx:{fontSize:18}}),variant:"contained",onClick:se}],onRowClick:Me,rowActions:t=>e.jsx(ue,{title:"More actions",children:e.jsx(ct,{size:"small",onClick:o=>Se(o,t),"aria-label":"More actions","data-testid":"connection-actions-button",sx:{color:n.palette.text.secondary},children:e.jsx(Qe,{sx:{fontSize:18}})})}),emptyState:{icon:de,title:"No data sources yet",description:"Connect to a database to start pulling data for your reports.",actionLabel:"Add Data Source",onAction:se}}),e.jsxs(it,{anchorEl:r,open:!!r,onClose:g,children:[e.jsxs(N,{onClick:()=>{Ee(i),g()},children:[e.jsx(Y,{children:e.jsx(be,{sx:{fontSize:16,color:n.palette.text.secondary}})}),e.jsx(q,{primaryTypographyProps:{fontSize:"14px"},children:"Test Connection"})]}),e.jsxs(N,{onClick:we,children:[e.jsx(Y,{children:e.jsx(nt,{sx:{fontSize:16,color:n.palette.text.secondary}})}),e.jsx(q,{primaryTypographyProps:{fontSize:"14px"},children:"Inspect Schema"})]}),e.jsxs(N,{onClick:ve,children:[e.jsx(Y,{children:e.jsx(We,{sx:{fontSize:16,color:n.palette.text.secondary}})}),e.jsx(q,{primaryTypographyProps:{fontSize:"14px"},children:"Edit"})]}),e.jsxs(N,{onClick:je,sx:{color:n.palette.text.primary},children:[e.jsx(Y,{children:e.jsx(Ye,{sx:{fontSize:16,color:n.palette.text.secondary}})}),e.jsx(q,{primaryTypographyProps:{fontSize:"14px"},children:"Delete"})]})]}),e.jsx(ye,{open:D,onClose:()=>{O.current=!1,S(!1)},title:v?"Edit Data Source":"Add Data Source",subtitle:"Enter your database details to connect",width:520,children:e.jsx(Ke,{connection:v,onSave:Te,onCancel:()=>{O.current=!1,S(!1)},loading:C})}),e.jsx(Je,{open:T,onClose:()=>P(!1),onConfirm:ke,title:"Remove Data Source",message:`Remove "${E?.name}"? This only removes it from NeuraReport and does not change your database. You can undo this within a few seconds.`,confirmLabel:"Remove",severity:"error",loading:C}),e.jsx(at,{open:_,onClose:()=>Z(!1),connection:Ce})]})}function zt(){return X(),e.jsx(dt,{})}export{zt as default};
