import{c as de,j as e,f as q,r as i,g as me,U as he,V as xe,a as k,bC as pe,bD as ge,u as te,R as w,I as z,B as u,T as d,as as F,s as E,A as fe,P as H,aM as J,aR as ye,aV as je,_ as Se,w as M,$ as Ce,o as be,a1 as ve,F as we,v as I,k as Q,p as V,aJ as Ee,N as U,aI as Ie,ak as De,al as ke,am as Re,ao as Ae}from"./index-B8Eu23bA.js";import{C as Te}from"./ConfirmModal-Bm9QL03g.js";import{g as Ne}from"./sqlSafety-CLxawa7_.js";import{A as _e}from"./AiUsageNotice-DRuwRFKl.js";import{G as D}from"./Grid-5L9Rvqba.js";import{C as K,a as Z}from"./CardContent-xJVpuEbT.js";import{U as Le}from"./Link-ijq0kuwU.js";import"./CheckCircleOutline-BKKyaL-x.js";import"./WarningAmber-DtVJgAFk.js";const ee=de([e.jsx("ellipse",{cx:"12",cy:"12",rx:"3",ry:"5.74"},"0"),e.jsx("path",{d:"M9.04 16.87c-.33.08-.68.13-1.04.13-2.76 0-5-2.24-5-5s2.24-5 5-5c.36 0 .71.05 1.04.13.39-.56.88-1.12 1.49-1.63C9.75 5.19 8.9 5 8 5c-3.86 0-7 3.14-7 7s3.14 7 7 7c.9 0 1.75-.19 2.53-.5-.61-.51-1.1-1.07-1.49-1.63M16 5c-.9 0-1.75.19-2.53.5.61.51 1.1 1.07 1.49 1.63.33-.08.68-.13 1.04-.13 2.76 0 5 2.24 5 5s-2.24 5-5 5c-.36 0-.71-.05-1.04-.13-.39.56-.88 1.12-1.49 1.63.78.31 1.63.5 2.53.5 3.86 0 7-3.14 7-7s-3.14-7-7-7"},"1")]),O=s=>Array.isArray(s)?s:[];function qe(){const s=q(o=>o.savedConnections),n=q(o=>o.setSavedConnections),a=q(o=>o.updateSavedConnection),r=q(o=>o.removeSavedConnection),[c,h]=i.useState(!1),[C,x]=i.useState(null),j=i.useMemo(()=>O(s),[s]),R=i.useCallback(o=>{n(O(o))},[n]),b=i.useCallback(async()=>{h(!0),x(null);try{const o=await me(),l=O(o?.connections);return n(l),h(!1),l}catch(o){return x(o.message||"Failed to load connections"),h(!1),[]}},[n]),A=i.useCallback(async o=>{try{const l=await he(o);return a(o,{lastLatencyMs:l.latency_ms,status:"connected"}),l}catch(l){throw a(o,{status:"error"}),l}},[a]),S=i.useCallback(async o=>{h(!0),x(null);try{return await xe(o),r(o),h(!1),!0}catch(l){return x(l.message||"Failed to delete connection"),h(!1),!1}},[r]),T=i.useCallback(o=>j.find(l=>l.id===o)||null,[j]),v=i.useCallback(()=>{n([]),x(null)},[n]);return i.useMemo(()=>({connections:j,loading:c,error:C,setConnections:R,setLoading:h,setError:x,fetchConnections:b,healthCheck:A,removeConnection:S,getConnection:T,reset:v}),[j,c,C,R,h,x,b,A,S,T,v])}async function ze({name:s,connectionIds:n,description:a}){return(await k.post("/federation/schemas",{name:s,connection_ids:n,description:a})).data}async function Me({limit:s,offset:n}={}){const a={};return s!=null&&(a.limit=s),n!=null&&(a.offset=n),(await k.get("/federation/schemas",{params:a})).data}async function Be(s){return(await k.post("/federation/suggest-joins",{connection_ids:s})).data}async function We({schemaId:s,query:n,limit:a=100}){return(await k.post("/federation/query",{virtual_schema_id:s,sql:n,limit:a})).data}async function Fe(s){return(await k.delete(`/federation/schemas/${s}`)).data}const Je=pe((s,n)=>({schemas:[],currentSchema:null,joinSuggestions:[],queryResult:null,loading:!1,error:null,setLoading:a=>s({loading:a}),setError:a=>s({error:a}),fetchSchemas:async()=>{s({loading:!0,error:null});try{const a=await Me();s({schemas:a.schemas||[],loading:!1})}catch(a){s({error:a.message,loading:!1})}},createSchema:async a=>{s({loading:!0,error:null});try{const c=(await ze(a)).schema;return s(h=>({schemas:[...h.schemas,c].slice(0,200),currentSchema:c,loading:!1})),c}catch(r){return s({error:r.message,loading:!1}),null}},deleteSchema:async a=>{s({loading:!0,error:null});try{return await Fe(a),s(r=>({schemas:r.schemas.filter(c=>c.id!==a),currentSchema:r.currentSchema?.id===a?null:r.currentSchema,loading:!1})),!0}catch(r){return s({error:r.message,loading:!1}),!1}},suggestJoins:async()=>{const{currentSchema:a}=n();if(!a?.connections||a.connections.length<2)return s({error:"Need at least 2 connections to suggest joins",loading:!1}),[];s({loading:!0,error:null});try{const r=await Be(a.connections);return s({joinSuggestions:r.suggestions||[],loading:!1}),r.suggestions}catch(r){return s({error:r.message,loading:!1}),[]}},executeQuery:async(a,r)=>{s({loading:!0,error:null,queryResult:null});try{const c=await We({schemaId:a,query:r});return s({queryResult:c.result,loading:!1}),c.result}catch(c){return s({error:c.message,loading:!1}),null}},setCurrentSchema:a=>s({currentSchema:a,joinSuggestions:[],queryResult:null}),reset:()=>s({currentSchema:null,joinSuggestions:[],queryResult:null,error:null})}));function Qe(){const{schemas:s,currentSchema:n,joinSuggestions:a,queryResult:r,loading:c,error:h,fetchSchemas:C,createSchema:x,deleteSchema:j,suggestJoins:R,executeQuery:b,setCurrentSchema:A,reset:S}=Je(),{connections:T,fetchConnections:v}=qe(),o=ge("EXECUTE_WRITE_QUERY"),{execute:l}=te(),[se,N]=i.useState(!1),[_,P]=i.useState(""),[G,$]=i.useState(""),[f,Y]=i.useState([]),[p,ae]=i.useState(""),[L,B]=i.useState({open:!1,schemaId:null,schemaName:""}),[ne,X]=i.useState(!0),g=Ne(p);i.useEffect(()=>((async()=>(X(!0),await Promise.all([C(),v()]),X(!1)))(),()=>S()),[C,v,S]);const re=async()=>{!_||f.length<2||await l({type:z.CREATE,label:"Create federation schema",reversibility:w.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{connectionIds:f,action:"create_federation_schema"},action:async()=>{const t=await x({name:_,connectionIds:f,description:G});if(!t)throw new Error("Create schema failed");return N(!1),P(""),$(""),Y([]),t}})},oe=async()=>{n&&await l({type:z.GENERATE,label:"Suggest joins",reversibility:w.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{schemaId:n.id,action:"suggest_joins"},action:async()=>{const t=await R();if(!t)throw new Error("Suggest joins failed");return t}})},W=i.useCallback(async()=>{!n||!p.trim()||await l({type:z.EXECUTE,label:"Run federated query",reversibility:g?w.IRREVERSIBLE:w.FULLY_REVERSIBLE,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{schemaId:n.id,action:"execute_federation_query",writeOperation:g},action:async()=>{const t=await b(n.id,p);if(!t)throw new Error("Query execution failed");return t}})},[n,b,p,l,g]),ie=i.useCallback(async()=>{if(!(!n||!p.trim())){if(g){o(n.name||n.id||"selected schema",W);return}await W()}},[o,n,p,W,g]),ce=i.useCallback(t=>{B({open:!0,schemaId:t?.id||null,schemaName:t?.name||"this schema"})},[]),le=async()=>{const t=L.schemaId,m=L.schemaName;B({open:!1,schemaId:null,schemaName:""}),t&&await l({type:z.DELETE,label:"Delete federation schema",reversibility:w.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{schemaId:t,schemaName:m,action:"delete_federation_schema"},action:async()=>{const y=await j(t);if(!y)throw new Error("Delete schema failed");return y}})},ue=t=>{Y(m=>m.includes(t)?m.filter(y=>y!==t):[...m,t])};return ne?e.jsxs(u,{sx:{p:3,maxWidth:1400,mx:"auto"},children:[e.jsxs(u,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[e.jsx(ee,{}),e.jsx(d,{variant:"h4",children:"Cross-Database Federation"})]}),e.jsx(u,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:300},children:e.jsx(F,{})})]}):e.jsxs(u,{sx:{p:3,maxWidth:1400,mx:"auto"},children:[e.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(u,{children:[e.jsxs(d,{variant:"h4",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ee,{})," Cross-Database Federation"]}),e.jsx(d,{variant:"body1",color:"text.secondary",children:"Create virtual schemas to query across multiple databases"})]}),e.jsx(E,{variant:"contained",startIcon:e.jsx(fe,{}),onClick:()=>N(!0),children:"New Virtual Schema"})]}),h&&e.jsx(H,{severity:"error",sx:{mb:2},onClose:()=>S(),children:h}),e.jsx(_e,{title:"AI join suggestions",description:"Join suggestions are generated from schema metadata. Review before running cross-database queries.",chips:[{label:"Source: Selected schemas",variant:"outlined"},{label:"Confidence: Provided per suggestion",variant:"outlined"},{label:"Read-only recommended",variant:"outlined"}],dense:!0,sx:{mb:2}}),e.jsxs(D,{container:!0,spacing:3,children:[e.jsx(D,{size:{xs:12,md:4},children:e.jsxs(J,{sx:{p:2},children:[e.jsx(d,{variant:"h6",gutterBottom:!0,children:"Virtual Schemas"}),s.length===0?e.jsx(d,{color:"text.secondary",sx:{py:2,textAlign:"center"},children:"No virtual schemas yet. Create one to get started."}):e.jsx(ye,{children:s.map(t=>e.jsxs(je,{button:!0,selected:n?.id===t.id,onClick:()=>A(t),secondaryAction:e.jsx(be,{edge:"end",onClick:m=>{m.stopPropagation(),ce(t)},children:e.jsx(ve,{})}),children:[e.jsx(Se,{children:e.jsx(M,{})}),e.jsx(Ce,{primary:t.name,secondary:`${t.connections?.length||0} databases`})]},t.id))})]})}),e.jsx(D,{size:{xs:12,md:8},children:n?e.jsxs(J,{sx:{p:3},children:[e.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(d,{variant:"h6",children:n.name}),e.jsx(E,{variant:"outlined",startIcon:c?e.jsx(F,{size:20}):e.jsx(we,{}),onClick:oe,disabled:c,children:"AI Join Suggestions"})]}),n.description&&e.jsx(d,{color:"text.secondary",sx:{mb:2},children:n.description}),e.jsx(u,{sx:{display:"flex",gap:1,mb:3,flexWrap:"wrap"},children:(n.connections||[]).map((t,m)=>e.jsx(I,{icon:e.jsx(M,{}),label:t.name||t,variant:"outlined"},m))}),a.length>0&&e.jsxs(u,{sx:{mb:3},children:[e.jsx(d,{variant:"subtitle1",gutterBottom:!0,children:"Suggested Joins"}),e.jsx(D,{container:!0,spacing:2,children:a.map((t,m)=>e.jsx(D,{size:{xs:12,sm:6},children:e.jsx(K,{variant:"outlined",children:e.jsxs(Z,{sx:{py:1.5},children:[e.jsxs(u,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(Le,{sx:{color:"text.secondary"}}),e.jsxs(d,{variant:"subtitle2",children:[t.left_table," â†” ",t.right_table]})]}),e.jsxs(d,{variant:"body2",color:"text.secondary",children:[t.left_column," = ",t.right_column]}),t.reason&&e.jsx(d,{variant:"caption",color:"text.secondary",display:"block",sx:{mt:.5},children:t.reason}),e.jsx(I,{size:"small",label:`${Math.round((t.confidence||0)*100)}% confidence`,sx:{mt:1,bgcolor:y=>y.palette.mode==="dark"?V(y.palette.text.primary,.1):Q[400],color:"text.secondary"}})]})})},m))})]}),e.jsx(Ee,{sx:{my:2}}),e.jsx(d,{variant:"subtitle1",gutterBottom:!0,children:"Federated Query"}),e.jsx(U,{fullWidth:!0,multiline:!0,rows:4,placeholder:"SELECT * FROM db1.users u JOIN db2.orders o ON u.id = o.user_id",value:p,onChange:t=>ae(t.target.value),sx:{mb:2,fontFamily:"monospace"}}),e.jsxs(u,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:2},children:[e.jsx(I,{size:"small",label:"Read-only recommended",variant:"outlined",sx:{fontSize:"0.7rem"}}),g&&e.jsx(I,{size:"small",label:`${g.toUpperCase()} detected`,sx:{fontSize:"0.7rem",bgcolor:t=>t.palette.mode==="dark"?V(t.palette.text.primary,.1):Q[400],color:"text.secondary"}})]}),e.jsx(E,{variant:"contained",startIcon:c?e.jsx(F,{size:20}):e.jsx(Ie,{}),onClick:ie,disabled:!p.trim()||c,children:"Execute Query"}),g&&e.jsx(H,{severity:"warning",sx:{mt:2},children:"Write queries can modify data and may not be reversible. You will be asked to confirm before execution."}),r&&e.jsxs(u,{sx:{mt:3},children:[e.jsxs(d,{variant:"subtitle1",gutterBottom:!0,children:["Results (",r.rows?.length||0," rows)"]}),e.jsx(u,{sx:{overflowX:"auto"},children:e.jsx("pre",{style:{fontSize:12,margin:0},children:JSON.stringify(r,null,2)})})]})]}):e.jsxs(J,{sx:{p:4,textAlign:"center"},children:[e.jsx(M,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(d,{color:"text.secondary",children:"Select a virtual schema or create a new one to get started"})]})})]}),e.jsxs(De,{open:se,onClose:()=>N(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ke,{children:"Create Virtual Schema"}),e.jsxs(Re,{children:[e.jsx(U,{fullWidth:!0,label:"Schema Name",value:_,onChange:t=>P(t.target.value),sx:{mt:2,mb:2}}),e.jsx(U,{fullWidth:!0,label:"Description",value:G,onChange:t=>$(t.target.value),multiline:!0,rows:2,sx:{mb:2}}),e.jsx(d,{variant:"subtitle2",gutterBottom:!0,children:"Select Databases (minimum 2)"}),e.jsx(u,{sx:{display:"flex",flexDirection:"column",gap:1},children:T.map(t=>e.jsx(K,{variant:"outlined",sx:{cursor:"pointer",borderColor:f.includes(t.id)?"text.secondary":"divider",bgcolor:f.includes(t.id)?"action.selected":"background.paper"},onClick:()=>ue(t.id),children:e.jsx(Z,{sx:{py:1,"&:last-child":{pb:1}},children:e.jsxs(u,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(u,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(M,{}),e.jsx(d,{children:t.name})]}),f.includes(t.id)&&e.jsx(I,{label:"Selected",size:"small",sx:{bgcolor:m=>m.palette.mode==="dark"?V(m.palette.text.primary,.1):Q[400],color:"text.secondary"}})]})})},t.id))})]}),e.jsxs(Ae,{children:[e.jsx(E,{onClick:()=>N(!1),children:"Cancel"}),e.jsx(E,{variant:"contained",onClick:re,disabled:!_||f.length<2,children:"Create"})]})]}),e.jsx(Te,{open:L.open,onClose:()=>B({open:!1,schemaId:null,schemaName:""}),onConfirm:le,title:"Delete Virtual Schema",message:`Delete "${L.schemaName}"? This will remove the virtual schema and its saved join logic.`,confirmLabel:"Delete",severity:"error"})]})}function Ke(){return te(),e.jsx(Qe,{})}export{Ke as default};
