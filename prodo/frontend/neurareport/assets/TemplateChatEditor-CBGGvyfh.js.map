{"version":3,"file":"TemplateChatEditor-CBGGvyfh.js","sources":["../../node_modules/@mui/icons-material/esm/Queue.js","../../node_modules/@mui/icons-material/esm/SmartToyOutlined.js","../../src/utils/preview.js","../../src/components/ScaledIframePreview.jsx","../../src/features/generate/containers/TemplateChatEditor.jsx"],"sourcesContent":["\"use client\";\n\nimport createSvgIcon from \"./utils/createSvgIcon.js\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nexport default createSvgIcon(/*#__PURE__*/_jsx(\"path\", {\n  d: \"M4 6H2v14c0 1.1.9 2 2 2h14v-2H4zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m-1 9h-4v4h-2v-4H9V9h4V5h2v4h4z\"\n}), 'Queue');","\"use client\";\n\nimport createSvgIcon from \"./utils/createSvgIcon.js\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nexport default createSvgIcon(/*#__PURE__*/_jsx(\"path\", {\n  d: \"M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3m-2 10H6V7h12zm-9-6c-.83 0-1.5-.67-1.5-1.5S8.17 10 9 10s1.5.67 1.5 1.5S9.83 13 9 13m7.5-1.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5 1.5.67 1.5 1.5M8 15h8v2H8z\"\n}), 'SmartToyOutlined');","import { withBase } from '../api/client'\n\nexport const DEFAULT_PAGE_DIMENSIONS = { width: 794, height: 1123 }\n\nconst parseTimestamp = (value) => {\n  if (value === null || value === undefined || value === '') return null\n  if (typeof value === 'number' && Number.isFinite(value)) return Math.floor(value)\n  const numeric = Number(value)\n  if (!Number.isNaN(numeric) && Number.isFinite(numeric) && numeric > 0) {\n    return Math.floor(numeric)\n  }\n  const parsed = Date.parse(value)\n  if (!Number.isNaN(parsed)) return Math.floor(parsed)\n  return String(value)\n}\n\nexport const appendCacheBuster = (url, ts) => {\n  if (!url || ts === null || ts === undefined || ts === '') return url\n  const token = parseTimestamp(ts)\n  const value = typeof token === 'number' ? token : String(token)\n  try {\n    const base = typeof window !== 'undefined' ? window.location.origin : 'http://localhost'\n    const next = new URL(url, base)\n    next.searchParams.set('ts', value)\n    return next.toString()\n  } catch {\n    const sep = url.includes('?') ? '&' : '?'\n    return `${url}${sep}ts=${encodeURIComponent(value)}`\n  }\n}\n\nexport const getUploadsBase = (templateOrKind) => {\n  const kind =\n    typeof templateOrKind === 'string'\n      ? templateOrKind\n      : templateOrKind?.kind || templateOrKind?.templateKind || templateOrKind?.sourceKind\n  return kind === 'excel' ? 'excel-uploads' : 'uploads'\n}\n\nconst ensureAbsolutePath = (template, path) => {\n  if (!path || typeof path !== 'string') return null\n  if (/^https?:\\/\\//i.test(path)) return path\n  if (path.startsWith('/')) return path\n  const templateId = template?.id || template?.templateId || template?.template_id\n  if (!templateId) return path\n  const base = getUploadsBase(template)\n  return `/${base}/${templateId}/${path}`\n}\n\nconst pickFirst = (candidates) => candidates.find((item) => typeof item === 'string' && item.length > 0) || null\n\nexport function resolveTemplatePreviewUrl(template, options = {}) {\n  if (!template) return { url: null, key: null, ts: null }\n\n  const manifest = template.manifest || {}\n  const manifestFiles = manifest.files || {}\n  const artifacts = template.artifacts || {}\n  const templateId = template.id || template.templateId || template.template_id || template?.tplId || null\n\n  const finalCandidates = [\n    template.htmlUrls?.final,\n    template.final_html_url,\n    template.finalHtmlUrl,\n    artifacts.final_html_url,\n    artifacts.finalHtmlUrl,\n    artifacts.final_html,\n    manifestFiles['report_final.html'],\n  ]\n\n  const templateCandidates = [\n    template.htmlUrls?.llm2,\n    template.llm2_html_url,\n    template.llm2HtmlUrl,\n    artifacts.llm2_html_url,\n    artifacts.llm2HtmlUrl,\n    manifestFiles['template_llm2.html'],\n    template.htmlUrls?.template,\n    template.template_html_url,\n    template.templateHtmlUrl,\n    artifacts.template_html_url,\n    artifacts.templateHtmlUrl,\n    artifacts.template_html,\n    manifestFiles['template_p1.html'],\n  ]\n\n  const htmlCandidates = [\n    template.template_html,\n    template.templateHtml,\n    template.html_url,\n    template.htmlUrl,\n    template.llm2_html_url,\n    template.llm2HtmlUrl,\n    artifacts.html_url,\n    artifacts.htmlUrl,\n    artifacts.html,\n    artifacts.llm2_html_url,\n    artifacts.llm2HtmlUrl,\n    manifestFiles['template_html'],\n    manifestFiles['template_llm2.html'],\n    options.fallbackUrl,\n  ]\n\n  let raw =\n    ensureAbsolutePath(template, pickFirst(finalCandidates)) ||\n    ensureAbsolutePath(template, pickFirst(templateCandidates)) ||\n    ensureAbsolutePath(template, pickFirst(htmlCandidates))\n\n  if (!raw) return { url: null, key: null, ts: null }\n\n  let resolved = withBase(raw)\n\n  const tsCandidates = [\n    options.ts,\n    template.previewTs,\n    template.preview_ts,\n    template.cacheKey,\n    template.manifest_produced_at,\n    manifest.produced_at,\n    template.lastModified,\n    template.updated_at,\n    template.updatedAt,\n    template.created_at,\n    template.createdAt,\n    template.ts,\n  ]\n  const tsRaw = tsCandidates.find((value) => value !== undefined && value !== null && value !== '')\n  const ts = tsRaw !== undefined ? parseTimestamp(tsRaw) : null\n\n  if (ts !== null) {\n    resolved = appendCacheBuster(resolved, ts)\n  }\n\n  const keySeed = [templateId || 'preview', ts !== null ? ts : 'na', resolved]\n  const key = keySeed.filter(Boolean).join('-')\n\n  return { url: resolved, key, ts }\n}\n\nexport function resolveTemplateThumbnailUrl(template, options = {}) {\n  if (!template) return { url: null }\n  const manifest = template.manifest || {}\n  const manifestFiles = manifest.files || {}\n  const artifacts = template.artifacts || {}\n\n  const candidates = [\n    template.thumbnail_url,\n    template.thumbnailUrl,\n    template.png_url,\n    template.pngUrl,\n    artifacts.thumbnail_url,\n    artifacts.thumbnailUrl,\n    artifacts.png_url,\n    artifacts.pngUrl,\n    artifacts.thumbnail,\n    manifestFiles['report_final.png'],\n    manifestFiles['thumbnail.png'],\n    options.fallbackUrl,\n  ]\n\n  const raw = ensureAbsolutePath(template, pickFirst(candidates))\n  if (!raw) return { url: null }\n\n  const ts =\n    options.ts ||\n    template.previewTs ||\n    template.cacheKey ||\n    manifest.produced_at ||\n    template.updated_at ||\n    template.updatedAt ||\n    template.created_at ||\n    template.createdAt\n  const withBaseUrl = withBase(raw)\n  return { url: appendCacheBuster(withBaseUrl, ts) }\n}\n","import { useCallback, useEffect, useMemo, useRef, useState } from 'react'\nimport Box from '@mui/material/Box'\nimport { alpha } from '@mui/material/styles'\nimport { neutral, secondary } from '@/app/theme'\n\nimport { DEFAULT_PAGE_DIMENSIONS } from '../utils/preview'\n\nconst MIN_SCALE = 0.01\n\nconst getDevicePixelRatio = () =>\n  (typeof window !== 'undefined' && window.devicePixelRatio) ? window.devicePixelRatio : 1\n\nconst parseCssLength = (value) => {\n  if (!value || value === 'none' || value === 'auto' || typeof value !== 'string') return null\n  const lower = value.toLowerCase()\n  const numeric = Number.parseFloat(lower)\n  if (!Number.isFinite(numeric) || numeric <= 0) return null\n  if (lower.endsWith('px')) return numeric\n  if (typeof window !== 'undefined') {\n    if (lower.endsWith('vh')) {\n      return window.innerHeight * (numeric / 100)\n    }\n    if (lower.endsWith('vw')) {\n      return window.innerWidth * (numeric / 100)\n    }\n  }\n  return null\n}\n\nconst roundScaleForDpr = (scale) => {\n  if (!Number.isFinite(scale) || scale <= 0) return 1\n  const dpr = getDevicePixelRatio()\n  const factor = Math.max(100, Math.round(dpr * 100))\n  return Math.max(MIN_SCALE, Math.round(scale * factor) / factor)\n}\n\nconst parseAspectRatio = (value) => {\n  if (value == null) return null\n\n  const fromNumbers = (wRaw, hRaw) => {\n    const w = Number(wRaw)\n    const h = Number(hRaw)\n    if (!Number.isFinite(w) || !Number.isFinite(h) || w <= 0 || h <= 0) return null\n    return {\n      css: `${w} / ${h}`,\n      ratio: w / h,\n    }\n  }\n\n  if (Array.isArray(value) && value.length === 2) {\n    return fromNumbers(value[0], value[1])\n  }\n\n  if (typeof value === 'number') {\n    return value > 0 ? fromNumbers(value, 1) : null\n  }\n\n  if (typeof value === 'string') {\n    const trimmed = value.trim()\n    if (!trimmed) return null\n    const slashMatch = trimmed.match(/^(\\d*\\.?\\d+)\\s*\\/\\s*(\\d*\\.?\\d+)$/)\n    if (slashMatch) {\n      return fromNumbers(slashMatch[1], slashMatch[2])\n    }\n    const numeric = Number(trimmed)\n    if (Number.isFinite(numeric) && numeric > 0) {\n      return fromNumbers(numeric, 1)\n    }\n    return {\n      css: trimmed,\n      ratio: null,\n    }\n  }\n\n  return null\n}\n\n/**\n * Keeps HTML previews crisp by measuring the iframe content and scaling it\n * to the available container box. We read the iframe body (when same-origin)\n * after load, and fall back to declared page dimensions otherwise.\n * Scale recalculates on iframe load, container resize, and window resize/zoom.\n * `fit` lets callers force scaling by width/height instead of the default \"contain\".\n */\nexport default function ScaledIframePreview({\n  src,\n  title,\n  pageWidth = DEFAULT_PAGE_DIMENSIONS.width,\n  pageHeight = DEFAULT_PAGE_DIMENSIONS.height,\n  sx,\n  loading = 'lazy',\n  background = 'white',\n  frameAspectRatio = null,\n  fit = 'contain', // layout fit strategy for scaling\n  contentAlign = 'center',\n  pageShadow = false,\n  pageBorderColor = alpha(neutral[900], 0.12),\n  pageRadius = 0,\n  marginGuides = false,\n  clampToParentHeight = false,\n  pageChrome = true,\n}) {\n  const containerRef = useRef(null)\n  const iframeRef = useRef(null)\n  const rafRef = useRef(null)\n  const timeoutRef = useRef(null)\n  const [scale, setScale] = useState(1)\n  const [contentSize, setContentSize] = useState({\n    width: pageWidth,\n    height: pageHeight,\n  })\n  const contentSizeRef = useRef(contentSize)\n  const aspect = useMemo(() => parseAspectRatio(frameAspectRatio), [frameAspectRatio])\n  const marginGuideConfig = useMemo(() => {\n    if (!marginGuides) return null\n    if (typeof marginGuides === 'object') {\n      const inset = Math.max(0, Number(marginGuides.inset ?? marginGuides.offset ?? 36))\n      return {\n        inset,\n        color: marginGuides.color || alpha(secondary.violet[500], 0.28),\n      }\n    }\n    return {\n      inset: 36,\n      color: alpha(secondary.violet[500], 0.28),\n    }\n  }, [marginGuides])\n\n  const schedule = useCallback((cb) => {\n    if (rafRef.current) cancelAnimationFrame(rafRef.current)\n    rafRef.current = requestAnimationFrame(() => {\n      rafRef.current = null\n      cb()\n    })\n  }, [])\n\n  const updateScale = useCallback(\n    (dims) => {\n      const target = dims || contentSizeRef.current\n      const container = containerRef.current\n      if (!container || !target.width || !target.height) return\n\n      const rect = container.getBoundingClientRect()\n      const availableWidth = rect.width || container.clientWidth || target.width\n      let availableHeightRaw = rect.height || container.clientHeight || 0\n      if (!availableHeightRaw && aspect?.ratio) {\n        availableHeightRaw = availableWidth / aspect.ratio\n      }\n      if (!availableHeightRaw) {\n        availableHeightRaw = target.height\n      }\n      if (clampToParentHeight) {\n        let ancestor = container.parentElement\n        while (ancestor) {\n          const ancestorRect = ancestor.getBoundingClientRect?.()\n          const ancestorHeight = ancestorRect?.height || ancestor.clientHeight || 0\n          const computedStyle = typeof window !== 'undefined' ? window.getComputedStyle?.(ancestor) : null\n          if (computedStyle) {\n            const maxHeightPx = parseCssLength(computedStyle.maxHeight)\n            if (maxHeightPx) {\n              availableHeightRaw = Math.min(availableHeightRaw, maxHeightPx)\n            }\n            const heightPx = parseCssLength(computedStyle.height)\n            if (heightPx) {\n              availableHeightRaw = Math.min(availableHeightRaw, heightPx)\n            }\n          }\n          if (ancestorHeight > 0) {\n            availableHeightRaw = Math.min(availableHeightRaw, ancestorHeight)\n            break\n          }\n          ancestor = ancestor.parentElement\n        }\n      }\n      const widthRatio = availableWidth / target.width\n      const heightRatio = availableHeightRaw > 0 ? availableHeightRaw / target.height : widthRatio\n      let rawScale\n      if (fit === 'width') {\n        rawScale = widthRatio\n        if (heightRatio > 0 && heightRatio < rawScale) {\n          rawScale = heightRatio\n        }\n      } else if (fit === 'height') {\n        rawScale = heightRatio\n      } else {\n        rawScale = Math.min(widthRatio, heightRatio)\n      }\n      if (!Number.isFinite(rawScale) || rawScale <= 0) {\n        rawScale = 1\n      }\n      const nextScale = roundScaleForDpr(rawScale)\n\n      setScale((prev) => (Math.abs(prev - nextScale) < 0.002 ? prev : nextScale))\n    },\n    [aspect?.ratio, fit, clampToParentHeight],\n  )\n\n  const applyContentSize = useCallback(\n    (dims) => {\n      const safe = {\n        width: Math.max(1, Math.ceil(dims?.width || pageWidth)),\n        height: Math.max(1, Math.ceil(dims?.height || pageHeight)),\n      }\n      contentSizeRef.current = safe\n      setContentSize(safe)\n      schedule(() => updateScale(safe))\n    },\n    [pageHeight, pageWidth, schedule, updateScale],\n  )\n\n  const measureIframeContent = useCallback(() => {\n    const fallback = { width: pageWidth, height: pageHeight }\n    const iframe = iframeRef.current\n    if (!iframe) return fallback\n\n    try {\n      const doc = iframe.contentDocument || iframe.contentWindow?.document\n      if (!doc) return fallback\n      const body = doc.body\n      const html = doc.documentElement\n      if (body) {\n        body.style.overflow = 'hidden'\n      }\n      if (html) {\n        html.style.overflow = 'hidden'\n      }\n      const measuredWidth = Math.max(\n        body?.scrollWidth || 0,\n        body?.offsetWidth || 0,\n        html?.scrollWidth || 0,\n        html?.offsetWidth || 0,\n        fallback.width,\n      )\n      const measuredHeight = Math.max(\n        body?.scrollHeight || 0,\n        body?.offsetHeight || 0,\n        html?.scrollHeight || 0,\n        html?.offsetHeight || 0,\n        fallback.height,\n      )\n      return {\n        width: Math.ceil(measuredWidth),\n        height: Math.ceil(measuredHeight),\n      }\n    } catch {\n      // Cross-origin frames cannot be inspected; fall back to declared dimensions.\n      return fallback\n    }\n  }, [pageHeight, pageWidth])\n\n  const refreshContentSize = useCallback(() => {\n    const dims = measureIframeContent()\n    applyContentSize(dims)\n    if (timeoutRef.current) clearTimeout(timeoutRef.current)\n    // re-measure shortly after load in case fonts/styles settle asynchronously\n    timeoutRef.current = setTimeout(() => {\n      timeoutRef.current = null\n      const postDims = measureIframeContent()\n      applyContentSize(postDims)\n    }, 150)\n  }, [applyContentSize, measureIframeContent])\n\n  useEffect(() => {\n    const iframe = iframeRef.current\n    if (!iframe) return undefined\n    const handleLoad = () => refreshContentSize()\n    iframe.addEventListener('load', handleLoad)\n    return () => {\n      iframe.removeEventListener('load', handleLoad)\n    }\n  }, [refreshContentSize, src])\n\n  useEffect(() => {\n    applyContentSize({ width: pageWidth, height: pageHeight })\n  }, [applyContentSize, pageHeight, pageWidth, src])\n\n  useEffect(() => {\n    if (typeof ResizeObserver === 'undefined') {\n      return undefined\n    }\n    const container = containerRef.current\n    if (!container) return undefined\n    const observer = new ResizeObserver(() => schedule(() => updateScale()))\n    observer.observe(container)\n    return () => observer.disconnect()\n  }, [schedule, updateScale])\n\n  useEffect(() => {\n    const handleWindowResize = () => schedule(() => updateScale())\n    window.addEventListener('resize', handleWindowResize)\n    return () => window.removeEventListener('resize', handleWindowResize)\n  }, [schedule, updateScale])\n\n  useEffect(\n    () => () => {\n      if (rafRef.current) cancelAnimationFrame(rafRef.current)\n      if (timeoutRef.current) clearTimeout(timeoutRef.current)\n    },\n    [],\n  )\n\n  const scaledHeight = contentSize.height * scale\n  const scaledWidth = contentSize.width * scale\n  const alignTop = contentAlign === 'top'\n  const containerStyles = {\n    position: 'relative',\n    width: '100%',\n    overflow: 'hidden',\n    ...sx,\n  }\n  if (aspect?.css) {\n    containerStyles.aspectRatio = aspect.css\n    containerStyles.height = 'auto'\n  }\n  const positioned = Boolean(aspect?.css)\n  const resolvedPageRadius = pageChrome && Number.isFinite(Number(pageRadius))\n    ? Math.max(Number(pageRadius), 0)\n    : 0\n  const resolvedPageShadow = pageChrome && pageShadow\n    ? (typeof pageShadow === 'string' ? pageShadow : `0 32px 48px ${alpha(neutral[900], 0.18)}`)\n    : 'none'\n  const resolvedBorderColor = pageChrome && typeof pageBorderColor === 'string' && pageBorderColor.trim()\n    ? pageBorderColor\n    : null\n  const resolvedBackground = pageChrome ? background : 'transparent'\n  const marginInset = marginGuideConfig\n    ? Math.max(0, Math.min(marginGuideConfig.inset, Math.min(contentSize.width, contentSize.height) / 2))\n    : 0\n\n  return (\n    <Box ref={containerRef} sx={containerStyles}>\n      <Box\n        sx={{\n          position: positioned ? 'absolute' : 'relative',\n          top: positioned ? (alignTop ? 0 : '50%') : 0,\n          left: positioned ? '50%' : 0,\n          width: contentSize.width,\n          height: contentSize.height,\n          transform: `scale(${scale})`,\n          transformOrigin: 'top left',\n          pointerEvents: 'auto',\n        }}\n        style={\n          positioned\n            ? {\n                marginLeft: `${-scaledWidth / 2}px`,\n                ...(alignTop ? {} : { marginTop: `${-scaledHeight / 2}px` }),\n              }\n            : undefined\n        }\n      >\n        <Box\n          sx={{\n            width: contentSize.width,\n            height: contentSize.height,\n            borderRadius: resolvedPageRadius,\n            overflow: 'hidden',\n            bgcolor: resolvedBackground,\n            boxShadow: resolvedPageShadow,\n            border: resolvedBorderColor ? `1px solid ${resolvedBorderColor}` : 'none',\n            position: 'relative',\n          }}\n        >\n          <iframe\n            ref={iframeRef}\n            src={src}\n            title={title}\n            loading={loading}\n            style={{\n              width: contentSize.width,\n              height: contentSize.height,\n              border: 0,\n              display: 'block',\n              background: pageChrome ? background : undefined,\n            }}\n          />\n          {marginGuideConfig && marginInset > 0 && (\n            <Box\n              aria-hidden\n              sx={{\n                position: 'absolute',\n                inset: marginInset,\n                border: '1px dashed',\n                borderColor: marginGuideConfig.color,\n                borderRadius: Math.max(resolvedPageRadius - 6, 0),\n                pointerEvents: 'none',\n              }}\n              style={{\n                borderStyle: 'dashed',\n              }}\n            />\n          )}\n        </Box>\n      </Box>\n      {!positioned && (\n        <Box sx={{ width: '100%', height: scaledHeight, visibility: 'hidden', pointerEvents: 'none' }} />\n      )}\n    </Box>\n  )\n}\n","import { useState, useRef, useCallback, useEffect } from 'react'\nimport {\n  Box,\n  Stack,\n  Typography,\n  Button,\n  TextField,\n  CircularProgress,\n  Paper,\n  Chip,\n  IconButton,\n  Divider,\n  Alert,\n  Collapse,\n  alpha,\n  Autocomplete,\n  Table,\n  TableBody,\n  TableRow,\n  TableCell,\n  TableHead,\n} from '@mui/material'\nimport SendIcon from '@mui/icons-material/Send'\nimport RefreshIcon from '@mui/icons-material/Refresh'\nimport CheckCircleIcon from '@mui/icons-material/CheckCircle'\nimport LightbulbIcon from '@mui/icons-material/Lightbulb'\nimport PersonOutlineIcon from '@mui/icons-material/PersonOutline'\nimport SmartToyOutlinedIcon from '@mui/icons-material/SmartToyOutlined'\nimport ExpandMoreIcon from '@mui/icons-material/ExpandMore'\nimport ExpandLessIcon from '@mui/icons-material/ExpandLess'\nimport QueueIcon from '@mui/icons-material/Queue'\nimport LinearProgress from '@mui/material/LinearProgress'\n\nimport { useTemplateChatStore, DEFAULT_CREATE_WELCOME } from '@/stores/templateChatStore'\nimport { chatTemplateEdit, applyChatTemplateEdit } from '@/api/client'\n\nconst MODE_CONFIG = {\n  edit: {\n    welcomeMessage: null, // uses default edit welcome\n    placeholder: 'Describe the changes you want...',\n    sendLabel: 'Generate edit suggestions',\n  },\n  create: {\n    welcomeMessage: DEFAULT_CREATE_WELCOME,\n    placeholder: 'Describe the report template you need...',\n    sendLabel: 'Generate template',\n  },\n}\nimport { useInteraction, InteractionType, Reversibility } from '@/components/ux/governance'\nimport { useToast } from '@/components/ToastProvider'\nimport ScaledIframePreview from '@/components/ScaledIframePreview'\nimport { neutral, palette } from '@/app/theme'\n\nconst ROLE_CONFIG = {\n  user: {\n    icon: PersonOutlineIcon,\n    label: 'You',\n    bgcolor: neutral[900],\n    textColor: 'common.white',\n  },\n  assistant: {\n    icon: SmartToyOutlinedIcon,\n    label: 'NeuraReport',\n    bgcolor: 'background.paper',\n    textColor: 'text.primary',\n  },\n}\n\nfunction ChatMessage({ message }) {\n  const { role, content, timestamp } = message\n  const config = ROLE_CONFIG[role] || ROLE_CONFIG.assistant\n  const Icon = config.icon\n  const isUser = role === 'user'\n\n  return (\n    <Box\n      sx={{\n        display: 'flex',\n        flexDirection: isUser ? 'row-reverse' : 'row',\n        gap: 1.5,\n        px: 2,\n        py: 1.5,\n      }}\n    >\n      <Box\n        sx={{\n          width: 32,\n          height: 32,\n          borderRadius: '50%',\n          bgcolor: isUser ? neutral[900] : neutral[500],\n          display: 'flex',\n          alignItems: 'center',\n          justifyContent: 'center',\n          flexShrink: 0,\n        }}\n      >\n        <Icon sx={{ fontSize: 18, color: 'white' }} />\n      </Box>\n\n      <Box\n        sx={{\n          flex: 1,\n          maxWidth: isUser ? 'calc(100% - 100px)' : 'calc(100% - 48px)',\n          minWidth: 0,\n        }}\n      >\n        <Stack\n          direction=\"row\"\n          spacing={1}\n          alignItems=\"center\"\n          sx={{\n            mb: 0.5,\n            justifyContent: isUser ? 'flex-end' : 'flex-start',\n          }}\n        >\n          <Typography variant=\"caption\" fontWeight={600} color=\"text.primary\">\n            {config.label}\n          </Typography>\n          {timestamp && (\n            <Typography variant=\"caption\" color=\"text.disabled\">\n              {new Date(timestamp).toLocaleTimeString([], {\n                hour: '2-digit',\n                minute: '2-digit',\n              })}\n            </Typography>\n          )}\n        </Stack>\n\n        <Box\n          sx={{\n            p: 2,\n            borderRadius: 1,  // Figma spec: 8px\n            bgcolor: isUser\n              ? neutral[900]\n              : 'background.paper',\n            color: isUser ? 'common.white' : 'text.primary',\n            boxShadow: isUser\n              ? `0 2px 8px ${alpha(neutral[900], 0.2)}`\n              : '0 1px 3px rgba(0,0,0,0.08)',\n          }}\n        >\n          <Typography\n            variant=\"body2\"\n            sx={{\n              whiteSpace: 'pre-wrap',\n              wordBreak: 'break-word',\n              lineHeight: 1.6,\n            }}\n          >\n            {content}\n            {message.streaming && (\n              <Box\n                component=\"span\"\n                sx={{\n                  display: 'inline-block',\n                  width: 6,\n                  height: 16,\n                  ml: 0.5,\n                  bgcolor: 'currentColor',\n                  animation: 'blink 1s steps(1) infinite',\n                  '@keyframes blink': {\n                    '50%': { opacity: 0 },\n                  },\n                }}\n              />\n            )}\n          </Typography>\n        </Box>\n      </Box>\n    </Box>\n  )\n}\n\nfunction ProposedChangesPanel({ changes, proposedHtml, onApply, onReject, applying }) {\n  const [showPreview, setShowPreview] = useState(false)\n  const [previewUrl, setPreviewUrl] = useState(null)\n\n  useEffect(() => {\n    if (!proposedHtml) {\n      setPreviewUrl(null)\n      return\n    }\n    const blob = new Blob([proposedHtml], { type: 'text/html' })\n    const url = URL.createObjectURL(blob)\n    setPreviewUrl(url)\n    return () => {\n      URL.revokeObjectURL(url)\n    }\n  }, [proposedHtml])\n\n  if (!changes || changes.length === 0) return null\n\n  return (\n    <Paper\n      elevation={0}\n      sx={{\n        p: 2,\n        mx: 2,\n        mb: 2,\n        borderRadius: 1,  // Figma spec: 8px\n        border: '1px solid',\n        borderColor: (theme) => alpha(theme.palette.divider, 0.3),\n        bgcolor: (theme) => theme.palette.mode === 'dark' ? alpha(theme.palette.text.primary, 0.04) : neutral[50],\n      }}\n    >\n      <Stack spacing={2}>\n        <Stack direction=\"row\" alignItems=\"center\" spacing={1}>\n          <CheckCircleIcon sx={{ color: 'text.secondary' }} fontSize=\"small\" />\n          <Typography variant=\"subtitle2\" fontWeight={600}>\n            Ready to Apply Changes\n          </Typography>\n        </Stack>\n\n        <Box>\n          <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mb: 1 }}>\n            Proposed modifications:\n          </Typography>\n          <Stack spacing={0.5}>\n            {changes.map((change, idx) => (\n              <Stack key={idx} direction=\"row\" spacing={1} alignItems=\"flex-start\">\n                <Typography variant=\"body2\" color=\"text.secondary\">\n                  •\n                </Typography>\n                <Typography variant=\"body2\">\n                  {change}\n                </Typography>\n              </Stack>\n            ))}\n          </Stack>\n        </Box>\n\n        {proposedHtml && (\n          <Box>\n            <Button\n              size=\"small\"\n              variant=\"text\"\n              onClick={() => setShowPreview(!showPreview)}\n              endIcon={showPreview ? <ExpandLessIcon /> : <ExpandMoreIcon />}\n              sx={{ mb: 1 }}\n            >\n              {showPreview ? 'Hide Preview' : 'Show Preview'}\n            </Button>\n            <Collapse in={showPreview}>\n              <Box\n                sx={{\n                  borderRadius: 1,  // Figma spec: 8px\n                  border: '1px solid',\n                  borderColor: 'divider',\n                  bgcolor: 'background.paper',\n                  p: 1,\n                  height: 300,\n                  overflow: 'hidden',\n                }}\n              >\n                {previewUrl && (\n                  <ScaledIframePreview\n                    src={previewUrl}\n                    title=\"Proposed changes preview\"\n                    fit=\"contain\"\n                    pageShadow\n                    frameAspectRatio=\"210 / 297\"\n                  />\n                )}\n              </Box>\n            </Collapse>\n          </Box>\n        )}\n\n        <Stack direction=\"row\" spacing={1.5}>\n          <Button\n            variant=\"contained\"\n            onClick={onApply}\n            disabled={applying}\n            startIcon={applying ? <CircularProgress size={16} /> : <CheckCircleIcon />}\n          >\n            {applying ? 'Applying...' : 'Apply Changes'}\n          </Button>\n          <Button\n            variant=\"outlined\"\n            color=\"inherit\"\n            onClick={onReject}\n            disabled={applying}\n          >\n            Request Different Changes\n          </Button>\n        </Stack>\n      </Stack>\n    </Paper>\n  )\n}\n\nfunction FollowUpQuestions({ questions, onQuestionClick }) {\n  if (!questions || questions.length === 0) return null\n\n  return (\n    <Box sx={{ px: 2, pb: 1.5 }}>\n      <Stack direction=\"row\" alignItems=\"center\" spacing={1} sx={{ mb: 1 }}>\n        <LightbulbIcon fontSize=\"small\" color=\"action\" />\n        <Typography variant=\"caption\" color=\"text.secondary\">\n          Quick responses:\n        </Typography>\n      </Stack>\n      <Stack direction=\"row\" flexWrap=\"wrap\" gap={1}>\n        {questions.map((question, idx) => (\n          <Chip\n            key={idx}\n            label={question}\n            size=\"small\"\n            variant=\"outlined\"\n            onClick={() => onQuestionClick(question)}\n            sx={{\n              cursor: 'pointer',\n              '&:hover': {\n                bgcolor: 'action.hover',\n              },\n            }}\n          />\n        ))}\n      </Stack>\n    </Box>\n  )\n}\n\nconst SPECIAL_VALUES = new Set(['UNRESOLVED', 'INPUT_SAMPLE', 'LATER_SELECTED'])\n\nfunction humanizeToken(token) {\n  return token.replace(/_/g, ' ').replace(/\\b\\w/g, (c) => c.toUpperCase())\n}\n\nfunction humanizeColumn(col) {\n  if (!col || SPECIAL_VALUES.has(col)) return null\n  // \"table.column\" → \"Column (from Table)\"\n  const parts = col.split('.')\n  if (parts.length === 2) {\n    const table = parts[0].replace(/_/g, ' ')\n    const column = parts[1].replace(/_/g, ' ')\n    return `${column} from ${table}`\n  }\n  return col.replace(/_/g, ' ')\n}\n\nconst PROGRESS_STEPS = [\n  'Preparing mapping...',\n  'Building contract...',\n  'Generating report assets...',\n  'Finalizing template...',\n]\n\nfunction MappingReviewPanel({ mappingData, catalog, schemaInfo, onApprove, onSkip, onQueue, approving }) {\n  const [localMapping, setLocalMapping] = useState(() => ({ ...(mappingData || {}) }))\n  const [showDetails, setShowDetails] = useState(false)\n  const [editingToken, setEditingToken] = useState(null)\n  const [progressStep, setProgressStep] = useState(0)\n\n  const catalogOptions = (catalog || []).map((c) => c)\n\n  const handleChange = (token, newValue) => {\n    setLocalMapping((prev) => ({ ...prev, [token]: newValue || '' }))\n  }\n\n  // Cycle through progress steps while approving\n  useEffect(() => {\n    if (!approving) { setProgressStep(0); return }\n    const timer = setInterval(() => {\n      setProgressStep((prev) => (prev + 1) % PROGRESS_STEPS.length)\n    }, 3000)\n    return () => clearInterval(timer)\n  }, [approving])\n\n  const tokens = Object.keys(localMapping)\n  const mapped = tokens.filter((t) => !SPECIAL_VALUES.has(localMapping[t]) && localMapping[t])\n  const unresolved = tokens.filter((t) => SPECIAL_VALUES.has(localMapping[t]) || !localMapping[t])\n\n  const tables = schemaInfo\n    ? [schemaInfo['child table'], schemaInfo['parent table']].filter(Boolean).join(' and ')\n    : null\n\n  // --- Processing state: rolling progress ---\n  if (approving) {\n    return (\n      <Paper\n        elevation={0}\n        sx={{\n          p: 2.5,\n          mx: 2,\n          mb: 2,\n          borderRadius: 1,\n          border: '1px solid',\n          borderColor: (theme) => alpha(theme.palette.primary.main, 0.3),\n          bgcolor: (theme) => theme.palette.mode === 'dark' ? alpha(theme.palette.primary.main, 0.08) : alpha(theme.palette.primary.main, 0.04),\n        }}\n      >\n        <Stack spacing={2} alignItems=\"center\">\n          <Stack direction=\"row\" spacing={1.5} alignItems=\"center\">\n            <CircularProgress size={22} thickness={5} />\n            <Typography variant=\"subtitle2\" fontWeight={600}>\n              Setting up your template...\n            </Typography>\n          </Stack>\n\n          <Box sx={{ width: '100%' }}>\n            <LinearProgress\n              variant=\"indeterminate\"\n              sx={{\n                height: 6,\n                borderRadius: 3,\n                bgcolor: (theme) => alpha(theme.palette.primary.main, 0.12),\n                '& .MuiLinearProgress-bar': { borderRadius: 3 },\n              }}\n            />\n          </Box>\n\n          <Typography variant=\"body2\" color=\"text.secondary\" sx={{ minHeight: 20, transition: 'opacity 0.3s' }}>\n            {PROGRESS_STEPS[progressStep]}\n          </Typography>\n\n          {onQueue && (\n            <Button\n              variant=\"outlined\"\n              size=\"small\"\n              startIcon={<QueueIcon />}\n              onClick={onQueue}\n              sx={{ textTransform: 'none', mt: 0.5 }}\n            >\n              Queue & Continue — I'll finish this in the background\n            </Button>\n          )}\n        </Stack>\n      </Paper>\n    )\n  }\n\n  return (\n    <Paper\n      elevation={0}\n      sx={{\n        p: 2,\n        mx: 2,\n        mb: 2,\n        borderRadius: 1,\n        border: '1px solid',\n        borderColor: (theme) => alpha(theme.palette.divider, 0.3),\n        bgcolor: (theme) => theme.palette.mode === 'dark' ? alpha(theme.palette.text.primary, 0.04) : neutral[50],\n      }}\n    >\n      <Stack spacing={1.5}>\n        {/* Friendly summary */}\n        <Typography variant=\"body2\" sx={{ lineHeight: 1.7 }}>\n          {tables && <>I found your data in the <strong>{tables}</strong> table{tables.includes(' and ') ? 's' : ''}. </>}\n          {mapped.length > 0 && (\n            <>I was able to connect <strong>{mapped.length} of {tokens.length}</strong> template fields to your database. </>\n          )}\n          {unresolved.length > 0 && (\n            <>{mapped.length > 0 ? 'However, ' : ''}<strong>{unresolved.length} field{unresolved.length > 1 ? 's' : ''}</strong> still need{unresolved.length === 1 ? 's' : ''} to be configured.</>\n          )}\n          {unresolved.length === 0 && mapped.length > 0 && (\n            <>All fields are mapped and ready to go!</>\n          )}\n        </Typography>\n\n        {/* Mapped fields — compact list */}\n        {mapped.length > 0 && (\n          <Box>\n            <Typography variant=\"caption\" color=\"text.secondary\" fontWeight={600} sx={{ mb: 0.5, display: 'block' }}>\n              Connected fields:\n            </Typography>\n            <Stack direction=\"row\" flexWrap=\"wrap\" gap={0.5}>\n              {mapped.map((token) => (\n                <Chip\n                  key={token}\n                  label={`${humanizeToken(token)} → ${humanizeColumn(localMapping[token]) || localMapping[token]}`}\n                  size=\"small\"\n                  variant=\"outlined\"\n                  color=\"success\"\n                  sx={{ fontSize: '0.7rem' }}\n                />\n              ))}\n            </Stack>\n          </Box>\n        )}\n\n        {/* Unresolved fields — highlighted */}\n        {unresolved.length > 0 && (\n          <Box>\n            <Typography variant=\"caption\" color=\"text.secondary\" fontWeight={600} sx={{ mb: 0.5, display: 'block' }}>\n              Needs your input:\n            </Typography>\n            <Stack spacing={0.5}>\n              {unresolved.map((token) => (\n                <Stack key={token} direction=\"row\" alignItems=\"center\" spacing={1}>\n                  <Typography variant=\"body2\" sx={{ minWidth: 120 }}>\n                    {humanizeToken(token)}\n                  </Typography>\n                  {editingToken === token ? (\n                    <Autocomplete\n                      freeSolo\n                      size=\"small\"\n                      options={catalogOptions}\n                      value={localMapping[token] || ''}\n                      onChange={(_e, newVal) => {\n                        handleChange(token, newVal)\n                        setEditingToken(null)\n                      }}\n                      onBlur={() => setEditingToken(null)}\n                      renderInput={(params) => (\n                        <TextField {...params} variant=\"outlined\" autoFocus size=\"small\" placeholder=\"Pick a column...\"\n                          sx={{ '& .MuiInputBase-root': { fontSize: '0.8rem', py: 0 } }}\n                        />\n                      )}\n                      sx={{ flex: 1, minWidth: 150 }}\n                    />\n                  ) : (\n                    <Chip\n                      label=\"Select column...\"\n                      size=\"small\"\n                      color=\"warning\"\n                      variant=\"outlined\"\n                      onClick={() => setEditingToken(token)}\n                      sx={{ cursor: 'pointer', fontSize: '0.75rem' }}\n                    />\n                  )}\n                </Stack>\n              ))}\n            </Stack>\n          </Box>\n        )}\n\n        {/* Expandable detail view */}\n        {mapped.length > 0 && (\n          <Button\n            size=\"small\"\n            variant=\"text\"\n            onClick={() => setShowDetails(!showDetails)}\n            endIcon={showDetails ? <ExpandLessIcon /> : <ExpandMoreIcon />}\n            sx={{ alignSelf: 'flex-start', textTransform: 'none', fontSize: '0.75rem' }}\n          >\n            {showDetails ? 'Hide all mappings' : 'View all mappings'}\n          </Button>\n        )}\n\n        <Collapse in={showDetails}>\n          <Box sx={{ maxHeight: 250, overflow: 'auto', border: '1px solid', borderColor: 'divider', borderRadius: 0.5 }}>\n            <Table size=\"small\" stickyHeader>\n              <TableHead>\n                <TableRow>\n                  <TableCell sx={{ fontWeight: 600, bgcolor: 'background.paper', width: '40%', py: 0.5 }}>Field</TableCell>\n                  <TableCell sx={{ fontWeight: 600, bgcolor: 'background.paper', py: 0.5 }}>Source</TableCell>\n                </TableRow>\n              </TableHead>\n              <TableBody>\n                {tokens.map((token) => {\n                  const value = localMapping[token]\n                  const isSpecial = SPECIAL_VALUES.has(value) || !value\n                  return (\n                    <TableRow key={token} sx={{ '&:hover': { bgcolor: 'action.hover' } }}>\n                      <TableCell sx={{ py: 0.5 }}>\n                        <Typography variant=\"body2\" fontSize=\"0.8rem\">{humanizeToken(token)}</Typography>\n                      </TableCell>\n                      <TableCell sx={{ py: 0.5 }}>\n                        {editingToken === token ? (\n                          <Autocomplete\n                            freeSolo\n                            size=\"small\"\n                            options={catalogOptions}\n                            value={value || ''}\n                            onChange={(_e, newVal) => { handleChange(token, newVal); setEditingToken(null) }}\n                            onBlur={() => setEditingToken(null)}\n                            renderInput={(params) => (\n                              <TextField {...params} variant=\"outlined\" autoFocus size=\"small\"\n                                sx={{ '& .MuiInputBase-root': { fontSize: '0.8rem', py: 0 } }}\n                              />\n                            )}\n                            sx={{ minWidth: 150 }}\n                          />\n                        ) : (\n                          <Chip\n                            label={isSpecial ? 'Not set' : (humanizeColumn(value) || value)}\n                            size=\"small\"\n                            color={isSpecial ? 'warning' : 'default'}\n                            variant=\"outlined\"\n                            onClick={() => setEditingToken(token)}\n                            sx={{ cursor: 'pointer', fontSize: '0.7rem' }}\n                          />\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  )\n                })}\n              </TableBody>\n            </Table>\n          </Box>\n        </Collapse>\n\n        <Typography variant=\"body2\" color=\"text.secondary\" fontSize=\"0.8rem\">\n          Looks good? Approve to finalize, or tell me what you'd like to change.\n        </Typography>\n\n        <Stack direction=\"row\" spacing={1.5}>\n          <Button\n            variant=\"contained\"\n            onClick={() => onApprove(localMapping)}\n            disabled={approving}\n            startIcon={<CheckCircleIcon />}\n            sx={{ textTransform: 'none' }}\n          >\n            Looks Good, Approve\n          </Button>\n          <Button\n            variant=\"outlined\"\n            onClick={() => onApprove(mappingData)}\n            disabled={approving}\n            sx={{ textTransform: 'none' }}\n          >\n            You do this\n          </Button>\n        </Stack>\n      </Stack>\n    </Paper>\n  )\n}\n\nexport default function TemplateChatEditor({\n  templateId,\n  templateName,\n  currentHtml,\n  onHtmlUpdate,\n  onApplySuccess,\n  onRequestSave,\n  onMappingApprove,\n  onMappingSkip,\n  onMappingQueue,\n  mappingPreviewData,\n  mappingApproving = false,\n  mode = 'edit',\n  chatApi = null,\n}) {\n  const modeConfig = MODE_CONFIG[mode] || MODE_CONFIG.edit\n  // In edit mode, bind templateId into the API call; in create mode, use the provided chatApi\n  const chatApiFunction = chatApi || ((messages, html) => chatTemplateEdit(templateId, messages, html))\n  const toast = useToast()\n  const messagesEndRef = useRef(null)\n  const inputRef = useRef(null)\n\n  const [inputValue, setInputValue] = useState('')\n  const [isProcessing, setIsProcessing] = useState(false)\n  const [applying, setApplying] = useState(false)\n  const [followUpQuestions, setFollowUpQuestions] = useState(null)\n\n  // Get store methods\n  const getOrCreateSession = useTemplateChatStore((s) => s.getOrCreateSession)\n  const getSession = useTemplateChatStore((s) => s.getSession)\n  const addUserMessage = useTemplateChatStore((s) => s.addUserMessage)\n  const addAssistantMessage = useTemplateChatStore((s) => s.addAssistantMessage)\n  const getMessagesForApi = useTemplateChatStore((s) => s.getMessagesForApi)\n  const setProposedChanges = useTemplateChatStore((s) => s.setProposedChanges)\n  const clearProposedChanges = useTemplateChatStore((s) => s.clearProposedChanges)\n  const clearSession = useTemplateChatStore((s) => s.clearSession)\n  const { execute } = useInteraction()\n\n  // Initialize session\n  useEffect(() => {\n    if (templateId) {\n      getOrCreateSession(templateId, templateName, modeConfig.welcomeMessage)\n    }\n  }, [templateId, templateName, getOrCreateSession, modeConfig.welcomeMessage])\n\n  const session = getSession(templateId)\n  const messages = session?.messages || []\n  const proposedChanges = session?.proposedChanges\n  const proposedHtml = session?.proposedHtml\n  const readyToApply = session?.readyToApply\n\n  // Auto-scroll to bottom when messages change\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })\n  }, [messages.length])\n\n  // Focus input on mount\n  useEffect(() => {\n    inputRef.current?.focus()\n  }, [])\n\n  const handleSendMessage = useCallback(async () => {\n    const text = inputValue.trim()\n    if (!text || isProcessing || !templateId) return\n\n    setInputValue('')\n    setFollowUpQuestions(null)\n    addUserMessage(templateId, text)\n\n    await execute({\n      type: InteractionType.GENERATE,\n      label: modeConfig.sendLabel,\n      reversibility: Reversibility.FULLY_REVERSIBLE,\n      suppressSuccessToast: true,\n      suppressErrorToast: true,\n      intent: {\n        templateId,\n        action: mode === 'create' ? 'template_chat_create' : 'template_chat',\n      },\n      action: async () => {\n        setIsProcessing(true)\n        try {\n          // Get messages for API (already includes the user message added above)\n          const apiMessages = getMessagesForApi(templateId)\n\n          const response = await chatApiFunction(apiMessages, currentHtml)\n\n          // Add assistant response\n          addAssistantMessage(templateId, response.message, {\n            proposedChanges: response.proposed_changes,\n            proposedHtml: response.updated_html,\n            readyToApply: response.ready_to_apply,\n          })\n\n          // Update proposed changes state\n          setProposedChanges(templateId, {\n            proposedChanges: response.proposed_changes,\n            proposedHtml: response.updated_html,\n            readyToApply: response.ready_to_apply,\n          })\n\n          // In create mode, update the live preview as soon as the AI\n          // produces HTML so the left-hand side stays in sync.\n          if (mode === 'create' && response.updated_html) {\n            onHtmlUpdate?.(response.updated_html)\n          }\n\n          // Set follow-up questions if provided\n          if (response.follow_up_questions) {\n            setFollowUpQuestions(response.follow_up_questions)\n          }\n          return response\n        } catch (err) {\n          toast.show(String(err.message || err), 'error')\n          addAssistantMessage(\n            templateId,\n            \"I apologize, but I encountered an error. Please try again or rephrase your request.\"\n          )\n          throw err\n        } finally {\n          setIsProcessing(false)\n        }\n      },\n    })\n  }, [\n    inputValue,\n    isProcessing,\n    templateId,\n    currentHtml,\n    addUserMessage,\n    addAssistantMessage,\n    getMessagesForApi,\n    setProposedChanges,\n    toast,\n    execute,\n    chatApiFunction,\n    mode,\n    modeConfig.sendLabel,\n  ])\n\n  const handleApplyChanges = useCallback(async () => {\n    if (!proposedHtml || !templateId) return\n\n    await execute({\n      type: InteractionType.UPDATE,\n      label: 'Apply template changes',\n      reversibility: Reversibility.SYSTEM_MANAGED,\n      suppressSuccessToast: true,\n      suppressErrorToast: true,\n      intent: {\n        templateId,\n        action: 'apply_template_changes',\n      },\n      action: async () => {\n        setApplying(true)\n        try {\n          let result\n          if (mode === 'create') {\n            // In create mode the template doesn't exist on disk yet —\n            // just update local state without hitting the backend.\n            result = { updated_html: proposedHtml }\n          } else {\n            result = await applyChatTemplateEdit(templateId, proposedHtml)\n          }\n\n          // Clear proposed changes\n          clearProposedChanges(templateId)\n\n          // Notify parent of HTML update\n          onHtmlUpdate?.(proposedHtml)\n          onApplySuccess?.(result)\n\n          // Add confirmation message\n          if (mode === 'create') {\n            addAssistantMessage(\n              templateId,\n              \"Your template is ready! Opening the save dialog so you can name and save it.\"\n            )\n          } else {\n            addAssistantMessage(\n              templateId,\n              \"The changes have been applied successfully. Is there anything else you'd like to modify?\"\n            )\n          }\n\n          toast.show('Template changes applied successfully.', 'success')\n\n          // In create mode, auto-open the save dialog\n          if (mode === 'create' && onRequestSave) {\n            onRequestSave()\n          }\n\n          return result\n        } catch (err) {\n          toast.show(String(err.message || err), 'error')\n          throw err\n        } finally {\n          setApplying(false)\n        }\n      },\n    })\n  }, [\n    proposedHtml,\n    templateId,\n    mode,\n    clearProposedChanges,\n    addAssistantMessage,\n    onHtmlUpdate,\n    onApplySuccess,\n    onRequestSave,\n    toast,\n    execute,\n  ])\n\n  const handleRejectChanges = useCallback(() => {\n    clearProposedChanges(templateId)\n    addAssistantMessage(\n      templateId,\n      \"No problem! What different changes would you like me to make instead?\"\n    )\n  }, [templateId, clearProposedChanges, addAssistantMessage])\n\n  const handleQuestionClick = useCallback((question) => {\n    setInputValue(question)\n    setFollowUpQuestions(null)\n    inputRef.current?.focus()\n  }, [])\n\n  const handleKeyDown = useCallback(\n    (e) => {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault()\n        handleSendMessage()\n      }\n    },\n    [handleSendMessage]\n  )\n\n  const handleClearChat = useCallback(() => {\n    clearSession(templateId, templateName, modeConfig.welcomeMessage)\n    setFollowUpQuestions(null)\n    // In create mode, also clear the parent's HTML so preview resets\n    if (mode === 'create') {\n      onHtmlUpdate?.('')\n    }\n    toast.show('Chat cleared. Starting fresh conversation.', 'info')\n  }, [templateId, templateName, clearSession, toast, modeConfig.welcomeMessage, mode, onHtmlUpdate])\n\n  return (\n    <Box\n      sx={{\n        height: '100%',\n        minHeight: 0,         /* respect grid cell constraint */\n        display: 'flex',\n        flexDirection: 'column',\n        bgcolor: 'background.default',\n        borderRadius: 1,  // Figma spec: 8px\n        border: '1px solid',\n        borderColor: 'divider',\n        overflow: 'hidden',\n      }}\n    >\n      {/* Header */}\n      <Box\n        sx={{\n          p: 2,\n          borderBottom: '1px solid',\n          borderColor: 'divider',\n          bgcolor: 'background.paper',\n        }}\n      >\n        <Stack direction=\"row\" justifyContent=\"space-between\" alignItems=\"center\">\n          <Box>\n            <Typography variant=\"subtitle1\" fontWeight={600}>\n              {mode === 'create' ? 'AI Template Creator' : 'AI Template Editor'}\n            </Typography>\n            <Typography variant=\"caption\" color=\"text.secondary\">\n              {mode === 'create'\n                ? 'Describe the report you need and I\\'ll build it for you'\n                : 'Describe the changes you want and I\\'ll help you implement them'}\n            </Typography>\n          </Box>\n          <IconButton\n            size=\"small\"\n            onClick={handleClearChat}\n            title=\"Clear chat and start over\"\n          >\n            <RefreshIcon fontSize=\"small\" />\n          </IconButton>\n        </Stack>\n      </Box>\n\n      {/* Messages + Proposed Changes + Follow-ups — all in one scrollable area */}\n      <Box\n        sx={{\n          flex: 1,\n          overflow: 'auto',\n          py: 1,\n          minHeight: 0,\n        }}\n      >\n        {messages.map((message) => (\n          <ChatMessage key={message.id} message={message} />\n        ))}\n\n        {/* Proposed Changes Panel */}\n        {readyToApply && proposedChanges && (\n          <ProposedChangesPanel\n            changes={proposedChanges}\n            proposedHtml={proposedHtml}\n            onApply={handleApplyChanges}\n            onReject={handleRejectChanges}\n            applying={applying}\n          />\n        )}\n\n        {/* Mapping Review Panel — shown after template save in create mode */}\n        {mappingPreviewData && onMappingApprove && (\n          <MappingReviewPanel\n            mappingData={mappingPreviewData.mapping}\n            catalog={mappingPreviewData.catalog}\n            schemaInfo={mappingPreviewData.schema_info}\n            onApprove={onMappingApprove}\n            onSkip={onMappingSkip}\n            onQueue={onMappingQueue}\n            approving={mappingApproving}\n          />\n        )}\n\n        {/* Follow-up Questions */}\n        <FollowUpQuestions\n          questions={followUpQuestions}\n          onQuestionClick={handleQuestionClick}\n        />\n\n        <div ref={messagesEndRef} />\n      </Box>\n\n      {/* Input */}\n      <Box\n        sx={{\n          p: 2,\n          borderTop: '1px solid',\n          borderColor: 'divider',\n          bgcolor: 'background.paper',\n        }}\n      >\n        <Box\n          sx={{\n            display: 'flex',\n            gap: 1,\n            p: 1.5,\n            borderRadius: 1,  // Figma spec: 8px\n            bgcolor: (theme) => alpha(theme.palette.action.hover, 0.5),\n            border: 1,\n            borderColor: 'divider',\n            transition: 'all 150ms cubic-bezier(0.22, 1, 0.36, 1)',\n            '&:focus-within': {\n              borderColor: (theme) => theme.palette.mode === 'dark' ? neutral[500] : neutral[700],\n              boxShadow: (theme) =>\n                `0 0 0 2px ${alpha(theme.palette.text.primary, 0.08)}`,\n            },\n          }}\n        >\n          <TextField\n            inputRef={inputRef}\n            fullWidth\n            multiline\n            maxRows={4}\n            placeholder={\n              isProcessing\n                ? 'Processing...'\n                : readyToApply\n                ? 'Apply the changes above or describe different modifications...'\n                : modeConfig.placeholder\n            }\n            value={inputValue}\n            onChange={(e) => setInputValue(e.target.value)}\n            onKeyDown={handleKeyDown}\n            disabled={isProcessing}\n            variant=\"standard\"\n            InputProps={{\n              disableUnderline: true,\n              sx: {\n                fontSize: '1rem',\n                lineHeight: 1.5,\n              },\n            }}\n            sx={{\n              '& .MuiInputBase-root': {\n                py: 0.5,\n              },\n            }}\n          />\n\n          <IconButton\n            onClick={handleSendMessage}\n            disabled={!inputValue.trim() || isProcessing}\n            sx={{\n              bgcolor: (theme) => inputValue.trim() && !isProcessing\n                ? (theme.palette.mode === 'dark' ? neutral[700] : neutral[900])\n                : 'action.disabledBackground',\n              color: inputValue.trim() && !isProcessing\n                ? 'common.white'\n                : 'text.disabled',\n              '&:hover': {\n                bgcolor: (theme) => inputValue.trim() && !isProcessing\n                  ? (theme.palette.mode === 'dark' ? neutral[500] : neutral[700])\n                  : 'action.disabledBackground',\n              },\n            }}\n          >\n            {isProcessing ? (\n              <CircularProgress size={20} color=\"inherit\" />\n            ) : (\n              <SendIcon fontSize=\"small\" />\n            )}\n          </IconButton>\n        </Box>\n\n        <Stack\n          direction=\"row\"\n          spacing={2}\n          justifyContent=\"center\"\n          sx={{ mt: 1 }}\n        >\n          <Typography variant=\"caption\" color=\"text.disabled\">\n            Press Enter to send, Shift+Enter for new line\n          </Typography>\n        </Stack>\n      </Box>\n    </Box>\n  )\n}\n"],"names":["QueueIcon","createSvgIcon","_jsx","SmartToyOutlinedIcon","DEFAULT_PAGE_DIMENSIONS","MIN_SCALE","getDevicePixelRatio","parseCssLength","value","lower","numeric","roundScaleForDpr","scale","dpr","factor","parseAspectRatio","fromNumbers","wRaw","hRaw","w","h","trimmed","slashMatch","ScaledIframePreview","src","title","pageWidth","pageHeight","sx","loading","background","frameAspectRatio","fit","contentAlign","pageShadow","pageBorderColor","alpha","neutral","pageRadius","marginGuides","clampToParentHeight","pageChrome","containerRef","useRef","iframeRef","rafRef","timeoutRef","setScale","useState","contentSize","setContentSize","contentSizeRef","aspect","useMemo","marginGuideConfig","secondary","schedule","useCallback","cb","updateScale","dims","target","container","rect","availableWidth","availableHeightRaw","ancestor","ancestorHeight","computedStyle","maxHeightPx","heightPx","widthRatio","heightRatio","rawScale","nextScale","prev","applyContentSize","safe","measureIframeContent","fallback","iframe","doc","body","html","measuredWidth","measuredHeight","refreshContentSize","postDims","useEffect","handleLoad","observer","handleWindowResize","scaledHeight","scaledWidth","alignTop","containerStyles","positioned","resolvedPageRadius","resolvedPageShadow","resolvedBorderColor","resolvedBackground","marginInset","jsxs","Box","jsx","MODE_CONFIG","DEFAULT_CREATE_WELCOME","ROLE_CONFIG","PersonOutlineIcon","ChatMessage","message","role","content","timestamp","config","Icon","isUser","Stack","Typography","ProposedChangesPanel","changes","proposedHtml","onApply","onReject","applying","showPreview","setShowPreview","previewUrl","setPreviewUrl","blob","url","Paper","theme","CheckCircleIcon","change","idx","Button","ExpandLessIcon","ExpandMoreIcon","Collapse","CircularProgress","FollowUpQuestions","questions","onQuestionClick","LightbulbIcon","question","Chip","SPECIAL_VALUES","humanizeToken","token","c","humanizeColumn","col","parts","table","PROGRESS_STEPS","MappingReviewPanel","mappingData","catalog","schemaInfo","onApprove","onSkip","onQueue","approving","localMapping","setLocalMapping","showDetails","setShowDetails","editingToken","setEditingToken","progressStep","setProgressStep","catalogOptions","handleChange","newValue","timer","tokens","mapped","t","unresolved","tables","LinearProgress","Fragment","Autocomplete","_e","newVal","params","TextField","Table","TableHead","TableRow","TableCell","TableBody","isSpecial","TemplateChatEditor","templateId","templateName","currentHtml","onHtmlUpdate","onApplySuccess","onRequestSave","onMappingApprove","onMappingSkip","onMappingQueue","mappingPreviewData","mappingApproving","mode","chatApi","modeConfig","chatApiFunction","messages","chatTemplateEdit","toast","useToast","messagesEndRef","inputRef","inputValue","setInputValue","isProcessing","setIsProcessing","setApplying","followUpQuestions","setFollowUpQuestions","getOrCreateSession","useTemplateChatStore","s","getSession","addUserMessage","addAssistantMessage","getMessagesForApi","setProposedChanges","clearProposedChanges","clearSession","execute","useInteraction","session","proposedChanges","readyToApply","handleSendMessage","text","InteractionType","Reversibility","apiMessages","response","err","handleApplyChanges","result","applyChatTemplateEdit","handleRejectChanges","handleQuestionClick","handleKeyDown","e","handleClearChat","IconButton","RefreshIcon","SendIcon"],"mappings":"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","x_google_ignoreList":[0,1]}