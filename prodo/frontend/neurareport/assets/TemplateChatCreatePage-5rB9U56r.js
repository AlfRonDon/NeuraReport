import{w as Se,v as Te,a as te,l as T,aC as Q,Z as Ie,r as t,R as E,I as P,aD as je,aE as ke,aF as Z,aG as Ae,j as a,B as h,az as De,aA as Ee,aH as Pe,o as v,aI as Me,q as z,s as Ne,K as M,n as w,P as X,p as ee,e as _e,ag as Re,A as ze,ah as Be,aj as Fe,al as We,aJ as Le,am as $e}from"./index-tNjrNcyx.js";import{A as Ue}from"./ArrowBack-DZSCerTh.js";import{S as Oe}from"./Save-BetSEFm3.js";import{U as He}from"./UploadFile-DMmAnyZ-.js";import{P as Ye}from"./PictureAsPdf-BSOoTkA1.js";import{S as Ge}from"./Surface-BP-OE1Iu.js";import{C as Ke}from"./ConnectionSelector-DPzRBoqg.js";import{T as Ve}from"./TemplateChatEditor-CBGGvyfh.js";import"./Lightbulb-B6WhFsgN.js";import"./Autocomplete-DhsBc69q.js";import"./TableRow-DBskq6ho.js";const ae=10,i="__chat_create__";function qe(){const b=Se(),s=Te(),{execute:B}=te(),F=T(e=>e.addTemplate),W=T(e=>e.setTemplateId),g=T(e=>e.lastUsed?.connectionId||null),ne=T(e=>e.activeConnection),se=T(e=>e.setActiveConnectionId),I=Q(e=>e.deleteSession),[L]=Ie(),y=L.get("from")==="wizard",f=L.get("connectionId")||null,[j,oe]=t.useState(f||g||ne?.id||""),l=Q(e=>e.addAssistantMessage),[m,$]=t.useState(""),[U,O]=t.useState(null),[re,N]=t.useState(!1),[C,ie]=t.useState(""),[k,H]=t.useState(!1),[A,Y]=t.useState(null),D=t.useRef(null),[o,le]=t.useState(null),[u,ce]=t.useState("pdf"),[c,pe]=t.useState(""),[_,de]=t.useState(null),[me,G]=t.useState(!1),R=t.useCallback(e=>{if(e){if(e.type!=="application/pdf"){s.show("Please upload a PDF file.","warning");return}if(e.size>ae*1024*1024){s.show(`File too large. Maximum size is ${ae}MB.`,"warning");return}Y({file:e,name:e.name,size:e.size}),s.show(`Sample PDF "${e.name}" attached. The AI will use this as a visual reference.`,"info")}},[s]),ue=t.useCallback(e=>{e.preventDefault();const n=e.dataTransfer?.files?.[0];R(n)},[R]),he=t.useCallback(e=>{e.preventDefault()},[]),ge=t.useCallback(()=>{Y(null),D.current&&(D.current.value="")},[]);t.useEffect(()=>{if(!m){O(null);return}const e=new Blob([m],{type:"text/html"}),n=URL.createObjectURL(e);return O(n),()=>URL.revokeObjectURL(n)},[m]),t.useEffect(()=>()=>{},[]);const fe=t.useCallback(e=>{$(e)},[]),xe=t.useCallback(e=>{e?.updated_html&&$(e.updated_html)},[]),ve=t.useCallback(async()=>{await b(y?"/setup?step=template":"/templates",{interaction:{type:P.NAVIGATE,label:y?"Back to wizard":"Back to templates",reversibility:E.FULLY_REVERSIBLE}})},[b,y]),K=t.useCallback(()=>{N(!0)},[]),V=t.useCallback(()=>{N(!1)},[]),q=t.useCallback(async()=>{const e=C.trim();if(!e){s.show("Please enter a template name.","warning");return}if(!m){s.show("No template HTML to save. Continue the conversation to generate a template first.","warning");return}await B({type:P.CREATE,label:"Create template from chat",reversibility:E.SYSTEM_MANAGED,suppressSuccessToast:!0,suppressErrorToast:!0,intent:{action:"create_template_from_chat",name:e},action:async()=>{H(!0);try{const n=await je(e,m),r=n?.template_id,p=n?.kind||"pdf";r&&(F({id:r,name:e,kind:p,status:"draft",artifacts:{},tags:[]}),W(r)),N(!1);const x=j||f||g;if(r&&x){le(r),ce(p),pe(e),s.show(`Template "${e}" saved! Fetching data mapping suggestions...`,"info"),l(i,`Template "${e}" has been saved successfully! Now let's configure how your template fields map to your database columns. Fetching mapping suggestions...`);try{const S=await ke(r,x,{kind:p}),J=S?.mapping||S?.auto_mapping||{};Object.keys(J).length>0?(de(S),l(i,`I've auto-mapped ${Object.keys(J).length} template fields to your database columns. Review the mapping below — you can click any value to change it, or type in the chat to discuss changes.`)):(s.show(`Template "${e}" saved. No auto-mapping available — you can configure mapping later.`,"info"),l(i,"Template saved, but I couldn't generate auto-mapping suggestions. You can configure mapping manually from the template editor."),d(r,e,p))}catch(S){console.warn("Mapping preview failed:",S),s.show(`Template "${e}" saved. Mapping preview failed — you can map manually later.`,"warning"),l(i,"Template saved! Auto-mapping encountered an issue, but you can configure it from the template editor."),d(r,e,p)}}else s.show(`Template "${e}" created successfully.`,"success"),l(i,`Template "${e}" has been saved! Connect a database to enable field mapping.`),I(i),d(r,e,p)}catch(n){throw s.show(String(n.message||n),"error"),n}finally{H(!1)}}})},[C,m,B,F,W,I,s,b,y,f,g,l]),d=t.useCallback(async(e,n,r)=>{if(I(i),y){try{const p=sessionStorage.getItem("neurareport_wizard_state"),x=p?JSON.parse(p):{};x.templateId=e,x.templateKind=r,x.templateName=n,sessionStorage.setItem("neurareport_wizard_state",JSON.stringify(x))}catch{}await b("/setup?step=mapping",{interaction:{type:P.NAVIGATE,label:"Continue to mapping",reversibility:E.FULLY_REVERSIBLE}})}else await b(`/templates/${e}/edit`,{state:{from:"/templates",editMode:"chat"},interaction:{type:P.NAVIGATE,label:"Open new template editor",reversibility:E.FULLY_REVERSIBLE}})},[I,y,b]),be=t.useCallback(async e=>{if(o){G(!0);try{const n=j||f||g;l(i,"Building contract and generator assets... This may take a moment."),s.show("Approving mapping and building contract...","info"),await Z(o,e,{connectionId:n,kind:u}),s.show(`Template "${c}" is report-ready!`,"success"),l(i,`Mapping approved and contract built! Template "${c}" is now report-ready. Redirecting...`),setTimeout(()=>{d(o,c,u)},1500)}catch(n){console.error("Mapping approve failed:",n),s.show("Mapping approval failed. You can retry or map later from the editor.","error"),l(i,`Mapping approval encountered an error: ${n.message||n}. You can try again or skip to map later.`)}finally{G(!1)}}},[o,u,c,f,g,s,l,d]),ye=t.useCallback(()=>{o&&(s.show(`Template "${c}" saved. You can configure mapping from the editor.`,"info"),d(o,c,u))},[o,c,u,s,d]),we=t.useCallback(()=>{if(!o)return;const e=j||f||g;Z(o,_?.mapping||{},{connectionId:e,kind:u}).then(()=>{}).catch(n=>{console.warn("Background mapping approval failed:",n)}),s.show(`Mapping approval queued for "${c}". You can check progress from the template editor.`,"info"),d(o,c,u)},[o,c,u,f,g,_,s,d]),Ce=t.useCallback((e,n)=>Ae(e,n,A?.file||null),[A]);return a.jsxs(h,{sx:{display:"flex",flexDirection:"column",flex:"1 1 0",minHeight:0,overflow:"hidden"},children:[a.jsx(h,{sx:{mb:1,flexShrink:0},children:a.jsxs(De,{separator:a.jsx(Me,{fontSize:"small"}),"aria-label":"breadcrumb",children:[a.jsx(Ee,{component:Pe,to:"/templates",underline:"hover",color:"text.secondary",sx:{display:"flex",alignItems:"center",gap:.5},children:"Templates"}),a.jsx(v,{color:"text.primary",fontWeight:600,children:"Create with AI"})]})}),a.jsxs(Ge,{sx:{gap:{xs:1.5,md:2},flex:"1 1 0",minHeight:0,overflow:"hidden"},children:[a.jsxs(z,{direction:"row",justifyContent:"space-between",alignItems:"center",spacing:1.5,sx:{flexShrink:0},children:[a.jsxs(z,{direction:"row",spacing:1,alignItems:"center",sx:{minWidth:0},children:[a.jsx(Ne,{sx:{color:"text.secondary",fontSize:20}}),a.jsx(v,{variant:"h6",fontWeight:600,children:"Create Template with AI"})]}),a.jsxs(z,{direction:"row",spacing:1.5,alignItems:"center",children:[a.jsx(Ke,{value:j,onChange:e=>{oe(e),se(e)},label:"Data Source",size:"small",fullWidth:!1,sx:{minWidth:200}}),a.jsx(M,{variant:"contained",onClick:K,disabled:!m,startIcon:a.jsx(Oe,{}),sx:{textTransform:"none",fontWeight:600,bgcolor:w[900],"&:hover":{bgcolor:w[700]},"&.Mui-disabled":{bgcolor:w[300],color:w[500]}},children:"Save Template"}),a.jsx(M,{variant:"outlined",onClick:ve,startIcon:a.jsx(Ue,{}),sx:{textTransform:"none",fontWeight:600},children:"Back"})]})]}),A?a.jsxs(X,{variant:"outlined",sx:{px:1.5,py:.75,display:"flex",alignItems:"center",gap:1,borderColor:"primary.main",bgcolor:"primary.50",flexShrink:0},children:[a.jsx(Ye,{sx:{color:"error.main",fontSize:20}}),a.jsx(v,{variant:"body2",fontWeight:600,noWrap:!0,sx:{flex:1,minWidth:0},children:A.name}),a.jsx(ee,{label:"Sample PDF",size:"small",color:"primary",variant:"outlined"}),a.jsx(_e,{size:"small",onClick:ge,title:"Remove sample PDF",children:a.jsx(Re,{fontSize:"small"})})]}):a.jsxs(X,{variant:"outlined",onDrop:ue,onDragOver:he,onClick:()=>D.current?.click(),sx:{px:1.5,py:.75,display:"flex",alignItems:"center",gap:1,cursor:"pointer",borderStyle:"dashed",borderColor:"divider","&:hover":{borderColor:"primary.main",bgcolor:"action.hover"},transition:"all 0.15s",flexShrink:0},children:[a.jsx(He,{sx:{color:"text.secondary"}}),a.jsxs(h,{sx:{flex:1},children:[a.jsx(v,{variant:"body2",fontWeight:600,children:"Have a sample PDF?"}),a.jsx(v,{variant:"caption",color:"text.secondary",children:"Drop a PDF here or click to upload. The AI will use it as a visual reference for layout and styling."})]}),a.jsx(ee,{label:"Optional",size:"small",variant:"outlined"}),a.jsx("input",{ref:D,type:"file",accept:"application/pdf",hidden:!0,onChange:e=>R(e.target.files?.[0])})]}),a.jsxs(h,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"7fr 5fr"},gap:2,flex:1,minHeight:0},children:[a.jsxs(h,{sx:{border:"1px solid",borderColor:"divider",borderRadius:1,overflow:"hidden",bgcolor:"background.paper",display:"flex",flexDirection:"column",minHeight:0},children:[a.jsx(h,{sx:{p:1.5,borderBottom:"1px solid",borderColor:"divider",bgcolor:"background.default",flexShrink:0},children:a.jsx(v,{variant:"caption",fontWeight:600,color:"text.secondary",children:"Template Preview"})}),a.jsx(h,{sx:{flex:1,minHeight:0,overflow:"auto"},children:U?a.jsx("iframe",{src:U,title:"Template Preview",style:{width:"100%",height:"100%",border:"none",display:"block",minHeight:600}}):a.jsx(h,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",p:4},children:a.jsx(ze,{severity:"info",variant:"outlined",sx:{maxWidth:400},children:"Start a conversation to generate a template. The preview will appear here as the AI creates your template."})})})]}),a.jsx(Ve,{templateId:i,templateName:"New Template",currentHtml:m,onHtmlUpdate:fe,onApplySuccess:xe,onRequestSave:K,mappingPreviewData:_,mappingApproving:me,onMappingApprove:be,onMappingSkip:ye,onMappingQueue:we,mode:"create",chatApi:Ce})]})]}),a.jsxs(Be,{open:re,onClose:V,maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[a.jsx(Fe,{sx:{fontWeight:600},children:"Name Your Template"}),a.jsxs(We,{children:[a.jsx(v,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Give your template a descriptive name. You can change this later."}),a.jsx(Le,{autoFocus:!0,fullWidth:!0,label:"Template Name",placeholder:"e.g., Monthly Sales Invoice",value:C,onChange:e=>ie(e.target.value),onKeyDown:e=>{e.key==="Enter"&&C.trim()&&q()},disabled:k})]}),a.jsxs($e,{sx:{px:3,pb:2},children:[a.jsx(M,{onClick:V,disabled:k,children:"Cancel"}),a.jsx(M,{variant:"contained",onClick:q,disabled:!C.trim()||k,sx:{bgcolor:w[900],"&:hover":{bgcolor:w[700]}},children:k?"Creating...":"Create Template"})]})]})]})}function ia(){return te(),a.jsx(qe,{})}export{ia as default};
